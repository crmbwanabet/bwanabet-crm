<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>BwanaBet CRM System</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap');
    body { font-family: 'Inter', sans-serif; }
    .tab-btn.active { background: #fbbf24; color: #000; }
    .settings-tab-btn.active { color: #d97706; border-bottom: 2px solid #f59e0b; background: #fffbeb; }
    input[type="checkbox"] { accent-color: #f59e0b; }
    select:focus, input:focus { outline: none; box-shadow: 0 0 0 2px #fcd34d; }
    .notification { animation: slideIn 0.3s ease-out; }
    @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
    .spinner { animation: spin 1s linear infinite; }
    @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
    .mobile-menu { transition: max-height 0.3s ease-out; }
    .table-scroll::-webkit-scrollbar { height: 8px; }
    .table-scroll::-webkit-scrollbar-track { background: #f1f5f9; }
    .table-scroll::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
  </style>
</head>
<body class="bg-slate-100 min-h-screen">
  <!-- Loading Overlay -->
  <div id="loadingOverlay" class="hidden fixed inset-0 bg-black/30 flex items-center justify-center z-[100]">
    <div class="bg-white rounded-xl p-6 flex items-center gap-4 shadow-2xl">
      <svg class="spinner h-8 w-8 text-amber-500" fill="none" viewBox="0 0 24 24">
        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
      </svg>
      <span class="text-lg font-medium text-slate-700">Loading...</span>
    </div>
  </div>

  <!-- Notification -->
  <div id="notification" class="hidden fixed top-4 right-4 left-4 sm:left-auto z-50 px-4 py-3 rounded-lg shadow-xl flex items-center gap-3 notification"></div>

  <!-- Header -->
  <header class="bg-black shadow-md border-b-4 border-amber-400">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 py-3">
      <div class="flex items-center justify-between">
        <div class="flex items-center gap-3 sm:gap-6">
          <div class="text-amber-400 font-extrabold text-xl sm:text-2xl tracking-tight">BWANABET</div>
          <div class="hidden sm:block border-l-2 border-slate-600 pl-4 sm:pl-6">
            <h1 class="text-lg sm:text-xl font-bold text-white">CRM System</h1>
          </div>
        </div>
        
        <div class="flex items-center gap-2 sm:gap-4">
          <div id="connectionStatus" class="flex items-center gap-1.5 sm:gap-2 px-2 sm:px-3 py-1 rounded-full bg-slate-700">
            <div id="statusDot" class="w-2 h-2 rounded-full bg-gray-400"></div>
            <span id="statusText" class="text-xs text-slate-300 hidden sm:inline">Connecting...</span>
          </div>
          
          <button id="mobileMenuBtn" class="lg:hidden p-2 text-slate-300 hover:text-white">
            <i data-lucide="menu" class="h-6 w-6"></i>
          </button>
        </div>
      </div>
      
      <!-- Desktop Navigation -->
      <div class="hidden lg:flex items-center gap-1 bg-slate-800 rounded-lg p-1 mt-3 w-fit">
        <button id="tab-dashboard" class="tab-btn active flex items-center gap-2 px-4 py-2 rounded-md font-medium transition-colors text-slate-300 hover:text-white hover:bg-slate-700">
          <i data-lucide="layout-dashboard" class="h-4 w-4"></i>Dashboard
        </button>
        <button id="tab-churn" class="tab-btn flex items-center gap-2 px-4 py-2 rounded-md font-medium transition-colors text-slate-300 hover:text-white hover:bg-slate-700">
          <i data-lucide="user-x" class="h-4 w-4"></i>Churn
        </button>
        <button id="tab-segmentation" class="tab-btn flex items-center gap-2 px-4 py-2 rounded-md font-medium transition-colors text-slate-300 hover:text-white hover:bg-slate-700">
          <i data-lucide="pie-chart" class="h-4 w-4"></i>Segments
        </button>
        <button id="tab-settings" class="tab-btn flex items-center gap-2 px-4 py-2 rounded-md font-medium transition-colors text-slate-300 hover:text-white hover:bg-slate-700">
          <i data-lucide="settings" class="h-4 w-4"></i>Settings
        </button>
      </div>
      
      <!-- Mobile Navigation -->
      <div id="mobileMenu" class="lg:hidden mobile-menu max-h-0 overflow-hidden">
        <div class="flex flex-col gap-1 bg-slate-800 rounded-lg p-2 mt-3">
          <button id="tab-dashboard-mobile" class="tab-btn active flex items-center gap-2 px-4 py-3 rounded-md font-medium text-slate-300 hover:text-white hover:bg-slate-700 text-left">
            <i data-lucide="layout-dashboard" class="h-5 w-5"></i>Dashboard
          </button>
          <button id="tab-churn-mobile" class="tab-btn flex items-center gap-2 px-4 py-3 rounded-md font-medium text-slate-300 hover:text-white hover:bg-slate-700 text-left">
            <i data-lucide="user-x" class="h-5 w-5"></i>Churn Customers
          </button>
          <button id="tab-segmentation-mobile" class="tab-btn flex items-center gap-2 px-4 py-3 rounded-md font-medium text-slate-300 hover:text-white hover:bg-slate-700 text-left">
            <i data-lucide="pie-chart" class="h-5 w-5"></i>Value Segmentation
          </button>
          <button id="tab-settings-mobile" class="tab-btn flex items-center gap-2 px-4 py-3 rounded-md font-medium text-slate-300 hover:text-white hover:bg-slate-700 text-left">
            <i data-lucide="settings" class="h-5 w-5"></i>Settings
          </button>
        </div>
      </div>
    </div>
  </header>

  <main class="max-w-7xl mx-auto px-4 sm:px-6 py-4 sm:py-8">
    <!-- DASHBOARD TAB -->
    <div id="content-dashboard" class="tab-content">
      <!-- Customer Value Overview -->
      <div class="bg-white rounded-xl shadow-sm p-4 sm:p-6 mb-6 sm:mb-8">
        <div class="flex flex-col sm:flex-row sm:items-center justify-between mb-4 gap-2">
          <h2 class="text-base sm:text-lg font-bold text-slate-800 flex items-center gap-2">
            <i data-lucide="pie-chart" class="h-5 w-5 text-purple-500"></i>Customer Value Overview
          </h2>
          <button id="viewSegmentsBtn" class="text-sm text-purple-600 hover:text-purple-700 font-medium">View Details →</button>
        </div>
        <div class="flex flex-col md:flex-row items-center gap-6 md:gap-8">
          <svg viewBox="0 0 200 200" class="w-32 h-32 sm:w-48 sm:h-48 flex-shrink-0">
            <circle cx="100" cy="100" r="70" fill="none" stroke="#e2e8f0" stroke-width="20"/>
            <text x="100" y="95" text-anchor="middle" class="text-2xl font-bold fill-slate-700" id="totalCustomers">0</text>
            <text x="100" y="115" text-anchor="middle" class="text-xs fill-slate-500">Total</text>
          </svg>
          
          <div class="flex-1 w-full grid grid-cols-2 gap-2 sm:gap-3">
            <div class="flex items-center gap-2 sm:gap-3 p-2 sm:p-3 rounded-lg bg-purple-50 border border-purple-200">
              <i data-lucide="crown" class="h-4 w-4 sm:h-5 sm:w-5 text-purple-500 flex-shrink-0"></i>
              <div class="min-w-0">
                <p class="text-xs sm:text-sm font-medium text-slate-700 truncate">VIP</p>
                <p class="text-lg sm:text-xl font-bold text-purple-600" id="stat-vip">0</p>
              </div>
            </div>
            <div class="flex items-center gap-2 sm:gap-3 p-2 sm:p-3 rounded-lg bg-blue-50 border border-blue-200">
              <i data-lucide="zap" class="h-4 w-4 sm:h-5 sm:w-5 text-blue-500 flex-shrink-0"></i>
              <div class="min-w-0">
                <p class="text-xs sm:text-sm font-medium text-slate-700 truncate">High Value</p>
                <p class="text-lg sm:text-xl font-bold text-blue-600" id="stat-highvalue">0</p>
              </div>
            </div>
            <div class="flex items-center gap-2 sm:gap-3 p-2 sm:p-3 rounded-lg bg-teal-50 border border-teal-200">
              <i data-lucide="activity" class="h-4 w-4 sm:h-5 sm:w-5 text-teal-500 flex-shrink-0"></i>
              <div class="min-w-0">
                <p class="text-xs sm:text-sm font-medium text-slate-700 truncate">Active Low</p>
                <p class="text-lg sm:text-xl font-bold text-teal-600" id="stat-activelow">0</p>
              </div>
            </div>
            <div class="flex items-center gap-2 sm:gap-3 p-2 sm:p-3 rounded-lg bg-slate-50 border border-slate-200">
              <i data-lucide="user-minus" class="h-4 w-4 sm:h-5 sm:w-5 text-slate-400 flex-shrink-0"></i>
              <div class="min-w-0">
                <p class="text-xs sm:text-sm font-medium text-slate-700 truncate">Inactive</p>
                <p class="text-lg sm:text-xl font-bold text-slate-600" id="stat-lowinactive">0</p>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Churn Stats Cards -->
      <div class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-5 gap-2 sm:gap-4 mb-6 sm:mb-8">
        <div class="bg-white rounded-xl shadow-sm p-3 sm:p-5 border-l-4 border-indigo-500 col-span-2 sm:col-span-1">
          <div class="flex items-center justify-between">
            <div>
              <p class="text-xs sm:text-sm font-medium text-slate-500">Total</p>
              <p class="text-2xl sm:text-3xl font-bold text-indigo-600 mt-1" id="stat-total">0</p>
            </div>
            <i data-lucide="users" class="h-8 w-8 sm:h-10 sm:w-10 text-indigo-200"></i>
          </div>
        </div>
        <div class="bg-white rounded-xl shadow-sm p-3 sm:p-5 border-l-4 border-emerald-500 cursor-pointer hover:shadow-md transition-shadow risk-card" data-risk="low">
          <div class="flex items-center justify-between">
            <div>
              <p class="text-xs sm:text-sm font-medium text-slate-500">Low Risk</p>
              <p class="text-2xl sm:text-3xl font-bold text-emerald-600 mt-1" id="stat-low">0</p>
              <p class="text-xs text-slate-400 hidden sm:block">&lt;7 days</p>
            </div>
            <i data-lucide="shield-check" class="h-8 w-8 sm:h-10 sm:w-10 text-emerald-200"></i>
          </div>
        </div>
        <div class="bg-white rounded-xl shadow-sm p-3 sm:p-5 border-l-4 border-amber-500 cursor-pointer hover:shadow-md transition-shadow risk-card" data-risk="medium">
          <div class="flex items-center justify-between">
            <div>
              <p class="text-xs sm:text-sm font-medium text-slate-500">Medium</p>
              <p class="text-2xl sm:text-3xl font-bold text-amber-600 mt-1" id="stat-medium">0</p>
              <p class="text-xs text-slate-400 hidden sm:block">7-14 days</p>
            </div>
            <i data-lucide="shield" class="h-8 w-8 sm:h-10 sm:w-10 text-amber-200"></i>
          </div>
        </div>
        <div class="bg-white rounded-xl shadow-sm p-3 sm:p-5 border-l-4 border-orange-500 cursor-pointer hover:shadow-md transition-shadow risk-card" data-risk="high">
          <div class="flex items-center justify-between">
            <div>
              <p class="text-xs sm:text-sm font-medium text-slate-500">High Risk</p>
              <p class="text-2xl sm:text-3xl font-bold text-orange-600 mt-1" id="stat-high">0</p>
              <p class="text-xs text-slate-400 hidden sm:block">14-30 days</p>
            </div>
            <i data-lucide="shield-alert" class="h-8 w-8 sm:h-10 sm:w-10 text-orange-200"></i>
          </div>
        </div>
        <div class="bg-white rounded-xl shadow-sm p-3 sm:p-5 border-l-4 border-red-500 cursor-pointer hover:shadow-md transition-shadow risk-card" data-risk="critical">
          <div class="flex items-center justify-between">
            <div>
              <p class="text-xs sm:text-sm font-medium text-slate-500">Critical</p>
              <p class="text-2xl sm:text-3xl font-bold text-red-600 mt-1" id="stat-critical">0</p>
              <p class="text-xs text-slate-400 hidden sm:block">30+ days</p>
            </div>
            <i data-lucide="alert-triangle" class="h-8 w-8 sm:h-10 sm:w-10 text-red-200"></i>
          </div>
        </div>
      </div>

      <!-- Customer Table -->
      <div class="bg-white rounded-xl shadow-sm overflow-hidden">
        <div class="px-4 sm:px-6 py-3 sm:py-4 border-b bg-slate-50">
          <div class="flex flex-col gap-3">
            <div class="relative">
              <i data-lucide="search" class="h-5 w-5 text-slate-400 absolute left-3 top-1/2 -translate-y-1/2"></i>
              <input type="text" id="searchInput" placeholder="Search customers..." class="w-full pl-10 pr-4 py-2 border border-slate-200 rounded-lg text-sm"/>
            </div>
            
            <div class="flex flex-wrap gap-2">
              <select id="churnFilter" class="flex-1 min-w-[120px] px-3 py-2 border border-slate-200 rounded-lg text-sm">
                <option value="all">All Risk</option>
                <option value="low">Low Risk</option>
                <option value="medium">Medium</option>
                <option value="high">High Risk</option>
                <option value="critical">Critical</option>
              </select>
              <select id="segmentFilter" class="flex-1 min-w-[120px] px-3 py-2 border border-slate-200 rounded-lg text-sm">
                <option value="all">All Segments</option>
                <option value="VIP">VIP</option>
                <option value="High Value">High Value</option>
                <option value="Active Low">Active Low</option>
                <option value="Low Inactive">Inactive</option>
              </select>
              <button id="clearFiltersBtn" class="px-3 py-2 text-sm text-amber-600 hover:text-amber-700 font-medium whitespace-nowrap">Clear</button>
            </div>
            
            <div class="flex flex-wrap gap-2">
              <button id="refreshBtn" class="flex items-center justify-center gap-2 px-3 py-2 bg-slate-100 text-slate-700 rounded-lg hover:bg-slate-200 text-sm flex-1 sm:flex-none">
                <i data-lucide="refresh-cw" class="h-4 w-4"></i><span class="hidden sm:inline">Refresh</span>
              </button>
              <button id="addCustomerBtn" class="flex items-center justify-center gap-2 px-3 py-2 bg-emerald-500 text-white font-medium rounded-lg hover:bg-emerald-400 text-sm flex-1 sm:flex-none">
                <i data-lucide="plus" class="h-4 w-4"></i><span>Add</span>
              </button>
              <button id="exportBtn" class="flex items-center justify-center gap-2 px-3 py-2 bg-amber-500 text-black font-medium rounded-lg hover:bg-amber-400 text-sm flex-1 sm:flex-none">
                <i data-lucide="download" class="h-4 w-4"></i><span class="hidden sm:inline">Export</span>
              </button>
            </div>
          </div>
        </div>

        <div class="overflow-x-auto table-scroll">
          <table class="w-full min-w-[640px]">
            <thead class="bg-slate-50 border-b">
              <tr>
                <th class="px-3 sm:px-4 py-3 text-left w-10"><input type="checkbox" id="selectAll"/></th>
                <th class="px-3 sm:px-4 py-3 text-left text-xs sm:text-sm font-semibold text-slate-600">Customer</th>
                <th class="px-3 sm:px-4 py-3 text-left text-xs sm:text-sm font-semibold text-slate-600">Segment</th>
                <th class="px-3 sm:px-4 py-3 text-left text-xs sm:text-sm font-semibold text-slate-600">Days</th>
                <th class="px-3 sm:px-4 py-3 text-left text-xs sm:text-sm font-semibold text-slate-600">Risk</th>
                <th class="px-3 sm:px-4 py-3 text-left text-xs sm:text-sm font-semibold text-slate-600">Deposits</th>
                <th class="px-3 sm:px-4 py-3 text-left text-xs sm:text-sm font-semibold text-slate-600 w-24">Actions</th>
              </tr>
            </thead>
            <tbody class="divide-y divide-slate-100" id="tableBody">
              <tr>
                <td colspan="7" class="px-4 py-12 text-center text-slate-500">
                  <i data-lucide="database" class="h-10 w-10 mx-auto mb-4 text-slate-300"></i>
                  <p class="text-sm">Loading customers...</p>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
        <div class="px-4 sm:px-6 py-2 sm:py-3 bg-slate-50 border-t text-xs sm:text-sm text-slate-500" id="tableFooter">Loading...</div>
      </div>
    </div>

    <!-- CHURN TAB -->
    <div id="content-churn" class="tab-content hidden">
      <h2 class="text-xl sm:text-2xl font-bold text-slate-800 mb-4 sm:mb-6">Churn Risk Categories</h2>
      <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 sm:gap-6">
        <div class="churn-card bg-gradient-to-br from-emerald-500 to-emerald-600 rounded-xl p-4 sm:p-6 text-white cursor-pointer hover:shadow-lg transition-all hover:scale-[1.02]" data-risk="low">
          <div class="flex items-center gap-2 sm:gap-3 mb-2">
            <div class="bg-white/20 rounded-full p-1.5 sm:p-2"><i data-lucide="shield-check" class="h-5 w-5 sm:h-6 sm:w-6"></i></div>
            <h3 class="text-lg sm:text-xl font-bold">Low Risk</h3>
          </div>
          <p class="text-white/80 text-xs sm:text-sm mb-1">&lt; 7 days inactive</p>
          <p class="text-3xl sm:text-4xl font-bold mt-3" id="churn-stat-low">0</p>
          <p class="text-white/60 text-xs sm:text-sm">customers</p>
        </div>
        
        <div class="churn-card bg-gradient-to-br from-amber-500 to-amber-600 rounded-xl p-4 sm:p-6 text-white cursor-pointer hover:shadow-lg transition-all hover:scale-[1.02]" data-risk="medium">
          <div class="flex items-center gap-2 sm:gap-3 mb-2">
            <div class="bg-white/20 rounded-full p-1.5 sm:p-2"><i data-lucide="shield" class="h-5 w-5 sm:h-6 sm:w-6"></i></div>
            <h3 class="text-lg sm:text-xl font-bold">Medium Risk</h3>
          </div>
          <p class="text-white/80 text-xs sm:text-sm mb-1">7-14 days inactive</p>
          <p class="text-3xl sm:text-4xl font-bold mt-3" id="churn-stat-medium">0</p>
          <p class="text-white/60 text-xs sm:text-sm">customers</p>
        </div>
        
        <div class="churn-card bg-gradient-to-br from-orange-500 to-orange-600 rounded-xl p-4 sm:p-6 text-white cursor-pointer hover:shadow-lg transition-all hover:scale-[1.02]" data-risk="high">
          <div class="flex items-center gap-2 sm:gap-3 mb-2">
            <div class="bg-white/20 rounded-full p-1.5 sm:p-2"><i data-lucide="shield-alert" class="h-5 w-5 sm:h-6 sm:w-6"></i></div>
            <h3 class="text-lg sm:text-xl font-bold">High Risk</h3>
          </div>
          <p class="text-white/80 text-xs sm:text-sm mb-1">14-30 days inactive</p>
          <p class="text-3xl sm:text-4xl font-bold mt-3" id="churn-stat-high">0</p>
          <p class="text-white/60 text-xs sm:text-sm">customers</p>
        </div>
        
        <div class="churn-card bg-gradient-to-br from-red-500 to-red-600 rounded-xl p-4 sm:p-6 text-white cursor-pointer hover:shadow-lg transition-all hover:scale-[1.02]" data-risk="critical">
          <div class="flex items-center gap-2 sm:gap-3 mb-2">
            <div class="bg-white/20 rounded-full p-1.5 sm:p-2"><i data-lucide="user-x" class="h-5 w-5 sm:h-6 sm:w-6"></i></div>
            <h3 class="text-lg sm:text-xl font-bold">Critical</h3>
          </div>
          <p class="text-white/80 text-xs sm:text-sm mb-1">30+ days inactive</p>
          <p class="text-3xl sm:text-4xl font-bold mt-3" id="churn-stat-critical">0</p>
          <p class="text-white/60 text-xs sm:text-sm">customers</p>
        </div>
      </div>
    </div>

    <!-- SEGMENTATION TAB -->
    <div id="content-segmentation" class="tab-content hidden">
      <div class="mb-4 sm:mb-8">
        <h2 class="text-xl sm:text-2xl font-bold text-slate-800">Customer Value Segmentation</h2>
        <p class="text-slate-500 mt-1 text-sm">Click on a segment to filter customers</p>
      </div>

      <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 sm:gap-6">
        <div class="segment-card bg-gradient-to-br from-purple-500 to-purple-600 rounded-xl p-4 sm:p-6 text-white cursor-pointer hover:shadow-lg transition-all hover:scale-[1.02]" data-segment="VIP">
          <div class="flex items-center gap-2 sm:gap-3 mb-2">
            <div class="bg-white/20 rounded-full p-1.5 sm:p-2"><i data-lucide="crown" class="h-5 w-5 sm:h-6 sm:w-6"></i></div>
            <h3 class="text-lg sm:text-xl font-bold">VIP</h3>
          </div>
          <p class="text-white/80 text-xs sm:text-sm mb-3">High deposit, High bet, High frequency</p>
          <p class="text-3xl sm:text-4xl font-bold" id="seg-stat-vip">0</p>
          <p class="text-white/60 text-xs sm:text-sm">customers</p>
        </div>
        
        <div class="segment-card bg-gradient-to-br from-blue-500 to-blue-600 rounded-xl p-4 sm:p-6 text-white cursor-pointer hover:shadow-lg transition-all hover:scale-[1.02]" data-segment="High Value">
          <div class="flex items-center gap-2 sm:gap-3 mb-2">
            <div class="bg-white/20 rounded-full p-1.5 sm:p-2"><i data-lucide="zap" class="h-5 w-5 sm:h-6 sm:w-6"></i></div>
            <h3 class="text-lg sm:text-xl font-bold">High Value – Infrequent</h3>
          </div>
          <p class="text-white/80 text-xs sm:text-sm mb-3">High deposit, High bet, Low frequency</p>
          <p class="text-3xl sm:text-4xl font-bold" id="seg-stat-highvalue">0</p>
          <p class="text-white/60 text-xs sm:text-sm">customers</p>
        </div>
        
        <div class="segment-card bg-gradient-to-br from-teal-500 to-teal-600 rounded-xl p-4 sm:p-6 text-white cursor-pointer hover:shadow-lg transition-all hover:scale-[1.02]" data-segment="Active Low">
          <div class="flex items-center gap-2 sm:gap-3 mb-2">
            <div class="bg-white/20 rounded-full p-1.5 sm:p-2"><i data-lucide="activity" class="h-5 w-5 sm:h-6 sm:w-6"></i></div>
            <h3 class="text-lg sm:text-xl font-bold">Active Low Value</h3>
          </div>
          <p class="text-white/80 text-xs sm:text-sm mb-3">Low deposit, Low bet, High frequency</p>
          <p class="text-3xl sm:text-4xl font-bold" id="seg-stat-activelow">0</p>
          <p class="text-white/60 text-xs sm:text-sm">customers</p>
        </div>
        
        <div class="segment-card bg-gradient-to-br from-slate-500 to-slate-600 rounded-xl p-4 sm:p-6 text-white cursor-pointer hover:shadow-lg transition-all hover:scale-[1.02]" data-segment="Low Inactive">
          <div class="flex items-center gap-2 sm:gap-3 mb-2">
            <div class="bg-white/20 rounded-full p-1.5 sm:p-2"><i data-lucide="user-minus" class="h-5 w-5 sm:h-6 sm:w-6"></i></div>
            <h3 class="text-lg sm:text-xl font-bold">Low Value – Inactive</h3>
          </div>
          <p class="text-white/80 text-xs sm:text-sm mb-3">Low deposit, Low bet, Low frequency</p>
          <p class="text-3xl sm:text-4xl font-bold" id="seg-stat-lowinactive">0</p>
          <p class="text-white/60 text-xs sm:text-sm">customers</p>
        </div>
      </div>

      <div class="mt-6 bg-slate-100 rounded-lg p-3 sm:p-4">
        <p class="text-xs sm:text-sm text-slate-600"><span class="font-semibold">Thresholds:</span> High Deposit ≥ $1,000 • High Bet ≥ $500 • High Frequency ≥ 10 games</p>
      </div>
    </div>

    <!-- SETTINGS TAB -->
    <div id="content-settings" class="tab-content hidden">
      <div class="max-w-4xl mx-auto">
        <h2 class="text-xl sm:text-2xl font-bold text-slate-800 mb-4 sm:mb-6">Settings</h2>
        
        <!-- Database Status -->
        <div class="bg-white rounded-xl shadow-sm overflow-hidden mb-4 sm:mb-6">
          <div class="px-4 sm:px-6 py-3 sm:py-4 border-b bg-slate-50">
            <h3 class="font-bold text-slate-800 flex items-center gap-2 text-sm sm:text-base">
              <i data-lucide="database" class="h-4 w-4 sm:h-5 sm:w-5 text-emerald-500"></i>
              Database Connection
            </h3>
          </div>
          <div class="p-4 sm:p-6">
            <div class="bg-emerald-50 border-l-4 border-emerald-500 p-3 sm:p-4 rounded flex items-center gap-3">
              <i data-lucide="check-circle" class="h-6 w-6 text-emerald-500"></i>
              <div>
                <p class="font-bold text-emerald-800 text-sm sm:text-base">Connected to Supabase</p>
                <p class="text-emerald-700 text-xs sm:text-sm mt-1">Database is configured and ready.</p>
              </div>
            </div>
          </div>
        </div>

        <!-- Import/Export -->
        <div class="bg-white rounded-xl shadow-sm overflow-hidden">
          <div class="border-b flex overflow-x-auto">
            <button id="settings-tab-csv" class="settings-tab-btn active flex items-center gap-2 px-4 sm:px-6 py-3 sm:py-4 font-medium text-slate-500 hover:bg-slate-50 text-sm whitespace-nowrap">
              <i data-lucide="upload" class="h-4 w-4"></i>Import CSV
            </button>
            <button id="settings-tab-export" class="settings-tab-btn flex items-center gap-2 px-4 sm:px-6 py-3 sm:py-4 font-medium text-slate-500 hover:bg-slate-50 text-sm whitespace-nowrap">
              <i data-lucide="download" class="h-4 w-4"></i>Export
            </button>
          </div>

          <div class="p-4 sm:p-6">
            <div id="settings-content-csv" class="settings-content space-y-4">
              <div class="bg-amber-50 border-l-4 border-amber-500 p-3 sm:p-4 rounded">
                <p class="font-bold text-amber-800 text-sm sm:text-base">Import Customer Data from CSV</p>
                <p class="text-amber-700 text-xs sm:text-sm mt-1">Upload a CSV file to import customers to database.</p>
              </div>
              <label class="block border-2 border-dashed border-slate-300 rounded-xl p-8 sm:p-12 text-center cursor-pointer hover:border-amber-400 hover:bg-amber-50">
                <i data-lucide="upload" class="h-10 w-10 sm:h-12 sm:w-12 text-slate-400 mx-auto mb-3"></i>
                <p class="font-semibold text-slate-700 text-sm sm:text-base">Click to upload CSV file</p>
                <p class="text-xs sm:text-sm text-slate-500 mt-2">or drag and drop</p>
                <input type="file" accept=".csv" id="csvFileInput" class="hidden"/>
              </label>
            </div>

            <div id="settings-content-export" class="settings-content hidden space-y-4">
              <div class="bg-emerald-50 border-l-4 border-emerald-500 p-3 sm:p-4 rounded">
                <p class="font-bold text-emerald-800 text-sm sm:text-base">Export Customer Data</p>
                <p class="text-emerald-700 text-xs sm:text-sm mt-1">Download as CSV.</p>
              </div>
              <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
                <button id="exportAllBtn" class="p-4 sm:p-6 border-2 border-slate-200 rounded-lg text-left hover:border-indigo-400 hover:bg-indigo-50">
                  <i data-lucide="download" class="h-6 w-6 sm:h-8 sm:w-8 text-indigo-500 mb-2"></i>
                  <p class="font-bold text-slate-800 text-sm sm:text-base">All Customers</p>
                  <p class="text-xs sm:text-sm text-slate-500" id="export-all-count">0 customers</p>
                </button>
                <button id="exportCriticalBtn" class="p-4 sm:p-6 border-2 border-slate-200 rounded-lg text-left hover:border-red-400 hover:bg-red-50">
                  <i data-lucide="download" class="h-6 w-6 sm:h-8 sm:w-8 text-red-500 mb-2"></i>
                  <p class="font-bold text-slate-800 text-sm sm:text-base">Critical Risk</p>
                  <p class="text-xs sm:text-sm text-slate-500" id="export-critical-count">0 customers</p>
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </main>

  <!-- Add/Edit Customer Modal -->
  <div id="editModal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center p-2 sm:p-4 z-50">
    <div class="bg-white rounded-xl shadow-2xl w-full max-w-2xl max-h-[95vh] overflow-y-auto">
      <div class="px-4 sm:px-6 py-3 sm:py-4 border-b flex items-center justify-between sticky top-0 bg-white z-10">
        <h3 class="text-lg sm:text-xl font-bold" id="modalTitle">Add Customer</h3>
        <button id="closeModalBtn" class="flex items-center gap-1 px-2 sm:px-3 py-1.5 text-slate-600 hover:bg-slate-100 rounded-lg text-sm">
          <i data-lucide="x" class="h-4 w-4"></i><span class="hidden sm:inline">Close</span>
        </button>
      </div>
      <div class="p-4 sm:p-6 grid grid-cols-1 sm:grid-cols-2 gap-3 sm:gap-4">
        <div class="sm:col-span-2">
          <label class="block text-xs sm:text-sm font-medium text-slate-700 mb-1">Full Name *</label>
          <input type="text" id="edit-name" class="w-full px-3 sm:px-4 py-2 border border-slate-200 rounded-lg text-sm"/>
        </div>
        <div>
          <label class="block text-xs sm:text-sm font-medium text-slate-700 mb-1">Phone Number</label>
          <input type="text" id="edit-phone" class="w-full px-3 sm:px-4 py-2 border border-slate-200 rounded-lg text-sm"/>
        </div>
        <div>
          <label class="block text-xs sm:text-sm font-medium text-slate-700 mb-1">Registration Date</label>
          <input type="date" id="edit-reg-date" class="w-full px-3 sm:px-4 py-2 border border-slate-200 rounded-lg text-sm"/>
        </div>
        <div>
          <label class="block text-xs sm:text-sm font-medium text-slate-700 mb-1">Last Deposit Date</label>
          <input type="date" id="edit-deposit-date" class="w-full px-3 sm:px-4 py-2 border border-slate-200 rounded-lg text-sm"/>
        </div>
        <div>
          <label class="block text-xs sm:text-sm font-medium text-slate-700 mb-1">Total Deposits ($)</label>
          <input type="number" id="edit-deposits" step="0.01" class="w-full px-3 sm:px-4 py-2 border border-slate-200 rounded-lg text-sm"/>
        </div>
        <div>
          <label class="block text-xs sm:text-sm font-medium text-slate-700 mb-1">Total Bet Amount ($)</label>
          <input type="number" id="edit-bets" step="0.01" class="w-full px-3 sm:px-4 py-2 border border-slate-200 rounded-lg text-sm"/>
        </div>
        <div>
          <label class="block text-xs sm:text-sm font-medium text-slate-700 mb-1">Games Played</label>
          <input type="number" id="edit-games" class="w-full px-3 sm:px-4 py-2 border border-slate-200 rounded-lg text-sm"/>
        </div>
        <div>
          <label class="block text-xs sm:text-sm font-medium text-slate-700 mb-1">Last Bet Date</label>
          <input type="date" id="edit-bet-date" class="w-full px-3 sm:px-4 py-2 border border-slate-200 rounded-lg text-sm"/>
        </div>
      </div>
      <div class="px-4 sm:px-6 py-3 sm:py-4 bg-slate-50 flex flex-col sm:flex-row justify-end gap-2 sm:gap-3 sticky bottom-0">
        <button id="cancelModalBtn" class="w-full sm:w-auto px-4 py-2 text-slate-600 hover:bg-slate-200 rounded-lg text-sm">Cancel</button>
        <button id="saveCustomerBtn" class="w-full sm:w-auto flex items-center justify-center gap-2 px-6 py-2 bg-amber-500 text-black font-bold rounded-lg hover:bg-amber-400 text-sm">
          <i data-lucide="save" class="h-4 w-4"></i>Save
        </button>
      </div>
    </div>
  </div>

  <script>
    // ============================================
    // HARDCODED SUPABASE CREDENTIALS
    // ============================================
    var SUPABASE_URL = 'https://blrrcnrhixckfudiojwe.supabase.co';
    var SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJscnJjbnJoaXhja2Z1ZGlvandlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc3Nzg0MzMsImV4cCI6MjA4MzM1NDQzM30.2DGACAZz-f_r0ieYz3hvtsOG1y-3fqTD_ENH2ZR2g1k';

    // ============================================
    // APP STATE
    // ============================================
    var App = {
      db: null,
      customers: [],
      currentEditId: null,
      mobileMenuOpen: false,
      VALUE_THRESHOLDS: {
        highDeposit: 1000,
        highBet: 500,
        highFrequency: 10
      }
    };

    // ============================================
    // INITIALIZATION
    // ============================================
   document.addEventListener('DOMContentLoaded', function() {
  lucide.createIcons();
  App.db = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
  checkAuth();
});

async function checkAuth() {
  var result = await App.db.auth.getSession();
  if (!result.data.session) {
    window.location.href = 'login.html';
    return;
  }
  setupEventListeners();
  updateConnectionStatus('connecting', 'Connecting...');
  loadCustomers();
}

function initSupabase() {
  // Not used anymore
      } catch (error) {
        updateConnectionStatus('error', 'Failed');
        showNotification('Database connection failed: ' + error.message, 'error');
      }
    }

    function setupEventListeners() {
      // Mobile menu
      document.getElementById('mobileMenuBtn').addEventListener('click', toggleMobileMenu);
      
      // Tab navigation
      document.getElementById('tab-dashboard').addEventListener('click', function() { switchTab('dashboard'); });
      document.getElementById('tab-churn').addEventListener('click', function() { switchTab('churn'); });
      document.getElementById('tab-segmentation').addEventListener('click', function() { switchTab('segmentation'); });
      document.getElementById('tab-settings').addEventListener('click', function() { switchTab('settings'); });
      
      // Mobile tabs
      document.getElementById('tab-dashboard-mobile').addEventListener('click', function() { switchTab('dashboard'); toggleMobileMenu(); });
      document.getElementById('tab-churn-mobile').addEventListener('click', function() { switchTab('churn'); toggleMobileMenu(); });
      document.getElementById('tab-segmentation-mobile').addEventListener('click', function() { switchTab('segmentation'); toggleMobileMenu(); });
      document.getElementById('tab-settings-mobile').addEventListener('click', function() { switchTab('settings'); toggleMobileMenu(); });
      
      // Dashboard buttons
      document.getElementById('viewSegmentsBtn').addEventListener('click', function() { switchTab('segmentation'); });
      document.getElementById('refreshBtn').addEventListener('click', loadCustomers);
      document.getElementById('addCustomerBtn').addEventListener('click', openAddModal);
      document.getElementById('exportBtn').addEventListener('click', function() { exportData('all'); });
      document.getElementById('clearFiltersBtn').addEventListener('click', clearFilters);
      
      // Filters
      document.getElementById('searchInput').addEventListener('input', filterTable);
      document.getElementById('churnFilter').addEventListener('change', filterTable);
      document.getElementById('segmentFilter').addEventListener('change', filterTable);
      document.getElementById('selectAll').addEventListener('change', toggleSelectAll);
      
      // Risk cards
      var riskCards = document.querySelectorAll('.risk-card');
      for (var i = 0; i < riskCards.length; i++) {
        (function(card) {
          card.addEventListener('click', function() { filterByRisk(card.dataset.risk); });
        })(riskCards[i]);
      }
      
      // Churn cards
      var churnCards = document.querySelectorAll('.churn-card');
      for (var i = 0; i < churnCards.length; i++) {
        (function(card) {
          card.addEventListener('click', function() {
            filterByRisk(card.dataset.risk);
            switchTab('dashboard');
          });
        })(churnCards[i]);
      }
      
      // Segment cards
      var segmentCards = document.querySelectorAll('.segment-card');
      for (var i = 0; i < segmentCards.length; i++) {
        (function(card) {
          card.addEventListener('click', function() { filterBySegment(card.dataset.segment); });
        })(segmentCards[i]);
      }
      
      // Settings tabs
      document.getElementById('settings-tab-csv').addEventListener('click', function() { switchSettingsTab('csv'); });
      document.getElementById('settings-tab-export').addEventListener('click', function() { switchSettingsTab('export'); });
      document.getElementById('csvFileInput').addEventListener('change', handleFileUpload);
      document.getElementById('exportAllBtn').addEventListener('click', function() { exportData('all'); });
      document.getElementById('exportCriticalBtn').addEventListener('click', function() { exportData('critical'); });
      
      // Modal
      document.getElementById('closeModalBtn').addEventListener('click', closeEditModal);
      document.getElementById('cancelModalBtn').addEventListener('click', closeEditModal);
      document.getElementById('saveCustomerBtn').addEventListener('click', saveCustomer);
      document.getElementById('editModal').addEventListener('click', function(e) {
        if (e.target.id === 'editModal') closeEditModal();
      });
      
      // Escape key
      document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') closeEditModal();
      });
    }

    function updateConnectionStatus(status, text) {
      var dot = document.getElementById('statusDot');
      var label = document.getElementById('statusText');
      dot.className = 'w-2 h-2 rounded-full';
      if (status === 'connected') dot.classList.add('bg-emerald-400');
      else if (status === 'connecting') dot.classList.add('bg-amber-400');
      else if (status === 'error') dot.classList.add('bg-red-400');
      else dot.classList.add('bg-gray-400');
      label.textContent = text;
    }

    // ============================================
    // DATABASE OPERATIONS
    // ============================================
    async function loadCustomers() {
      if (!App.db) {
        showNotification('Database not connected', 'error');
        return;
      }
      
      showLoading(true);
      
      try {
        var result = await App.db.from('customers').select('*').order('created_at', { ascending: false });
        if (result.error) throw result.error;
        
        App.customers = [];
        for (var i = 0; i < result.data.length; i++) {
          App.customers.push(processCustomer(result.data[i]));
        }
        updateConnectionStatus('connected', 'Connected');
        renderTable(App.customers);
        updateStats();
        showNotification('Loaded ' + App.customers.length + ' customers', 'success');
      } catch (error) {
        updateConnectionStatus('error', 'Error');
        showNotification('Load failed: ' + error.message, 'error');
        renderEmptyTable();
      } finally {
        showLoading(false);
      }
    }

    function processCustomer(c) {
      var days = daysSince(c.last_deposit_date);
      return {
        id: c.id,
        full_name: c.full_name,
        phone_number: c.phone_number,
        registration_date: c.registration_date,
        last_deposit_date: c.last_deposit_date,
        total_deposit_amount: c.total_deposit_amount,
        total_bet_amount: c.total_bet_amount,
        games_played: c.games_played,
        last_bet_date: c.last_bet_date,
        days_since_deposit: days,
        segment: getValueSegment(c),
        risk: getChurnCategory(days)
      };
    }

    function daysSince(dateString) {
      if (!dateString) return null;
      var date = new Date(dateString);
      if (isNaN(date.getTime())) return null;
      return Math.max(0, Math.floor((new Date() - date) / (1000 * 60 * 60 * 24)));
    }

    function getValueSegment(customer) {
      var dep = parseFloat(customer.total_deposit_amount) || 0;
      var bet = parseFloat(customer.total_bet_amount) || 0;
      var games = parseInt(customer.games_played) || 0;
      
      var highDep = dep >= App.VALUE_THRESHOLDS.highDeposit;
      var highBet = bet >= App.VALUE_THRESHOLDS.highBet;
      var highFreq = games >= App.VALUE_THRESHOLDS.highFrequency;
      
      if (highDep && highBet && highFreq) return { label: 'VIP', color: 'purple' };
      if (highDep && highBet) return { label: 'High Value', color: 'blue' };
      if (highFreq) return { label: 'Active Low', color: 'teal' };
      return { label: 'Low Inactive', color: 'slate' };
    }

    function getChurnCategory(days) {
      if (days === null) return { label: 'Unknown', color: 'gray' };
      if (days < 7) return { label: 'Low Risk', color: 'emerald' };
      if (days < 14) return { label: 'Medium Risk', color: 'amber' };
      if (days < 30) return { label: 'High Risk', color: 'orange' };
      return { label: 'Critical', color: 'red' };
    }

    async function addCustomerToDB(data) {
      if (!App.db) return;
      showLoading(true);
      try {
        var result = await App.db.from('customers').insert([data]);
        if (result.error) throw result.error;
        showNotification('Customer added!', 'success');
        await loadCustomers();
      } catch (error) {
        showNotification('Add failed: ' + error.message, 'error');
      } finally {
        showLoading(false);
      }
    }

    async function updateCustomerInDB(id, data) {
      if (!App.db) return;
      showLoading(true);
      try {
        data.updated_at = new Date().toISOString();
        var result = await App.db.from('customers').update(data).eq('id', id);
        if (result.error) throw result.error;
        showNotification('Customer updated!', 'success');
        await loadCustomers();
      } catch (error) {
        showNotification('Update failed: ' + error.message, 'error');
      } finally {
        showLoading(false);
      }
    }

    async function deleteCustomerFromDB(id) {
      if (!confirm('Delete this customer?')) return;
      if (!App.db) return;
      showLoading(true);
      try {
        var result = await App.db.from('customers').delete().eq('id', id);
        if (result.error) throw result.error;
        showNotification('Deleted', 'success');
        await loadCustomers();
      } catch (error) {
        showNotification('Delete failed: ' + error.message, 'error');
      } finally {
        showLoading(false);
      }
    }

    // Make functions global for onclick handlers
    window.deleteCustomer = deleteCustomerFromDB;
    window.editCustomer = function(id) {
      var c = null;
      for (var i = 0; i < App.customers.length; i++) {
        if (App.customers[i].id === id) {
          c = App.customers[i];
          break;
        }
      }
      if (!c) return;
      
      App.currentEditId = id;
      document.getElementById('modalTitle').textContent = 'Edit Customer';
      document.getElementById('edit-name').value = c.full_name || '';
      document.getElementById('edit-phone').value = c.phone_number || '';
      document.getElementById('edit-reg-date').value = c.registration_date || '';
      document.getElementById('edit-deposit-date').value = c.last_deposit_date || '';
      document.getElementById('edit-deposits').value = c.total_deposit_amount || '';
      document.getElementById('edit-bets').value = c.total_bet_amount || '';
      document.getElementById('edit-games').value = c.games_played || '';
      document.getElementById('edit-bet-date').value = c.last_bet_date || '';
      
      document.getElementById('editModal').classList.remove('hidden');
      document.body.style.overflow = 'hidden';
      lucide.createIcons();
    };

    // ============================================
    // UI RENDERING
    // ============================================
    function renderTable(data) {
      var tbody = document.getElementById('tableBody');
      
      if (data.length === 0) {
        renderEmptyTable();
        return;
      }
      
      var html = '';
      for (var i = 0; i < data.length; i++) {
        var c = data[i];
        html += '<tr class="hover:bg-slate-50">' +
          '<td class="px-3 sm:px-4 py-3"><input type="checkbox" class="customer-checkbox" data-id="' + c.id + '"/></td>' +
          '<td class="px-3 sm:px-4 py-3">' +
            '<p class="font-medium text-slate-900 text-sm truncate max-w-[150px]">' + (c.full_name || 'Unknown') + '</p>' +
            '<p class="text-xs text-slate-500 truncate max-w-[150px]">' + (c.phone_number || '-') + '</p>' +
          '</td>' +
          '<td class="px-3 sm:px-4 py-3">' +
            '<span class="inline-flex px-2 py-1 rounded-full text-xs font-medium bg-' + c.segment.color + '-100 text-' + c.segment.color + '-800">' + c.segment.label + '</span>' +
          '</td>' +
          '<td class="px-3 sm:px-4 py-3">' +
            '<span class="text-sm font-bold text-' + c.risk.color + '-600">' + (c.days_since_deposit !== null ? c.days_since_deposit : '-') + '</span>' +
          '</td>' +
          '<td class="px-3 sm:px-4 py-3">' +
            '<span class="inline-flex px-2 py-1 rounded-full text-xs font-medium bg-' + c.risk.color + '-100 text-' + c.risk.color + '-800">' + c.risk.label.replace(' Risk', '') + '</span>' +
          '</td>' +
          '<td class="px-3 sm:px-4 py-3">' +
            '<span class="text-sm font-medium text-slate-700">$' + formatNumber(c.total_deposit_amount) + '</span>' +
          '</td>' +
          '<td class="px-3 sm:px-4 py-3">' +
            '<div class="flex items-center gap-1">' +
              '<button onclick="editCustomer(\'' + c.id + '\')" class="p-1.5 text-slate-400 hover:text-slate-600 hover:bg-slate-100 rounded"><i data-lucide="edit-3" class="h-4 w-4"></i></button>' +
              '<button onclick="deleteCustomer(\'' + c.id + '\')" class="p-1.5 text-slate-400 hover:text-red-600 hover:bg-red-50 rounded"><i data-lucide="trash-2" class="h-4 w-4"></i></button>' +
            '</div>' +
          '</td>' +
        '</tr>';
      }
      
      tbody.innerHTML = html;
      document.getElementById('tableFooter').textContent = 'Showing ' + data.length + ' of ' + App.customers.length;
      lucide.createIcons();
    }

    function renderEmptyTable() {
      document.getElementById('tableBody').innerHTML = '<tr><td colspan="7" class="px-4 py-12 text-center text-slate-500"><i data-lucide="users" class="h-10 w-10 mx-auto mb-3 text-slate-300"></i><p class="font-medium text-sm">No customers found</p><p class="text-xs mt-1">Add customers or import CSV</p></td></tr>';
      document.getElementById('tableFooter').textContent = 'No customers';
      lucide.createIcons();
    }

    function updateStats() {
      var s = { total: 0, low: 0, medium: 0, high: 0, critical: 0, vip: 0, highvalue: 0, activelow: 0, lowinactive: 0 };
      
      for (var i = 0; i < App.customers.length; i++) {
        var c = App.customers[i];
        s.total++;
        if (c.risk.label === 'Low Risk') s.low++;
        if (c.risk.label === 'Medium Risk') s.medium++;
        if (c.risk.label === 'High Risk') s.high++;
        if (c.risk.label === 'Critical') s.critical++;
        if (c.segment.label === 'VIP') s.vip++;
        if (c.segment.label === 'High Value') s.highvalue++;
        if (c.segment.label === 'Active Low') s.activelow++;
        if (c.segment.label === 'Low Inactive') s.lowinactive++;
      }
      
      document.getElementById('stat-total').textContent = s.total;
      document.getElementById('stat-low').textContent = s.low;
      document.getElementById('stat-medium').textContent = s.medium;
      document.getElementById('stat-high').textContent = s.high;
      document.getElementById('stat-critical').textContent = s.critical;
      document.getElementById('stat-vip').textContent = s.vip;
      document.getElementById('stat-highvalue').textContent = s.highvalue;
      document.getElementById('stat-activelow').textContent = s.activelow;
      document.getElementById('stat-lowinactive').textContent = s.lowinactive;
      document.getElementById('totalCustomers').textContent = s.total;
      
      document.getElementById('churn-stat-low').textContent = s.low;
      document.getElementById('churn-stat-medium').textContent = s.medium;
      document.getElementById('churn-stat-high').textContent = s.high;
      document.getElementById('churn-stat-critical').textContent = s.critical;
      
      document.getElementById('seg-stat-vip').textContent = s.vip;
      document.getElementById('seg-stat-highvalue').textContent = s.highvalue;
      document.getElementById('seg-stat-activelow').textContent = s.activelow;
      document.getElementById('seg-stat-lowinactive').textContent = s.lowinactive;
      
      document.getElementById('export-all-count').textContent = s.total + ' customers';
      document.getElementById('export-critical-count').textContent = s.critical + ' customers';
    }

    // ============================================
    // MODAL
    // ============================================
    function openAddModal() {
      App.currentEditId = null;
      document.getElementById('modalTitle').textContent = 'Add Customer';
      document.getElementById('edit-name').value = '';
      document.getElementById('edit-phone').value = '';
      document.getElementById('edit-reg-date').value = '';
      document.getElementById('edit-deposit-date').value = '';
      document.getElementById('edit-deposits').value = '';
      document.getElementById('edit-bets').value = '';
      document.getElementById('edit-games').value = '';
      document.getElementById('edit-bet-date').value = '';
      document.getElementById('editModal').classList.remove('hidden');
      document.body.style.overflow = 'hidden';
      lucide.createIcons();
    }

    function closeEditModal() {
      document.getElementById('editModal').classList.add('hidden');
      document.body.style.overflow = '';
      App.currentEditId = null;
    }

    async function saveCustomer() {
      var data = {
        full_name: document.getElementById('edit-name').value.trim(),
        phone_number: document.getElementById('edit-phone').value.trim() || null,
        registration_date: document.getElementById('edit-reg-date').value || null,
        last_deposit_date: document.getElementById('edit-deposit-date').value || null,
        total_deposit_amount: parseFloat(document.getElementById('edit-deposits').value) || 0,
        total_bet_amount: parseFloat(document.getElementById('edit-bets').value) || 0,
        games_played: parseInt(document.getElementById('edit-games').value) || 0,
        last_bet_date: document.getElementById('edit-bet-date').value || null
      };
      
      if (!data.full_name) {
        showNotification('Enter a name', 'error');
        return;
      }
      
      closeEditModal();
      
      if (App.currentEditId) {
        await updateCustomerInDB(App.currentEditId, data);
      } else {
        await addCustomerToDB(data);
      }
    }

    // ============================================
    // FILTERING
    // ============================================
    function filterTable() {
      var search = document.getElementById('searchInput').value.toLowerCase();
      var churn = document.getElementById('churnFilter').value;
      var segment = document.getElementById('segmentFilter').value;
      
      var filtered = [];
      for (var i = 0; i < App.customers.length; i++) {
        var c = App.customers[i];
        var matchSearch = !search || (c.full_name && c.full_name.toLowerCase().indexOf(search) !== -1) || (c.phone_number && c.phone_number.indexOf(search) !== -1);
        var matchChurn = churn === 'all' || c.risk.label.toLowerCase().indexOf(churn) !== -1;
        var matchSeg = segment === 'all' || c.segment.label.indexOf(segment) !== -1;
        if (matchSearch && matchChurn && matchSeg) filtered.push(c);
      }
      
      renderTable(filtered);
    }

    function clearFilters() {
      document.getElementById('searchInput').value = '';
      document.getElementById('churnFilter').value = 'all';
      document.getElementById('segmentFilter').value = 'all';
      renderTable(App.customers);
    }

    function filterByRisk(risk) {
      document.getElementById('churnFilter').value = risk;
      filterTable();
    }

    function filterBySegment(segment) {
      switchTab('dashboard');
      document.getElementById('segmentFilter').value = segment;
      filterTable();
    }

    // ============================================
    // CSV IMPORT
    // ============================================
    async function handleFileUpload(event) {
      var file = event.target.files[0];
      if (!file || !App.db) {
        showNotification('Select a file', 'error');
        return;
      }
      
      showLoading(true);
      
      try {
        var text = await file.text();
        var lines = text.split('\n');
        var validLines = [];
        for (var i = 0; i < lines.length; i++) {
          if (lines[i].trim()) validLines.push(lines[i]);
        }
        
        var headerLine = validLines[0].split(',');
        var headers = [];
        for (var i = 0; i < headerLine.length; i++) {
          headers.push(headerLine[i].trim().replace(/"/g, '').toLowerCase());
        }
        
        var fieldMap = {
          'full_name': ['full_name', 'fullname', 'name'],
          'phone_number': ['phone_number', 'phone', 'mobile'],
          'registration_date': ['registration_date', 'registered'],
          'last_deposit_date': ['last_deposit_date', 'last_deposit'],
          'total_deposit_amount': ['total_deposit_amount', 'deposits'],
          'total_bet_amount': ['total_bet_amount', 'bets'],
          'games_played': ['games_played', 'games'],
          'last_bet_date': ['last_bet_date', 'last_bet']
        };
        
        var colIdx = {};
        for (var field in fieldMap) {
          var aliases = fieldMap[field];
          for (var j = 0; j < headers.length; j++) {
            var h = headers[j].replace(/[_\s-]/g, '');
            for (var k = 0; k < aliases.length; k++) {
              if (h === aliases[k].replace(/[_\s-]/g, '')) {
                colIdx[field] = j;
                break;
              }
            }
          }
        }
        
        var toImport = [];
        for (var i = 1; i < validLines.length; i++) {
          var vals = parseCSVLine(validLines[i]);
          var cust = {};
          for (var f in colIdx) {
            if (vals[colIdx[f]]) cust[f] = vals[colIdx[f]];
          }
          if (cust.full_name || cust.phone_number) toImport.push(cust);
        }
        
        if (toImport.length === 0) {
          showNotification('No valid customers found', 'error');
          showLoading(false);
          return;
        }
        
        var result = await App.db.from('customers').insert(toImport);
        if (result.error) throw result.error;
        
        showNotification('Imported ' + toImport.length + ' customers!', 'success');
        await loadCustomers();
      } catch (error) {
        showNotification('Import failed: ' + error.message, 'error');
      } finally {
        showLoading(false);
        event.target.value = '';
      }
    }

    function parseCSVLine(line) {
      var vals = [];
      var current = '';
      var inQuotes = false;
      for (var i = 0; i < line.length; i++) {
        var char = line[i];
        if (char === '"') inQuotes = !inQuotes;
        else if (char === ',' && !inQuotes) { vals.push(current.trim()); current = ''; }
        else current += char;
      }
      vals.push(current.trim());
      return vals;
    }

    // ============================================
    // EXPORT
    // ============================================
    function exportData(category) {
      var data = [];
      for (var i = 0; i < App.customers.length; i++) {
        if (category === 'all' || (category === 'critical' && App.customers[i].risk.label === 'Critical')) {
          data.push(App.customers[i]);
        }
      }
      
      if (data.length === 0) {
        showNotification('No data to export', 'info');
        return;
      }
      
      var headers = ['id', 'full_name', 'phone_number', 'registration_date', 'last_deposit_date', 'total_deposit_amount', 'total_bet_amount', 'games_played', 'last_bet_date', 'days_since_deposit', 'churn_risk', 'value_segment'];
      var rows = [headers.join(',')];
      
      for (var i = 0; i < data.length; i++) {
        var c = data[i];
        rows.push([
          c.id,
          '"' + (c.full_name || '') + '"',
          c.phone_number || '',
          c.registration_date || '',
          c.last_deposit_date || '',
          c.total_deposit_amount || 0,
          c.total_bet_amount || 0,
          c.games_played || 0,
          c.last_bet_date || '',
          c.days_since_deposit !== null ? c.days_since_deposit : '',
          c.risk.label,
          c.segment.label
        ].join(','));
      }
      
      var csv = rows.join('\n');
      var blob = new Blob([csv], { type: 'text/csv' });
      var a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'bwanabet_' + category + '_' + new Date().toISOString().split('T')[0] + '.csv';
      a.click();
      showNotification('Exported ' + data.length + ' customers', 'success');
    }

    // ============================================
    // UI HELPERS
    // ============================================
    function toggleMobileMenu() {
      App.mobileMenuOpen = !App.mobileMenuOpen;
      document.getElementById('mobileMenu').style.maxHeight = App.mobileMenuOpen ? '300px' : '0';
    }

    function switchTab(tab) {
      var contents = document.querySelectorAll('.tab-content');
      for (var i = 0; i < contents.length; i++) contents[i].classList.add('hidden');
      
      var tabs = document.querySelectorAll('.tab-btn');
      for (var i = 0; i < tabs.length; i++) tabs[i].classList.remove('active');
      
      document.getElementById('content-' + tab).classList.remove('hidden');
      
      var desktopTab = document.getElementById('tab-' + tab);
      var mobileTab = document.getElementById('tab-' + tab + '-mobile');
      if (desktopTab) desktopTab.classList.add('active');
      if (mobileTab) mobileTab.classList.add('active');
      
      lucide.createIcons();
    }

    function switchSettingsTab(tab) {
      var contents = document.querySelectorAll('.settings-content');
      for (var i = 0; i < contents.length; i++) contents[i].classList.add('hidden');
      
      var tabs = document.querySelectorAll('.settings-tab-btn');
      for (var i = 0; i < tabs.length; i++) tabs[i].classList.remove('active');
      
      document.getElementById('settings-content-' + tab).classList.remove('hidden');
      document.getElementById('settings-tab-' + tab).classList.add('active');
      
      lucide.createIcons();
    }

    function toggleSelectAll() {
      var checked = document.getElementById('selectAll').checked;
      var checkboxes = document.querySelectorAll('.customer-checkbox');
      for (var i = 0; i < checkboxes.length; i++) checkboxes[i].checked = checked;
    }

    function formatNumber(val) {
      var num = parseFloat(val);
      return isNaN(num) ? '0' : num.toLocaleString();
    }

    function showLoading(show) {
      if (show) {
        document.getElementById('loadingOverlay').classList.remove('hidden');
      } else {
        document.getElementById('loadingOverlay').classList.add('hidden');
      }
    }

    function showNotification(msg, type) {
      type = type || 'info';
      var el = document.getElementById('notification');
      var bgClass = 'bg-slate-700';
      if (type === 'success') bgClass = 'bg-emerald-500';
      if (type === 'error') bgClass = 'bg-red-500';
      
      el.className = 'fixed top-4 right-4 left-4 sm:left-auto z-50 px-4 py-3 rounded-lg shadow-xl flex items-center gap-3 notification text-sm text-white ' + bgClass;
      
      var icon = 'info';
      if (type === 'success') icon = 'check-circle';
      if (type === 'error') icon = 'x-circle';
      
      el.innerHTML = '<i data-lucide="' + icon + '" class="h-5 w-5 flex-shrink-0"></i><span class="flex-1">' + msg + '</span>';
      el.classList.remove('hidden');
      lucide.createIcons();
      
      setTimeout(function() { el.classList.add('hidden'); }, 4000);
    }
  </script>
</body>
</html>
