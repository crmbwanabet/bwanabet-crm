<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>BwanaBet CRM System</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap');
    body { font-family: 'Inter', sans-serif; }
    .tab-btn.active { background: #fbbf24; color: #000; }
    .clickable-card { cursor: pointer; transition: all 0.2s; }
    .clickable-card:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
    .notification { animation: slideIn 0.3s ease-out; }
    @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
    .spinner { animation: spin 1s linear infinite; }
    @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
    .mobile-menu { transition: max-height 0.3s ease-out; }
    .table-scroll::-webkit-scrollbar { height: 8px; }
    .table-scroll::-webkit-scrollbar-track { background: #f1f5f9; }
    .table-scroll::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
    #playerModal { animation: fadeIn 0.2s ease-out; }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    #playerModal > div { animation: slideUp 0.3s ease-out; }
    @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
    details summary::-webkit-details-marker { display: none; }
    details summary::after { content: '▶'; margin-left: auto; transition: transform 0.2s; }
    details[open] summary::after { transform: rotate(90deg); }
  </style>
</head>
<body class="bg-slate-100 min-h-screen">
  <div id="loginScreen" class="min-h-screen flex items-center justify-center bg-gradient-to-br from-slate-900 to-slate-800 p-4">
    <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md overflow-hidden">
      <div class="bg-black p-6 text-center border-b-4 border-amber-400">
        <h1 class="text-amber-400 font-extrabold text-3xl tracking-tight">BWANABET</h1>
        <p class="text-slate-400 text-sm mt-1">CRM System v2.1</p>
      </div>
      <div class="p-6 sm:p-8">
        <h2 class="text-xl font-bold text-slate-800 mb-6 text-center">Sign In</h2>
        <div id="loginError" class="hidden mb-4 p-3 bg-red-50 border border-red-200 rounded-lg text-red-700 text-sm"></div>
        <div class="space-y-4">
          <div><label class="block text-sm font-medium text-slate-700 mb-1">Email</label><input type="email" id="loginEmail" placeholder="you@example.com" class="w-full px-4 py-3 border border-slate-200 rounded-lg text-sm"/></div>
          <div><label class="block text-sm font-medium text-slate-700 mb-1">Password</label><input type="password" id="loginPassword" placeholder="••••••••" class="w-full px-4 py-3 border border-slate-200 rounded-lg text-sm"/></div>
          <button id="loginBtn" class="w-full py-3 bg-amber-500 text-black font-bold rounded-lg hover:bg-amber-400 flex items-center justify-center gap-2"><i data-lucide="log-in" class="h-5 w-5"></i> Sign In</button>
        </div>
      </div>
    </div>
  </div>

  <div id="mainApp" class="hidden">
    <div id="loadingOverlay" class="hidden fixed inset-0 bg-black/30 flex items-center justify-center z-[100]">
      <div class="bg-white rounded-xl p-6 flex items-center gap-4 shadow-2xl">
        <svg class="spinner h-8 w-8 text-amber-500" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"></path></svg>
        <span class="text-lg font-medium text-slate-700" id="loadingText">Loading...</span>
      </div>
    </div>
    <div id="notification" class="hidden fixed top-4 right-4 left-4 sm:left-auto z-50 px-4 py-3 rounded-lg shadow-xl flex items-center gap-3 notification"></div>

    <header class="bg-black shadow-md border-b-4 border-amber-400">
      <div class="max-w-7xl mx-auto px-4 sm:px-6 py-3">
        <div class="flex items-center justify-between">
          <div class="flex items-center gap-3 sm:gap-6">
            <div class="text-amber-400 font-extrabold text-xl sm:text-2xl tracking-tight">BWANABET</div>
            <div class="hidden sm:block border-l-2 border-slate-600 pl-4"><h1 class="text-lg font-bold text-white">CRM System</h1></div>
          </div>
          <div class="flex items-center gap-2 sm:gap-4">
            <div class="flex items-center gap-1.5 px-2 sm:px-3 py-1 rounded-full bg-slate-700">
              <div id="statusDot" class="w-2 h-2 rounded-full bg-gray-400"></div>
              <span id="statusText" class="text-xs text-slate-300 hidden sm:inline">Connecting...</span>
            </div>
            <span id="userEmail" class="text-xs text-slate-400 hidden sm:inline truncate max-w-[120px]"></span>
            <button id="logoutBtn" class="flex items-center gap-1 px-2 sm:px-3 py-1.5 bg-slate-700 text-slate-300 rounded-lg hover:bg-slate-600 text-sm"><i data-lucide="log-out" class="h-4 w-4"></i><span class="hidden sm:inline">Logout</span></button>
            <button id="mobileMenuBtn" class="lg:hidden p-2 text-slate-300 hover:text-white"><i data-lucide="menu" class="h-6 w-6"></i></button>
          </div>
        </div>
        <div class="hidden lg:flex items-center gap-1 bg-slate-800 rounded-lg p-1 mt-3 w-fit">
          <button id="tab-dashboard" class="tab-btn active flex items-center gap-2 px-4 py-2 rounded-md font-medium text-slate-300"><i data-lucide="layout-dashboard" class="h-4 w-4"></i>Dashboard</button>
          <button id="tab-profitability" class="tab-btn flex items-center gap-2 px-4 py-2 rounded-md font-medium text-slate-300"><i data-lucide="dollar-sign" class="h-4 w-4"></i>Profitability</button>
          <button id="tab-behavior" class="tab-btn flex items-center gap-2 px-4 py-2 rounded-md font-medium text-slate-300"><i data-lucide="brain" class="h-4 w-4"></i>Behavior</button>
          <button id="tab-churn" class="tab-btn flex items-center gap-2 px-4 py-2 rounded-md font-medium text-slate-300"><i data-lucide="user-x" class="h-4 w-4"></i>Churn</button>
          <button id="tab-players" class="tab-btn flex items-center gap-2 px-4 py-2 rounded-md font-medium text-slate-300"><i data-lucide="users" class="h-4 w-4"></i>Players</button>
          <button id="tab-settings" class="tab-btn flex items-center gap-2 px-4 py-2 rounded-md font-medium text-slate-300"><i data-lucide="settings" class="h-4 w-4"></i>Settings</button>
        </div>
        <div id="mobileMenu" class="lg:hidden mobile-menu max-h-0 overflow-hidden">
          <div class="flex flex-col gap-1 bg-slate-800 rounded-lg p-2 mt-3">
            <button id="tab-dashboard-mobile" class="tab-btn active px-4 py-3 rounded-md font-medium text-slate-300 text-left">Dashboard</button>
            <button id="tab-profitability-mobile" class="tab-btn px-4 py-3 rounded-md font-medium text-slate-300 text-left">Profitability</button>
            <button id="tab-behavior-mobile" class="tab-btn px-4 py-3 rounded-md font-medium text-slate-300 text-left">Behavior</button>
            <button id="tab-churn-mobile" class="tab-btn px-4 py-3 rounded-md font-medium text-slate-300 text-left">Churn</button>
            <button id="tab-players-mobile" class="tab-btn px-4 py-3 rounded-md font-medium text-slate-300 text-left">Players</button>
            <button id="tab-settings-mobile" class="tab-btn px-4 py-3 rounded-md font-medium text-slate-300 text-left">Settings</button>
          </div>
        </div>
      </div>
    </header>

    <main class="max-w-7xl mx-auto px-4 sm:px-6 py-4 sm:py-8">
      <!-- DASHBOARD -->
      <div id="content-dashboard" class="tab-content">
        <div class="grid grid-cols-2 sm:grid-cols-4 gap-3 sm:gap-4 mb-6">
          <div class="bg-white rounded-xl shadow-sm p-4 border-l-4 border-indigo-500 clickable-card" onclick="showAllPlayers()">
            <p class="text-xs text-slate-500">Total Players</p>
            <p class="text-2xl font-bold text-indigo-600" id="metric-total">0</p>
            <p class="text-xs text-indigo-400 mt-1">Click to view →</p>
          </div>
          <div class="bg-white rounded-xl shadow-sm p-4 border-l-4 border-emerald-500 clickable-card" onclick="showFilteredPlayers('profitable', 'Profitable Players')">
            <p class="text-xs text-slate-500">Profitable Players</p>
            <p class="text-2xl font-bold text-emerald-600" id="metric-profitable">0</p>
            <p class="text-xs text-emerald-400 mt-1">Click to view →</p>
          </div>
          <div class="bg-white rounded-xl shadow-sm p-4 border-l-4 border-red-500 clickable-card" onclick="showFilteredPlayers('negative_ggr', 'Negative GGR Players')">
            <p class="text-xs text-slate-500">Negative GGR Players</p>
            <p class="text-2xl font-bold text-red-600" id="metric-negative-ggr">0</p>
            <p class="text-xs text-red-400 mt-1">Click to view →</p>
          </div>
          <div class="bg-white rounded-xl shadow-sm p-4 border-l-4 border-amber-500 clickable-card" onclick="showFilteredPlayers('atrisk', 'At Risk Players')">
            <p class="text-xs text-slate-500">At Risk</p>
            <p class="text-2xl font-bold text-amber-600" id="metric-atrisk">0</p>
            <p class="text-xs text-amber-400 mt-1">Click to view →</p>
          </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
          <div class="bg-white rounded-xl shadow-sm p-5">
            <h3 class="font-bold text-slate-800 mb-4">Financial Overview</h3>
            <div class="space-y-3">
              <div class="flex justify-between p-3 bg-emerald-50 rounded-lg"><span class="text-emerald-700">Total Deposits</span><span class="font-bold text-emerald-600" id="fin-deposits">K0</span></div>
              <div class="flex justify-between p-3 bg-red-50 rounded-lg"><span class="text-red-700">Total Withdrawals</span><span class="font-bold text-red-600" id="fin-withdrawals">K0</span></div>
              <div class="flex justify-between p-3 bg-blue-50 rounded-lg"><span class="text-blue-700">Net Revenue (GGR)</span><span class="font-bold text-blue-600" id="fin-net">K0</span></div>
            </div>
          </div>
          <div class="bg-white rounded-xl shadow-sm p-5">
            <h3 class="font-bold text-slate-800 mb-4">Player Preferences</h3>
            <div class="space-y-3">
              <div class="clickable-card p-3 bg-green-50 rounded-lg border border-green-200" onclick="showFilteredPlayers('pref_sports', 'Sports Bettors')">
                <div class="flex justify-between"><span class="text-green-700">Sports Bettors</span><div class="flex items-center gap-2"><span class="font-bold text-green-600" id="pref-sports">0</span><i data-lucide="download" class="h-4 w-4 text-green-400" onclick="event.stopPropagation(); exportFiltered('pref_sports', 'sports_bettors')"></i></div></div>
              </div>
              <div class="clickable-card p-3 bg-purple-50 rounded-lg border border-purple-200" onclick="showFilteredPlayers('pref_casino', 'Casino Players')">
                <div class="flex justify-between"><span class="text-purple-700">Casino Players</span><div class="flex items-center gap-2"><span class="font-bold text-purple-600" id="pref-casino">0</span><i data-lucide="download" class="h-4 w-4 text-purple-400" onclick="event.stopPropagation(); exportFiltered('pref_casino', 'casino_players')"></i></div></div>
              </div>
              <div class="clickable-card p-3 bg-blue-50 rounded-lg border border-blue-200" onclick="showFilteredPlayers('pref_mixed', 'Mixed Players')">
                <div class="flex justify-between"><span class="text-blue-700">Mixed Players</span><div class="flex items-center gap-2"><span class="font-bold text-blue-600" id="pref-mixed">0</span><i data-lucide="download" class="h-4 w-4 text-blue-400" onclick="event.stopPropagation(); exportFiltered('pref_mixed', 'mixed_players')"></i></div></div>
              </div>
            </div>
          </div>
        </div>

        <div class="bg-white rounded-xl shadow-sm p-5 mb-6">
          <h3 class="font-bold text-slate-800 mb-4">Value Segments</h3>
          <div class="grid grid-cols-2 sm:grid-cols-4 gap-3">
            <div class="clickable-card p-4 bg-purple-50 rounded-lg border border-purple-200 text-center" onclick="showFilteredPlayers('value_vip', 'VIP Players')">
              <p class="text-xs text-purple-600">VIP (K5k+)</p><p class="text-2xl font-bold text-purple-700" id="seg-vip">0</p>
              <button class="mt-2 text-xs text-purple-600" onclick="event.stopPropagation(); exportFiltered('value_vip', 'vip')"><i data-lucide="download" class="h-3 w-3 inline"></i> Export</button>
            </div>
            <div class="clickable-card p-4 bg-blue-50 rounded-lg border border-blue-200 text-center" onclick="showFilteredPlayers('value_high', 'High Value')">
              <p class="text-xs text-blue-600">High (K1k-K5k)</p><p class="text-2xl font-bold text-blue-700" id="seg-high">0</p>
              <button class="mt-2 text-xs text-blue-600" onclick="event.stopPropagation(); exportFiltered('value_high', 'high_value')"><i data-lucide="download" class="h-3 w-3 inline"></i> Export</button>
            </div>
            <div class="clickable-card p-4 bg-teal-50 rounded-lg border border-teal-200 text-center" onclick="showFilteredPlayers('value_medium', 'Medium Value')">
              <p class="text-xs text-teal-600">Medium (K100-K1k)</p><p class="text-2xl font-bold text-teal-700" id="seg-medium">0</p>
              <button class="mt-2 text-xs text-teal-600" onclick="event.stopPropagation(); exportFiltered('value_medium', 'medium_value')"><i data-lucide="download" class="h-3 w-3 inline"></i> Export</button>
            </div>
            <div class="clickable-card p-4 bg-slate-50 rounded-lg border border-slate-200 text-center" onclick="showFilteredPlayers('value_low', 'Low Value')">
              <p class="text-xs text-slate-600">Low (&lt;K100)</p><p class="text-2xl font-bold text-slate-700" id="seg-low">0</p>
              <button class="mt-2 text-xs text-slate-600" onclick="event.stopPropagation(); exportFiltered('value_low', 'low_value')"><i data-lucide="download" class="h-3 w-3 inline"></i> Export</button>
            </div>
          </div>
        </div>

        <div class="bg-white rounded-xl shadow-sm p-5">
          <h3 class="font-bold text-slate-800 mb-4">Churn Risk</h3>
          <div class="grid grid-cols-2 sm:grid-cols-4 gap-3">
            <div class="clickable-card text-center p-4 bg-emerald-50 rounded-lg border border-emerald-200" onclick="showFilteredPlayers('churn_low', 'Low Risk')">
              <p class="text-3xl font-bold text-emerald-600" id="churn-low">0</p><p class="text-sm text-emerald-700">Low Risk</p>
              <button class="mt-2 text-xs text-emerald-600" onclick="event.stopPropagation(); exportFiltered('churn_low', 'low_risk')"><i data-lucide="download" class="h-3 w-3 inline"></i> Export</button>
            </div>
            <div class="clickable-card text-center p-4 bg-amber-50 rounded-lg border border-amber-200" onclick="showFilteredPlayers('churn_medium', 'Medium Risk')">
              <p class="text-3xl font-bold text-amber-600" id="churn-medium">0</p><p class="text-sm text-amber-700">Medium</p>
              <button class="mt-2 text-xs text-amber-600" onclick="event.stopPropagation(); exportFiltered('churn_medium', 'medium_risk')"><i data-lucide="download" class="h-3 w-3 inline"></i> Export</button>
            </div>
            <div class="clickable-card text-center p-4 bg-orange-50 rounded-lg border border-orange-200" onclick="showFilteredPlayers('churn_high', 'High Risk')">
              <p class="text-3xl font-bold text-orange-600" id="churn-high">0</p><p class="text-sm text-orange-700">High Risk</p>
              <button class="mt-2 text-xs text-orange-600" onclick="event.stopPropagation(); exportFiltered('churn_high', 'high_risk')"><i data-lucide="download" class="h-3 w-3 inline"></i> Export</button>
            </div>
            <div class="clickable-card text-center p-4 bg-red-50 rounded-lg border border-red-200" onclick="showFilteredPlayers('churn_critical', 'Critical Risk')">
              <p class="text-3xl font-bold text-red-600" id="churn-critical">0</p><p class="text-sm text-red-700">Critical</p>
              <button class="mt-2 text-xs text-red-600" onclick="event.stopPropagation(); exportFiltered('churn_critical', 'critical_risk')"><i data-lucide="download" class="h-3 w-3 inline"></i> Export</button>
            </div>
          </div>
        </div>
      </div>

      <!-- PROFITABILITY -->
      <div id="content-profitability" class="tab-content hidden">
        <h2 class="text-xl font-bold text-slate-800 mb-4">Player Profitability Analysis</h2>
        <div class="bg-amber-50 border-l-4 border-amber-500 p-4 rounded-lg mb-6">
          <p class="text-amber-800 font-medium">Understanding Profitability</p>
          <p class="text-amber-700 text-sm mt-1"><strong>Profitable Players</strong> = Lost more than won (company earns from them)<br><strong>Negative GGR Players</strong> = Won more than lost (company loses money on them)</p>
        </div>
        <div class="grid grid-cols-1 sm:grid-cols-2 gap-6 mb-6">
          <div class="clickable-card bg-gradient-to-br from-emerald-500 to-emerald-600 rounded-xl p-6 text-white" onclick="showFilteredPlayers('profitable', 'Profitable Players')">
            <div class="flex items-center justify-between mb-4">
              <div><h3 class="text-xl font-bold">Profitable Players</h3><p class="text-emerald-100 text-sm">Lost more than won</p></div>
              <button class="bg-white/20 rounded-lg px-3 py-2 text-sm" onclick="event.stopPropagation(); exportFiltered('profitable', 'profitable')"><i data-lucide="download" class="h-4 w-4 inline"></i> Export</button>
            </div>
            <p class="text-5xl font-bold" id="profit-count">0</p>
            <p class="text-emerald-100 mt-2">Company profit: <span class="font-bold" id="profit-amount">K0</span></p>
          </div>
          <div class="clickable-card bg-gradient-to-br from-red-500 to-red-600 rounded-xl p-6 text-white" onclick="showFilteredPlayers('negative_ggr', 'Negative GGR Players')">
            <div class="flex items-center justify-between mb-4">
              <div><h3 class="text-xl font-bold">Negative GGR Players</h3><p class="text-red-100 text-sm">Won more than lost</p></div>
              <button class="bg-white/20 rounded-lg px-3 py-2 text-sm" onclick="event.stopPropagation(); exportFiltered('negative_ggr', 'negative_ggr')"><i data-lucide="download" class="h-4 w-4 inline"></i> Export</button>
            </div>
            <p class="text-5xl font-bold" id="negative-ggr-count">0</p>
            <p class="text-red-100 mt-2">Company loss: <span class="font-bold" id="negative-ggr-amount">K0</span></p>
          </div>
        </div>
        <div class="bg-white rounded-xl shadow-sm p-5">
          <h3 class="font-bold text-slate-800 mb-4">Win Rate Distribution</h3>
          <div class="grid grid-cols-2 sm:grid-cols-4 gap-3">
            <div class="clickable-card p-4 bg-emerald-50 rounded-lg text-center" onclick="showFilteredPlayers('wr_0_25', 'Win Rate 0-25%')">
              <p class="text-xs text-emerald-600">0-25% (Most Profitable)</p><p class="text-2xl font-bold text-emerald-700" id="wr-0-25">0</p>
              <button class="mt-2 text-xs text-emerald-600" onclick="event.stopPropagation(); exportFiltered('wr_0_25', 'wr_0_25')"><i data-lucide="download" class="h-3 w-3 inline"></i> Export</button>
            </div>
            <div class="clickable-card p-4 bg-teal-50 rounded-lg text-center" onclick="showFilteredPlayers('wr_25_40', 'Win Rate 25-40%')">
              <p class="text-xs text-teal-600">25-40% (Profitable)</p><p class="text-2xl font-bold text-teal-700" id="wr-25-40">0</p>
              <button class="mt-2 text-xs text-teal-600" onclick="event.stopPropagation(); exportFiltered('wr_25_40', 'wr_25_40')"><i data-lucide="download" class="h-3 w-3 inline"></i> Export</button>
            </div>
            <div class="clickable-card p-4 bg-amber-50 rounded-lg text-center" onclick="showFilteredPlayers('wr_40_50', 'Win Rate 40-50%')">
              <p class="text-xs text-amber-600">40-50% (Break Even)</p><p class="text-2xl font-bold text-amber-700" id="wr-40-50">0</p>
              <button class="mt-2 text-xs text-amber-600" onclick="event.stopPropagation(); exportFiltered('wr_40_50', 'wr_40_50')"><i data-lucide="download" class="h-3 w-3 inline"></i> Export</button>
            </div>
            <div class="clickable-card p-4 bg-red-50 rounded-lg text-center" onclick="showFilteredPlayers('wr_50_plus', 'Win Rate 50%+')">
              <p class="text-xs text-red-600">50%+ (Negative GGR)</p><p class="text-2xl font-bold text-red-700" id="wr-50-plus">0</p>
              <button class="mt-2 text-xs text-red-600" onclick="event.stopPropagation(); exportFiltered('wr_50_plus', 'wr_50_plus')"><i data-lucide="download" class="h-3 w-3 inline"></i> Export</button>
            </div>
          </div>
        </div>
      </div>

      <!-- BEHAVIOR -->
      <div id="content-behavior" class="tab-content hidden">
        <h2 class="text-xl font-bold text-slate-800 mb-4">Player Behavior</h2>
        <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 mb-6">
          <div class="clickable-card bg-gradient-to-br from-amber-500 to-amber-600 rounded-xl p-5 text-white" onclick="showFilteredPlayers('style_highroller', 'High Rollers')">
            <div class="flex justify-between"><h3 class="font-bold">High Rollers</h3><i data-lucide="download" class="h-5 w-5 opacity-70" onclick="event.stopPropagation(); exportFiltered('style_highroller', 'high_rollers')"></i></div>
            <p class="text-white/80 text-sm">Avg bet &gt;K100</p><p class="text-4xl font-bold mt-2" id="style-highroller">0</p>
          </div>
          <div class="clickable-card bg-gradient-to-br from-blue-500 to-blue-600 rounded-xl p-5 text-white" onclick="showFilteredPlayers('style_regular', 'Regular Bettors')">
            <div class="flex justify-between"><h3 class="font-bold">Regular Bettors</h3><i data-lucide="download" class="h-5 w-5 opacity-70" onclick="event.stopPropagation(); exportFiltered('style_regular', 'regular_bettors')"></i></div>
            <p class="text-white/80 text-sm">Avg bet K10-K100</p><p class="text-4xl font-bold mt-2" id="style-regular">0</p>
          </div>
          <div class="clickable-card bg-gradient-to-br from-slate-500 to-slate-600 rounded-xl p-5 text-white" onclick="showFilteredPlayers('style_casual', 'Casual Players')">
            <div class="flex justify-between"><h3 class="font-bold">Casual Players</h3><i data-lucide="download" class="h-5 w-5 opacity-70" onclick="event.stopPropagation(); exportFiltered('style_casual', 'casual_players')"></i></div>
            <p class="text-white/80 text-sm">Avg bet &lt;K10</p><p class="text-4xl font-bold mt-2" id="style-casual">0</p>
          </div>
        </div>
        <div class="bg-white rounded-xl shadow-sm p-5">
          <h3 class="font-bold text-slate-800 mb-4">Lifecycle Stages</h3>
          <div class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-6 gap-3">
            <div class="clickable-card bg-cyan-50 rounded-lg p-3 text-center border border-cyan-200" onclick="showFilteredPlayers('life_new', 'New Players')">
              <p class="text-2xl font-bold text-cyan-600" id="life-new">0</p><p class="text-xs text-cyan-700">New (&lt;30d)</p>
              <button class="mt-1 text-xs text-cyan-600" onclick="event.stopPropagation(); exportFiltered('life_new', 'new')">Export</button>
            </div>
            <div class="clickable-card bg-emerald-50 rounded-lg p-3 text-center border border-emerald-200" onclick="showFilteredPlayers('life_growing', 'Growing')">
              <p class="text-2xl font-bold text-emerald-600" id="life-growing">0</p><p class="text-xs text-emerald-700">Growing</p>
              <button class="mt-1 text-xs text-emerald-600" onclick="event.stopPropagation(); exportFiltered('life_growing', 'growing')">Export</button>
            </div>
            <div class="clickable-card bg-purple-50 rounded-lg p-3 text-center border border-purple-200" onclick="showFilteredPlayers('life_mature', 'Mature')">
              <p class="text-2xl font-bold text-purple-600" id="life-mature">0</p><p class="text-xs text-purple-700">Mature</p>
              <button class="mt-1 text-xs text-purple-600" onclick="event.stopPropagation(); exportFiltered('life_mature', 'mature')">Export</button>
            </div>
            <div class="clickable-card bg-amber-50 rounded-lg p-3 text-center border border-amber-200" onclick="showFilteredPlayers('life_declining', 'Declining')">
              <p class="text-2xl font-bold text-amber-600" id="life-declining">0</p><p class="text-xs text-amber-700">Declining</p>
              <button class="mt-1 text-xs text-amber-600" onclick="event.stopPropagation(); exportFiltered('life_declining', 'declining')">Export</button>
            </div>
            <div class="clickable-card bg-orange-50 rounded-lg p-3 text-center border border-orange-200" onclick="showFilteredPlayers('life_dormant', 'Dormant')">
              <p class="text-2xl font-bold text-orange-600" id="life-dormant">0</p><p class="text-xs text-orange-700">Dormant</p>
              <button class="mt-1 text-xs text-orange-600" onclick="event.stopPropagation(); exportFiltered('life_dormant', 'dormant')">Export</button>
            </div>
            <div class="clickable-card bg-red-50 rounded-lg p-3 text-center border border-red-200" onclick="showFilteredPlayers('life_churned', 'Churned')">
              <p class="text-2xl font-bold text-red-600" id="life-churned">0</p><p class="text-xs text-red-700">Churned</p>
              <button class="mt-1 text-xs text-red-600" onclick="event.stopPropagation(); exportFiltered('life_churned', 'churned')">Export</button>
            </div>
          </div>
        </div>
      </div>

      <!-- CHURN -->
      <div id="content-churn" class="tab-content hidden">
        <h2 class="text-xl font-bold text-slate-800 mb-4">Churn Risk Analysis</h2>
        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-6">
          <div class="clickable-card bg-gradient-to-br from-emerald-500 to-emerald-600 rounded-xl p-5 text-white" onclick="showFilteredPlayers('churn_low', 'Low Risk')">
            <div class="flex justify-between"><h3 class="text-xl font-bold">Low Risk</h3><button class="bg-white/20 px-3 py-1 rounded text-sm" onclick="event.stopPropagation(); exportFiltered('churn_low', 'low_risk')">Export</button></div>
            <p class="text-white/80 text-sm">&lt;7 days</p><p class="text-4xl font-bold mt-3" id="churn-d-low">0</p>
          </div>
          <div class="clickable-card bg-gradient-to-br from-amber-500 to-amber-600 rounded-xl p-5 text-white" onclick="showFilteredPlayers('churn_medium', 'Medium Risk')">
            <div class="flex justify-between"><h3 class="text-xl font-bold">Medium Risk</h3><button class="bg-white/20 px-3 py-1 rounded text-sm" onclick="event.stopPropagation(); exportFiltered('churn_medium', 'medium_risk')">Export</button></div>
            <p class="text-white/80 text-sm">7-14 days</p><p class="text-4xl font-bold mt-3" id="churn-d-medium">0</p>
          </div>
          <div class="clickable-card bg-gradient-to-br from-orange-500 to-orange-600 rounded-xl p-5 text-white" onclick="showFilteredPlayers('churn_high', 'High Risk')">
            <div class="flex justify-between"><h3 class="text-xl font-bold">High Risk</h3><button class="bg-white/20 px-3 py-1 rounded text-sm" onclick="event.stopPropagation(); exportFiltered('churn_high', 'high_risk')">Export</button></div>
            <p class="text-white/80 text-sm">14-30 days</p><p class="text-4xl font-bold mt-3" id="churn-d-high">0</p>
          </div>
          <div class="clickable-card bg-gradient-to-br from-red-500 to-red-600 rounded-xl p-5 text-white" onclick="showFilteredPlayers('churn_critical', 'Critical')">
            <div class="flex justify-between"><h3 class="text-xl font-bold">Critical</h3><button class="bg-white/20 px-3 py-1 rounded text-sm" onclick="event.stopPropagation(); exportFiltered('churn_critical', 'critical')">Export</button></div>
            <p class="text-white/80 text-sm">30+ days</p><p class="text-4xl font-bold mt-3" id="churn-d-critical">0</p>
          </div>
        </div>
        <div class="bg-white rounded-xl shadow-sm p-5">
          <h3 class="font-bold text-slate-800 mb-4">Additional Indicators</h3>
          <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
            <div class="clickable-card p-4 bg-red-50 rounded-lg border border-red-200" onclick="showFilteredPlayers('withdrawing', 'Withdrawing Profits')">
              <div class="flex justify-between"><span class="text-sm font-medium text-red-700">Withdrawing Profits</span><i data-lucide="download" class="h-4 w-4 text-red-400" onclick="event.stopPropagation(); exportFiltered('withdrawing', 'withdrawing')"></i></div>
              <p class="text-2xl font-bold text-red-600" id="alert-withdrawing">0</p>
            </div>
            <div class="clickable-card p-4 bg-amber-50 rounded-lg border border-amber-200" onclick="showFilteredPlayers('biglosers', 'Big Losers')">
              <div class="flex justify-between"><span class="text-sm font-medium text-amber-700">Big Losers (&lt;40% WR)</span><i data-lucide="download" class="h-4 w-4 text-amber-400" onclick="event.stopPropagation(); exportFiltered('biglosers', 'big_losers')"></i></div>
              <p class="text-2xl font-bold text-amber-600" id="alert-losers">0</p>
            </div>
            <div class="clickable-card p-4 bg-purple-50 rounded-lg border border-purple-200" onclick="showFilteredPlayers('virtual', 'Virtual Phone')">
              <div class="flex justify-between"><span class="text-sm font-medium text-purple-700">Virtual Phone</span><i data-lucide="download" class="h-4 w-4 text-purple-400" onclick="event.stopPropagation(); exportFiltered('virtual', 'virtual_phone')"></i></div>
              <p class="text-2xl font-bold text-purple-600" id="alert-virtual">0</p>
            </div>
          </div>
        </div>
      </div>

      <!-- PLAYERS -->
      <div id="content-players" class="tab-content hidden">
        <div class="bg-white rounded-xl shadow-sm overflow-hidden">
          <div class="px-4 py-3 border-b bg-slate-50">
            <div id="filterBanner" class="hidden mb-3 p-3 bg-amber-50 rounded-lg border border-amber-200">
              <div class="flex items-center justify-between">
                <div class="flex items-center gap-2">
                  <span class="text-sm font-medium text-amber-700">Filtered: <span id="filterName">All</span></span>
                  <span class="text-sm text-amber-600">(<span id="filterCount">0</span> players)</span>
                </div>
                <div class="flex items-center gap-2">
                  <button id="exportFilteredBtn" class="flex items-center gap-1 px-3 py-1 bg-amber-500 text-white text-sm rounded"><i data-lucide="download" class="h-4 w-4"></i> Export</button>
                  <button onclick="clearAllFilters()" class="text-amber-600 text-sm">✕ Clear</button>
                </div>
              </div>
            </div>
            <div class="flex flex-col gap-3">
              <div class="relative">
                <i data-lucide="search" class="h-5 w-5 text-slate-400 absolute left-3 top-1/2 -translate-y-1/2"></i>
                <input type="text" id="searchInput" placeholder="Search by ID or phone..." class="w-full pl-10 pr-4 py-2 border border-slate-200 rounded-lg text-sm"/>
              </div>
              <div class="flex flex-wrap gap-2">
                <select id="profitFilter" class="flex-1 min-w-[100px] px-3 py-2 border border-slate-200 rounded-lg text-sm">
                  <option value="all">All Players</option>
                  <option value="profitable">Profitable</option>
                  <option value="negative_ggr">Negative GGR</option>
                </select>
                <select id="prefFilter" class="flex-1 min-w-[100px] px-3 py-2 border border-slate-200 rounded-lg text-sm">
                  <option value="all">All Prefs</option>
                  <option value="sports">Sports</option>
                  <option value="casino">Casino</option>
                  <option value="mixed">Mixed</option>
                </select>
                <select id="churnFilter" class="flex-1 min-w-[100px] px-3 py-2 border border-slate-200 rounded-lg text-sm">
                  <option value="all">All Risk</option>
                  <option value="low">Low</option>
                  <option value="medium">Medium</option>
                  <option value="high">High</option>
                  <option value="critical">Critical</option>
                </select>
                <button id="clearFiltersBtn" class="px-3 py-2 text-sm text-amber-600 font-medium">Clear</button>
              </div>
              <div class="flex gap-2">
                <button id="refreshBtn" class="flex items-center gap-2 px-3 py-2 bg-slate-100 text-slate-700 rounded-lg text-sm"><i data-lucide="refresh-cw" class="h-4 w-4"></i> Refresh</button>
                <button id="exportAllBtn" class="flex items-center gap-2 px-3 py-2 bg-amber-500 text-black font-medium rounded-lg text-sm"><i data-lucide="download" class="h-4 w-4"></i> Export All</button>
                <button id="editAllBonusesBtn" class="flex items-center gap-2 px-3 py-2 bg-purple-500 text-white font-medium rounded-lg text-sm"><i data-lucide="edit-3" class="h-4 w-4"></i> Edit All Bonuses</button>
              </div>
            </div>
          </div>
          <div class="overflow-x-auto table-scroll">
            <table class="w-full min-w-[1000px]">
              <thead class="bg-slate-50 border-b">
                <tr>
                  <th class="px-3 py-3 text-left text-xs font-semibold text-slate-600">ID / Phone</th>
                  <th class="px-3 py-3 text-left text-xs font-semibold text-slate-600">Type</th>
                  <th class="px-3 py-3 text-left text-xs font-semibold text-slate-600">Preference</th>
                  <th class="px-3 py-3 text-left text-xs font-semibold text-slate-600">Net Revenue</th>
                  <th class="px-3 py-3 text-left text-xs font-semibold text-slate-600">Win Rate</th>
                  <th class="px-3 py-3 text-left text-xs font-semibold text-slate-600">GGR Status</th>
                  <th class="px-3 py-3 text-left text-xs font-semibold text-slate-600">Value</th>
                  <th class="px-3 py-3 text-left text-xs font-semibold text-slate-600">Churn</th>
                  <th class="px-3 py-3 text-left text-xs font-semibold text-slate-600">Bonus</th>
                  <th class="px-3 py-3 text-left text-xs font-semibold text-slate-600">Actions</th>
                </tr>
              </thead>
              <tbody id="tableBody" class="divide-y divide-slate-100"><tr><td colspan="10" class="px-4 py-12 text-center text-slate-500">Loading...</td></tr></tbody>
            </table>
          </div>
          <div class="px-4 py-3 bg-slate-50 border-t text-sm text-slate-500" id="tableFooter">Loading...</div>
        </div>
      </div>

      <!-- SETTINGS -->
      <div id="content-settings" class="tab-content hidden">
        <div class="max-w-4xl mx-auto">
          <h2 class="text-xl font-bold text-slate-800 mb-6">Settings</h2>
          <div class="bg-white rounded-xl shadow-sm overflow-hidden mb-6">
            <div class="px-6 py-4 border-b bg-slate-50"><h3 class="font-bold text-slate-800">Current User</h3></div>
            <div class="p-6"><p class="font-medium text-slate-800" id="settingsUserEmail">Loading...</p></div>
          </div>
          <div class="bg-white rounded-xl shadow-sm overflow-hidden mb-6">
            <div class="px-6 py-4 border-b bg-slate-50"><h3 class="font-bold text-slate-800">Import CSV</h3></div>
            <div class="p-6">
              <label class="block border-2 border-dashed border-slate-300 rounded-xl p-8 text-center cursor-pointer hover:border-amber-400 hover:bg-amber-50">
                <i data-lucide="upload" class="h-12 w-12 text-slate-400 mx-auto mb-3"></i>
                <p class="font-semibold text-slate-700">Click to upload CSV</p>
                <input type="file" accept=".csv" id="csvFileInput" class="hidden"/>
              </label>
              <div id="importProgress" class="hidden mt-4">
                <div class="flex justify-between text-sm mb-1"><span>Importing...</span><span id="importProgressText">0%</span></div>
                <div class="h-2 bg-slate-200 rounded-full"><div id="importProgressBar" class="h-full bg-amber-500 rounded-full" style="width:0%"></div></div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </main>

    <div id="playerModal" class="hidden fixed inset-0 bg-black/60 flex items-center justify-center p-2 sm:p-4 z-50 backdrop-blur-sm">
      <div class="bg-white rounded-2xl shadow-2xl w-full max-w-4xl max-h-[95vh] overflow-hidden flex flex-col">
        <div class="px-4 sm:px-6 py-4 border-b-2 border-amber-400 flex items-center justify-between sticky top-0 bg-gradient-to-r from-slate-900 to-slate-800 z-10">
          <div class="flex items-center gap-3">
            <div class="w-10 h-10 bg-amber-500 rounded-full flex items-center justify-center">
              <i data-lucide="user" class="h-5 w-5 text-black"></i>
            </div>
            <div>
              <h3 class="text-lg font-bold text-white" id="modalPlayerTitle">Player Details</h3>
              <p class="text-xs text-amber-400" id="modalPlayerSubtitle">Loading...</p>
            </div>
          </div>
          <button id="closePlayerModal" class="p-2 text-slate-400 hover:text-white rounded-lg transition-colors"><i data-lucide="x" class="h-6 w-6"></i></button>
        </div>
        <div class="flex-1 overflow-y-auto" id="playerModalContent"></div>
      </div>
    </div>

    <!-- Edit All Bonuses Modal -->
    <div id="editAllBonusesModal" class="hidden fixed inset-0 bg-black/60 flex items-center justify-center p-4 z-50 backdrop-blur-sm">
      <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md overflow-hidden">
        <div class="px-6 py-4 border-b-2 border-purple-400 bg-gradient-to-r from-slate-900 to-slate-800">
          <h3 class="text-lg font-bold text-white flex items-center gap-2"><i data-lucide="settings" class="h-5 w-5 text-purple-400"></i> Edit Default Bonus Amounts</h3>
          <p class="text-xs text-slate-400 mt-1">Set bonus amounts by churn risk level</p>
        </div>
        <div class="p-6 space-y-4">
          <div class="bg-red-50 border border-red-200 rounded-lg p-4">
            <label class="block text-sm font-medium text-red-700 mb-2">Critical Churn Bonus (K)</label>
            <input type="number" id="bonusCritical" value="500" min="0" class="w-full px-3 py-2 border border-red-300 rounded-lg text-lg font-bold text-red-700"/>
          </div>
          <div class="bg-orange-50 border border-orange-200 rounded-lg p-4">
            <label class="block text-sm font-medium text-orange-700 mb-2">High Churn Bonus (K)</label>
            <input type="number" id="bonusHigh" value="100" min="0" class="w-full px-3 py-2 border border-orange-300 rounded-lg text-lg font-bold text-orange-700"/>
          </div>
          <div class="bg-amber-50 border border-amber-200 rounded-lg p-4">
            <label class="block text-sm font-medium text-amber-700 mb-2">Medium Churn Bonus (K)</label>
            <input type="number" id="bonusMedium" value="50" min="0" class="w-full px-3 py-2 border border-amber-300 rounded-lg text-lg font-bold text-amber-700"/>
          </div>
          <div class="bg-emerald-50 border border-emerald-200 rounded-lg p-4">
            <label class="block text-sm font-medium text-emerald-700 mb-2">Low Churn Bonus (K)</label>
            <input type="number" id="bonusLow" value="20" min="0" class="w-full px-3 py-2 border border-emerald-300 rounded-lg text-lg font-bold text-emerald-700"/>
          </div>
        </div>
        <div class="px-6 py-4 bg-slate-50 border-t flex gap-3">
          <button id="cancelBonusEdit" class="flex-1 py-2 px-4 border border-slate-300 rounded-lg text-slate-600 font-medium hover:bg-slate-100">Cancel</button>
          <button id="saveBonusSettings" class="flex-1 py-2 px-4 bg-purple-500 text-white rounded-lg font-medium hover:bg-purple-600">Save & Apply</button>
        </div>
      </div>
    </div>

    <!-- Edit Individual Player Bonus Modal -->
    <div id="editPlayerBonusModal" class="hidden fixed inset-0 bg-black/60 flex items-center justify-center p-4 z-50 backdrop-blur-sm">
      <div class="bg-white rounded-2xl shadow-2xl w-full max-w-sm overflow-hidden">
        <div class="px-6 py-4 border-b-2 border-amber-400 bg-gradient-to-r from-slate-900 to-slate-800">
          <h3 class="text-lg font-bold text-white">Edit Player Bonus</h3>
          <p class="text-xs text-amber-400 mt-1" id="editBonusPlayerInfo">Player #---</p>
        </div>
        <div class="p-6">
          <label class="block text-sm font-medium text-slate-700 mb-2">Bonus Amount (K)</label>
          <input type="number" id="playerBonusInput" min="0" class="w-full px-4 py-3 border border-slate-300 rounded-lg text-2xl font-bold text-center"/>
          <p class="text-xs text-slate-500 mt-2 text-center">Default based on churn: <span id="defaultBonusHint">K0</span></p>
        </div>
        <div class="px-6 py-4 bg-slate-50 border-t flex gap-3">
          <button id="cancelPlayerBonusEdit" class="flex-1 py-2 px-4 border border-slate-300 rounded-lg text-slate-600 font-medium hover:bg-slate-100">Cancel</button>
          <button id="resetPlayerBonus" class="py-2 px-4 border border-amber-300 bg-amber-50 rounded-lg text-amber-600 font-medium hover:bg-amber-100">Reset</button>
          <button id="savePlayerBonus" class="flex-1 py-2 px-4 bg-amber-500 text-black rounded-lg font-medium hover:bg-amber-400">Save</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    var SUPABASE_URL = 'https://blrrcnrhixckfudiojwe.supabase.co';
    var SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJscnJjbnJoaXhja2Z1ZGlvandlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc3Nzg0MzMsImV4cCI6MjA4MzM1NDQzM30.2DGACAZz-f_r0ieYz3hvtsOG1y-3fqTD_ENH2ZR2g1k';
    var App = { db: null, user: null, players: [], currentFilter: null, filteredPlayers: [], mobileMenuOpen: false, bonusSettings: { critical: 500, high: 100, medium: 50, low: 20 }, customBonuses: {} };
    var FIELD_MAP = { 'id': 'id', 'virtual/real phone': 'phone_number', 'referral': 'referral', 'status': 'status', 'registration_date': 'registration_date', 'sport_bet_amount': 'sport_bet_amount', 'sport_bet_count': 'sport_bet_count', 'sport_win_amount': 'sport_win_amount', 'sport_win_count': 'sport_win_count', 'casino_bet_amount': 'casino_bet_amount', 'casino_bet_count': 'casino_bet_count', 'casino_win_amount': 'casino_win_amount', 'casino_win_count': 'casino_win_count', 'total_deposit_amount': 'total_deposit_amount', 'total_withdraw_amount': 'total_withdraw_amount', 'sport_bet_min': 'sport_bet_min', 'sport_bet_max': 'sport_bet_max', 'sport_bet_avg': 'sport_bet_avg', 'casino_bet_min': 'casino_bet_min', 'casino_bet_max': 'casino_bet_max', 'casino_bet_avg': 'casino_bet_avg' };
    var NUMERIC_FIELDS = ['sport_bet_amount', 'sport_bet_count', 'sport_win_amount', 'sport_win_count', 'casino_bet_amount', 'casino_bet_count', 'casino_win_amount', 'casino_win_count', 'total_deposit_amount', 'total_withdraw_amount', 'sport_bet_min', 'sport_bet_max', 'sport_bet_avg', 'casino_bet_min', 'casino_bet_max', 'casino_bet_avg'];
    
    // Load saved bonus settings from localStorage
    function loadBonusSettings() {
      var saved = localStorage.getItem('bwanabet_bonus_settings');
      if (saved) App.bonusSettings = JSON.parse(saved);
      var customSaved = localStorage.getItem('bwanabet_custom_bonuses');
      if (customSaved) App.customBonuses = JSON.parse(customSaved);
    }
    
    function saveBonusSettings() {
      localStorage.setItem('bwanabet_bonus_settings', JSON.stringify(App.bonusSettings));
    }
    
    function saveCustomBonuses() {
      localStorage.setItem('bwanabet_custom_bonuses', JSON.stringify(App.customBonuses));
    }
    
    function getPlayerBonus(player) {
      // Check for custom bonus first
      if (App.customBonuses[player.id] !== undefined) {
        return App.customBonuses[player.id];
      }
      // Return default based on churn risk
      return App.bonusSettings[player.churnRisk] || 0;
    }
    
    function getDefaultBonus(churnRisk) {
      return App.bonusSettings[churnRisk] || 0;
    }

    document.addEventListener('DOMContentLoaded', function() {
      lucide.createIcons();
      loadBonusSettings();
      App.db = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
      document.getElementById('loginBtn').addEventListener('click', handleLogin);
      document.getElementById('loginPassword').addEventListener('keypress', e => { if (e.key === 'Enter') handleLogin(); });
      checkSession();
    });

    async function checkSession() {
      var r = await App.db.auth.getSession();
      if (r.data.session) { App.user = r.data.session.user; showMainApp(); }
      App.db.auth.onAuthStateChange((e, s) => { if (e === 'SIGNED_IN' && s) { App.user = s.user; showMainApp(); } else if (e === 'SIGNED_OUT') { showLoginScreen(); } });
    }

    async function handleLogin() {
      var email = document.getElementById('loginEmail').value.trim(), password = document.getElementById('loginPassword').value;
      if (!email || !password) { document.getElementById('loginError').textContent = 'Enter email and password'; document.getElementById('loginError').classList.remove('hidden'); return; }
      document.getElementById('loginBtn').disabled = true;
      document.getElementById('loginBtn').innerHTML = '<svg class="spinner h-5 w-5" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4" fill="none"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"></path></svg> Signing in...';
      try { var r = await App.db.auth.signInWithPassword({ email, password }); if (r.error) throw r.error; }
      catch (e) { document.getElementById('loginError').textContent = e.message; document.getElementById('loginError').classList.remove('hidden'); document.getElementById('loginBtn').disabled = false; document.getElementById('loginBtn').innerHTML = '<i data-lucide="log-in" class="h-5 w-5"></i> Sign In'; lucide.createIcons(); }
    }

    function showLoginScreen() { document.getElementById('loginScreen').classList.remove('hidden'); document.getElementById('mainApp').classList.add('hidden'); }
    function showMainApp() {
      document.getElementById('loginScreen').classList.add('hidden'); document.getElementById('mainApp').classList.remove('hidden');
      if (App.user) { document.getElementById('userEmail').textContent = App.user.email; document.getElementById('settingsUserEmail').textContent = App.user.email; }
      setupEventListeners(); loadPlayers();
    }

    function setupEventListeners() {
      document.getElementById('logoutBtn').addEventListener('click', () => App.db.auth.signOut());
      document.getElementById('mobileMenuBtn').addEventListener('click', () => { App.mobileMenuOpen = !App.mobileMenuOpen; document.getElementById('mobileMenu').style.maxHeight = App.mobileMenuOpen ? '400px' : '0'; });
      ['dashboard', 'profitability', 'behavior', 'churn', 'players', 'settings'].forEach(t => {
        var el = document.getElementById('tab-' + t); if (el) el.addEventListener('click', () => switchTab(t));
        var mob = document.getElementById('tab-' + t + '-mobile'); if (mob) mob.addEventListener('click', () => { switchTab(t); App.mobileMenuOpen = false; document.getElementById('mobileMenu').style.maxHeight = '0'; });
      });
      document.getElementById('searchInput').addEventListener('input', filterTable);
      document.getElementById('profitFilter').addEventListener('change', filterTable);
      document.getElementById('prefFilter').addEventListener('change', filterTable);
      document.getElementById('churnFilter').addEventListener('change', filterTable);
      document.getElementById('clearFiltersBtn').addEventListener('click', clearAllFilters);
      document.getElementById('refreshBtn').addEventListener('click', loadPlayers);
      document.getElementById('exportAllBtn').addEventListener('click', () => exportData(App.players, 'all_players'));
      document.getElementById('exportFilteredBtn').addEventListener('click', () => exportData(App.filteredPlayers, App.currentFilter || 'filtered'));
      document.getElementById('csvFileInput').addEventListener('change', handleFileUpload);
      document.getElementById('closePlayerModal').addEventListener('click', () => document.getElementById('playerModal').classList.add('hidden'));
      document.getElementById('playerModal').addEventListener('click', function(e) { if (e.target === this) this.classList.add('hidden'); });
      document.addEventListener('keydown', function(e) { 
        if (e.key === 'Escape') {
          document.getElementById('playerModal').classList.add('hidden');
          document.getElementById('editAllBonusesModal').classList.add('hidden');
          document.getElementById('editPlayerBonusModal').classList.add('hidden');
        }
      });
      
      // Edit All Bonuses Modal
      document.getElementById('editAllBonusesBtn').addEventListener('click', openEditAllBonusesModal);
      document.getElementById('cancelBonusEdit').addEventListener('click', () => document.getElementById('editAllBonusesModal').classList.add('hidden'));
      document.getElementById('editAllBonusesModal').addEventListener('click', function(e) { if (e.target === this) this.classList.add('hidden'); });
      document.getElementById('saveBonusSettings').addEventListener('click', saveAllBonusSettings);
      
      // Edit Individual Player Bonus Modal
      document.getElementById('cancelPlayerBonusEdit').addEventListener('click', () => document.getElementById('editPlayerBonusModal').classList.add('hidden'));
      document.getElementById('editPlayerBonusModal').addEventListener('click', function(e) { if (e.target === this) this.classList.add('hidden'); });
      document.getElementById('savePlayerBonus').addEventListener('click', saveIndividualPlayerBonus);
      document.getElementById('resetPlayerBonus').addEventListener('click', resetPlayerBonusToDefault);
      
      lucide.createIcons();
    }
    
    var currentEditingPlayerId = null;
    
    function openEditAllBonusesModal() {
      document.getElementById('bonusCritical').value = App.bonusSettings.critical;
      document.getElementById('bonusHigh').value = App.bonusSettings.high;
      document.getElementById('bonusMedium').value = App.bonusSettings.medium;
      document.getElementById('bonusLow').value = App.bonusSettings.low;
      document.getElementById('editAllBonusesModal').classList.remove('hidden');
      lucide.createIcons();
    }
    
    function saveAllBonusSettings() {
      App.bonusSettings.critical = parseInt(document.getElementById('bonusCritical').value) || 0;
      App.bonusSettings.high = parseInt(document.getElementById('bonusHigh').value) || 0;
      App.bonusSettings.medium = parseInt(document.getElementById('bonusMedium').value) || 0;
      App.bonusSettings.low = parseInt(document.getElementById('bonusLow').value) || 0;
      saveBonusSettings();
      document.getElementById('editAllBonusesModal').classList.add('hidden');
      // Re-render table to show updated bonuses
      if (App.filteredPlayers.length > 0) {
        renderTable(App.filteredPlayers);
      } else {
        renderTable(App.players);
      }
      showNotification('Bonus settings saved!', 'success');
    }
    
    window.editPlayerBonus = function(playerId) {
      var player = App.players.find(p => String(p.id) === String(playerId));
      if (!player) return;
      
      currentEditingPlayerId = playerId;
      var currentBonus = getPlayerBonus(player);
      var defaultBonus = getDefaultBonus(player.churnRisk);
      
      document.getElementById('editBonusPlayerInfo').textContent = 'Player #' + playerId + ' • ' + player.churnRisk + ' churn risk';
      document.getElementById('playerBonusInput').value = currentBonus;
      document.getElementById('defaultBonusHint').textContent = 'K' + defaultBonus;
      document.getElementById('editPlayerBonusModal').classList.remove('hidden');
    };
    
    function saveIndividualPlayerBonus() {
      if (!currentEditingPlayerId) return;
      var newBonus = parseInt(document.getElementById('playerBonusInput').value) || 0;
      App.customBonuses[currentEditingPlayerId] = newBonus;
      saveCustomBonuses();
      document.getElementById('editPlayerBonusModal').classList.add('hidden');
      // Re-render table
      if (App.filteredPlayers.length > 0) {
        renderTable(App.filteredPlayers);
      } else {
        renderTable(App.players);
      }
      showNotification('Bonus for player #' + currentEditingPlayerId + ' set to K' + newBonus, 'success');
      currentEditingPlayerId = null;
    }
    
    function resetPlayerBonusToDefault() {
      if (!currentEditingPlayerId) return;
      var player = App.players.find(p => String(p.id) === String(currentEditingPlayerId));
      if (!player) return;
      
      delete App.customBonuses[currentEditingPlayerId];
      saveCustomBonuses();
      document.getElementById('playerBonusInput').value = getDefaultBonus(player.churnRisk);
      document.getElementById('editPlayerBonusModal').classList.add('hidden');
      // Re-render table
      if (App.filteredPlayers.length > 0) {
        renderTable(App.filteredPlayers);
      } else {
        renderTable(App.players);
      }
      showNotification('Bonus for player #' + currentEditingPlayerId + ' reset to default', 'success');
      currentEditingPlayerId = null;
    }

    async function loadPlayers() {
      showLoading(true, 'Loading players...');
      try {
        // Supabase returns max 1000 rows by default, so we need to paginate
        var allPlayers = [];
        var pageSize = 1000;
        var from = 0;
        var hasMore = true;
        
        while (hasMore) {
          document.getElementById('loadingText').textContent = 'Loading players... ' + allPlayers.length.toLocaleString();
          
          var r = await App.db
            .from('customers')
            .select('*')
            .order('id', { ascending: true })
            .range(from, from + pageSize - 1);
          
          if (r.error) throw r.error;
          
          if (r.data && r.data.length > 0) {
            allPlayers = allPlayers.concat(r.data);
            from += pageSize;
            hasMore = r.data.length === pageSize;
          } else {
            hasMore = false;
          }
        }
        
        console.log('Total players loaded:', allPlayers.length);
        
        App.players = allPlayers.map(processPlayer);
        document.getElementById('statusDot').className = 'w-2 h-2 rounded-full bg-emerald-400';
        document.getElementById('statusText').textContent = 'Connected';
        updateStats(); 
        renderTable(App.players);
        showNotification('Loaded ' + App.players.length.toLocaleString() + ' players', 'success');
      } catch (e) { 
        console.error('Load error:', e);
        document.getElementById('statusDot').className = 'w-2 h-2 rounded-full bg-red-400'; 
        showNotification('Error: ' + e.message, 'error'); 
      }
      finally { showLoading(false); }
    }

    function processPlayer(p) {
      var sportBet = parseFloat(p.sport_bet_amount) || 0, sportWin = parseFloat(p.sport_win_amount) || 0;
      var casinoBet = parseFloat(p.casino_bet_amount) || 0, casinoWin = parseFloat(p.casino_win_amount) || 0;
      var totalBet = sportBet + casinoBet, totalWin = sportWin + casinoWin;
      var totalBetCount = (parseInt(p.sport_bet_count) || 0) + (parseInt(p.casino_bet_count) || 0);
      var totalWinCount = (parseInt(p.sport_win_count) || 0) + (parseInt(p.casino_win_count) || 0);
      var deposits = parseFloat(p.total_deposit_amount) || 0, withdrawals = parseFloat(p.total_withdraw_amount) || 0;
      var netRevenue = deposits - withdrawals;
      var winRate = totalBetCount > 0 ? (totalWinCount / totalBetCount * 100) : 0;
      var avgBet = totalBetCount > 0 ? (totalBet / totalBetCount) : 0;
      var companyProfit = totalBet - totalWin;
      var isProfitable = totalBet > totalWin && totalBetCount > 0;
      var isNegativeGGR = totalWin > totalBet;
      var phoneType = (p.phone_type || '').toLowerCase() === 'virtual' || (p.phone_number || '').toLowerCase().includes('virtual') ? 'virtual' : 'real';
      var sportPct = totalBet > 0 ? (sportBet / totalBet * 100) : 0;
      var preference = sportPct > 70 ? 'sports' : (sportPct < 30 ? 'casino' : 'mixed');
      var valueSegment = netRevenue >= 5000 ? 'vip' : (netRevenue >= 1000 ? 'high' : (netRevenue >= 100 ? 'medium' : 'low'));
      var bettingStyle = avgBet >= 100 ? 'highroller' : (avgBet >= 10 ? 'regular' : 'casual');
      var regDate = p.registration_date ? new Date(p.registration_date) : null;
      var daysSinceReg = regDate && !isNaN(regDate) ? Math.floor((new Date() - regDate) / 86400000) : 999;
      var churnRisk = daysSinceReg < 7 ? 'low' : (daysSinceReg < 14 ? 'medium' : (daysSinceReg < 30 ? 'high' : 'critical'));
      var lifecycle = daysSinceReg < 30 ? 'new' : (daysSinceReg < 90 ? 'growing' : (daysSinceReg < 180 ? 'mature' : (daysSinceReg < 270 ? 'declining' : (daysSinceReg < 365 ? 'dormant' : 'churned'))));
      return { ...p, totalBet, totalWin, totalBetCount, totalWinCount, netRevenue, winRate, avgBet, companyProfit, isProfitable, isNegativeGGR, phoneType, preference, valueSegment, bettingStyle, daysSinceReg, churnRisk, lifecycle, isWithdrawing: withdrawals > deposits };
    }

    function getFiltered(type) {
      switch(type) {
        case 'profitable': return App.players.filter(p => p.isProfitable);
        case 'negative_ggr': return App.players.filter(p => p.isNegativeGGR);
        case 'atrisk': return App.players.filter(p => p.churnRisk === 'high' || p.churnRisk === 'critical');
        case 'pref_sports': return App.players.filter(p => p.preference === 'sports');
        case 'pref_casino': return App.players.filter(p => p.preference === 'casino');
        case 'pref_mixed': return App.players.filter(p => p.preference === 'mixed');
        case 'value_vip': return App.players.filter(p => p.valueSegment === 'vip');
        case 'value_high': return App.players.filter(p => p.valueSegment === 'high');
        case 'value_medium': return App.players.filter(p => p.valueSegment === 'medium');
        case 'value_low': return App.players.filter(p => p.valueSegment === 'low');
        case 'churn_low': return App.players.filter(p => p.churnRisk === 'low');
        case 'churn_medium': return App.players.filter(p => p.churnRisk === 'medium');
        case 'churn_high': return App.players.filter(p => p.churnRisk === 'high');
        case 'churn_critical': return App.players.filter(p => p.churnRisk === 'critical');
        case 'withdrawing': return App.players.filter(p => p.isWithdrawing);
        case 'biglosers': return App.players.filter(p => p.winRate < 40 && p.totalBetCount > 10);
        case 'virtual': return App.players.filter(p => p.phoneType === 'virtual');
        case 'style_highroller': return App.players.filter(p => p.bettingStyle === 'highroller');
        case 'style_regular': return App.players.filter(p => p.bettingStyle === 'regular');
        case 'style_casual': return App.players.filter(p => p.bettingStyle === 'casual');
        case 'life_new': return App.players.filter(p => p.lifecycle === 'new');
        case 'life_growing': return App.players.filter(p => p.lifecycle === 'growing');
        case 'life_mature': return App.players.filter(p => p.lifecycle === 'mature');
        case 'life_declining': return App.players.filter(p => p.lifecycle === 'declining');
        case 'life_dormant': return App.players.filter(p => p.lifecycle === 'dormant');
        case 'life_churned': return App.players.filter(p => p.lifecycle === 'churned');
        case 'wr_0_25': return App.players.filter(p => p.winRate < 25 && p.totalBetCount > 0);
        case 'wr_25_40': return App.players.filter(p => p.winRate >= 25 && p.winRate < 40);
        case 'wr_40_50': return App.players.filter(p => p.winRate >= 40 && p.winRate < 50);
        case 'wr_50_plus': return App.players.filter(p => p.winRate >= 50 && p.totalBetCount > 0);
        default: return App.players;
      }
    }

    window.showFilteredPlayers = function(type, name) {
      App.currentFilter = type; App.filteredPlayers = getFiltered(type);
      switchTab('players');
      document.getElementById('filterBanner').classList.remove('hidden');
      document.getElementById('filterName').textContent = name;
      document.getElementById('filterCount').textContent = App.filteredPlayers.length;
      renderTable(App.filteredPlayers);
    };

    window.showAllPlayers = function() { clearAllFilters(); switchTab('players'); };
    window.exportFiltered = function(type, filename) { exportData(getFiltered(type), filename); };

    function filterTable() {
      var search = document.getElementById('searchInput').value.toLowerCase();
      var profit = document.getElementById('profitFilter').value;
      var pref = document.getElementById('prefFilter').value;
      var churn = document.getElementById('churnFilter').value;
      var base = App.currentFilter ? App.filteredPlayers : App.players;
      var filtered = base.filter(p => {
        var matchSearch = !search || (p.id && String(p.id).toLowerCase().includes(search)) || (p.phone_number && p.phone_number.toLowerCase().includes(search));
        var matchProfit = profit === 'all' || (profit === 'profitable' && p.isProfitable) || (profit === 'negative_ggr' && p.isNegativeGGR);
        var matchPref = pref === 'all' || p.preference === pref;
        var matchChurn = churn === 'all' || p.churnRisk === churn;
        return matchSearch && matchProfit && matchPref && matchChurn;
      });
      renderTable(filtered);
    }

    function clearAllFilters() {
      App.currentFilter = null; App.filteredPlayers = [];
      document.getElementById('filterBanner').classList.add('hidden');
      document.getElementById('searchInput').value = '';
      document.getElementById('profitFilter').value = 'all';
      document.getElementById('prefFilter').value = 'all';
      document.getElementById('churnFilter').value = 'all';
      renderTable(App.players);
    }

    function updateStats() {
      var s = { total: App.players.length, deposits: 0, withdrawals: 0, profitable: 0, profitAmount: 0, negativeGGR: 0, negativeGGRAmount: 0, prefSports: 0, prefCasino: 0, prefMixed: 0, segVip: 0, segHigh: 0, segMedium: 0, segLow: 0, churnLow: 0, churnMedium: 0, churnHigh: 0, churnCritical: 0, styleHigh: 0, styleReg: 0, styleCasual: 0, lifeNew: 0, lifeGrowing: 0, lifeMature: 0, lifeDeclining: 0, lifeDormant: 0, lifeChurned: 0, withdrawing: 0, losers: 0, virtual: 0, wr0: 0, wr25: 0, wr40: 0, wr50: 0 };
      App.players.forEach(p => {
        s.deposits += parseFloat(p.total_deposit_amount) || 0; s.withdrawals += parseFloat(p.total_withdraw_amount) || 0;
        if (p.isProfitable) { s.profitable++; s.profitAmount += p.companyProfit; }
        if (p.isNegativeGGR) { s.negativeGGR++; s.negativeGGRAmount += Math.abs(p.companyProfit); }
        if (p.preference === 'sports') s.prefSports++; else if (p.preference === 'casino') s.prefCasino++; else s.prefMixed++;
        if (p.valueSegment === 'vip') s.segVip++; else if (p.valueSegment === 'high') s.segHigh++; else if (p.valueSegment === 'medium') s.segMedium++; else s.segLow++;
        if (p.churnRisk === 'low') s.churnLow++; else if (p.churnRisk === 'medium') s.churnMedium++; else if (p.churnRisk === 'high') s.churnHigh++; else s.churnCritical++;
        if (p.bettingStyle === 'highroller') s.styleHigh++; else if (p.bettingStyle === 'regular') s.styleReg++; else s.styleCasual++;
        if (p.lifecycle === 'new') s.lifeNew++; else if (p.lifecycle === 'growing') s.lifeGrowing++; else if (p.lifecycle === 'mature') s.lifeMature++; else if (p.lifecycle === 'declining') s.lifeDeclining++; else if (p.lifecycle === 'dormant') s.lifeDormant++; else s.lifeChurned++;
        if (p.isWithdrawing) s.withdrawing++; if (p.winRate < 40 && p.totalBetCount > 10) s.losers++; if (p.phoneType === 'virtual') s.virtual++;
        if (p.totalBetCount > 0) { if (p.winRate < 25) s.wr0++; else if (p.winRate < 40) s.wr25++; else if (p.winRate < 50) s.wr40++; else s.wr50++; }
      });
      setText('metric-total', s.total); setText('metric-profitable', s.profitable); setText('metric-negative-ggr', s.negativeGGR); setText('metric-atrisk', s.churnHigh + s.churnCritical);
      setText('fin-deposits', 'K' + s.deposits.toLocaleString()); setText('fin-withdrawals', 'K' + s.withdrawals.toLocaleString()); setText('fin-net', 'K' + (s.deposits - s.withdrawals).toLocaleString());
      setText('pref-sports', s.prefSports); setText('pref-casino', s.prefCasino); setText('pref-mixed', s.prefMixed);
      setText('seg-vip', s.segVip); setText('seg-high', s.segHigh); setText('seg-medium', s.segMedium); setText('seg-low', s.segLow);
      setText('churn-low', s.churnLow); setText('churn-medium', s.churnMedium); setText('churn-high', s.churnHigh); setText('churn-critical', s.churnCritical);
      setText('churn-d-low', s.churnLow); setText('churn-d-medium', s.churnMedium); setText('churn-d-high', s.churnHigh); setText('churn-d-critical', s.churnCritical);
      setText('profit-count', s.profitable); setText('profit-amount', 'K' + s.profitAmount.toLocaleString()); setText('negative-ggr-count', s.negativeGGR); setText('negative-ggr-amount', 'K' + s.negativeGGRAmount.toLocaleString());
      setText('wr-0-25', s.wr0); setText('wr-25-40', s.wr25); setText('wr-40-50', s.wr40); setText('wr-50-plus', s.wr50);
      setText('style-highroller', s.styleHigh); setText('style-regular', s.styleReg); setText('style-casual', s.styleCasual);
      setText('life-new', s.lifeNew); setText('life-growing', s.lifeGrowing); setText('life-mature', s.lifeMature); setText('life-declining', s.lifeDeclining); setText('life-dormant', s.lifeDormant); setText('life-churned', s.lifeChurned);
      setText('alert-withdrawing', s.withdrawing); setText('alert-losers', s.losers); setText('alert-virtual', s.virtual);
      lucide.createIcons();
    }

    function renderTable(data) {
      var tbody = document.getElementById('tableBody');
      if (!data.length) { 
        tbody.innerHTML = '<tr><td colspan="10" class="px-4 py-12 text-center text-slate-500">No players</td></tr>'; 
        document.getElementById('tableFooter').textContent = '0 players'; 
        return; 
      }
      
      // Show first 500 for performance (can scroll/filter to find more)
      var maxDisplay = 500;
      var displayed = data.slice(0, maxDisplay);
      
      tbody.innerHTML = displayed.map(p => {
        var churnC = { low: 'emerald', medium: 'amber', high: 'orange', critical: 'red' }[p.churnRisk];
        var prefC = { sports: 'green', casino: 'purple', mixed: 'blue' }[p.preference];
        var valueC = { vip: 'purple', high: 'blue', medium: 'teal', low: 'slate' }[p.valueSegment];
        var ggrBadge = p.isProfitable ? '<span class="text-xs px-2 py-1 rounded-full bg-emerald-100 text-emerald-700">Profitable</span>' : (p.isNegativeGGR ? '<span class="text-xs px-2 py-1 rounded-full bg-red-100 text-red-700">Negative GGR</span>' : '<span class="text-xs px-2 py-1 rounded-full bg-slate-100 text-slate-600">-</span>');
        var bonus = getPlayerBonus(p);
        var isCustomBonus = App.customBonuses[p.id] !== undefined;
        var bonusDisplay = '<span class="font-medium text-purple-700">K' + bonus.toLocaleString() + '</span>' + (isCustomBonus ? '<span class="ml-1 text-xs text-purple-400">*</span>' : '');
        return '<tr class="hover:bg-amber-50 cursor-pointer transition-colors" onclick="viewPlayer(\'' + p.id + '\')"><td class="px-3 py-3"><p class="font-medium text-sm">' + p.id + '</p><p class="text-xs text-slate-500">' + (p.phone_number || '-') + '</p></td><td class="px-3 py-3"><span class="text-xs px-2 py-1 rounded-full ' + (p.phoneType === 'virtual' ? 'bg-red-100 text-red-700' : 'bg-slate-100 text-slate-600') + '">' + p.phoneType + '</span></td><td class="px-3 py-3"><span class="text-xs px-2 py-1 rounded-full bg-' + prefC + '-100 text-' + prefC + '-700">' + p.preference + '</span></td><td class="px-3 py-3"><span class="font-medium ' + (p.netRevenue >= 0 ? 'text-emerald-600' : 'text-red-600') + '">K' + p.netRevenue.toLocaleString() + '</span></td><td class="px-3 py-3">' + p.winRate.toFixed(1) + '%</td><td class="px-3 py-3">' + ggrBadge + '</td><td class="px-3 py-3"><span class="text-xs px-2 py-1 rounded-full bg-' + valueC + '-100 text-' + valueC + '-700">' + p.valueSegment.toUpperCase() + '</span></td><td class="px-3 py-3"><span class="text-xs px-2 py-1 rounded-full bg-' + churnC + '-100 text-' + churnC + '-700">' + p.churnRisk + '</span></td><td class="px-3 py-3">' + bonusDisplay + '<button onclick="event.stopPropagation(); editPlayerBonus(\'' + p.id + '\')" class="ml-2 p-1 text-purple-400 hover:text-purple-600 hover:bg-purple-100 rounded transition-colors"><i data-lucide="edit-2" class="h-3 w-3"></i></button></td><td class="px-3 py-3"><button onclick="event.stopPropagation(); viewPlayer(\'' + p.id + '\')" class="p-1.5 text-amber-500 hover:text-amber-600 hover:bg-amber-100 rounded transition-colors"><i data-lucide="eye" class="h-4 w-4"></i></button></td></tr>';
      }).join('');
      
      var footerText = 'Showing ' + displayed.length.toLocaleString() + ' of ' + data.length.toLocaleString() + ' players';
      if (data.length > maxDisplay) {
        footerText += ' (use search/filters to find specific players, or export for full list)';
      }
      document.getElementById('tableFooter').textContent = footerText;
      lucide.createIcons();
    }

    window.viewPlayer = function(id) {
      var p = App.players.find(x => String(x.id) === String(id)); if (!p) return;
      
      // Calculate additional analytics
      var sportBetAmt = parseFloat(p.sport_bet_amount) || 0;
      var sportWinAmt = parseFloat(p.sport_win_amount) || 0;
      var casinoBetAmt = parseFloat(p.casino_bet_amount) || 0;
      var casinoWinAmt = parseFloat(p.casino_win_amount) || 0;
      var sportBetCount = parseInt(p.sport_bet_count) || 0;
      var sportWinCount = parseInt(p.sport_win_count) || 0;
      var casinoBetCount = parseInt(p.casino_bet_count) || 0;
      var casinoWinCount = parseInt(p.casino_win_count) || 0;
      var deposits = parseFloat(p.total_deposit_amount) || 0;
      var withdrawals = parseFloat(p.total_withdraw_amount) || 0;
      
      // Calculate sport/casino specific win rates
      var sportWinRate = sportBetCount > 0 ? (sportWinCount / sportBetCount * 100) : 0;
      var casinoWinRate = casinoBetCount > 0 ? (casinoWinCount / casinoBetCount * 100) : 0;
      
      // Calculate ROI for the company
      var sportROI = sportBetAmt > 0 ? ((sportBetAmt - sportWinAmt) / sportBetAmt * 100) : 0;
      var casinoROI = casinoBetAmt > 0 ? ((casinoBetAmt - casinoWinAmt) / casinoBetAmt * 100) : 0;
      
      // Calculate betting preference percentage
      var totalBetAmt = sportBetAmt + casinoBetAmt;
      var sportPct = totalBetAmt > 0 ? (sportBetAmt / totalBetAmt * 100) : 0;
      var casinoPct = totalBetAmt > 0 ? (casinoBetAmt / totalBetAmt * 100) : 0;
      
      // Generate insights
      var insights = [];
      if (p.isNegativeGGR) insights.push({type: 'danger', icon: 'alert-triangle', text: 'Negative GGR - Player is winning more than losing. Review betting patterns for potential advantage play.'});
      if (p.isProfitable && p.companyProfit > 1000) insights.push({type: 'success', icon: 'trending-up', text: 'High-value profitable player. Consider loyalty rewards to maintain engagement.'});
      if (p.churnRisk === 'critical') insights.push({type: 'danger', icon: 'user-x', text: 'Critical churn risk! Last activity over 30 days ago. Immediate re-engagement recommended.'});
      if (p.churnRisk === 'high') insights.push({type: 'warning', icon: 'clock', text: 'High churn risk. Consider sending promotional offers or bonuses.'});
      if (p.isWithdrawing) insights.push({type: 'warning', icon: 'arrow-up-right', text: 'Withdrawing player - Withdrawals exceed deposits. May indicate cashing out winnings.'});
      if (p.phoneType === 'virtual') insights.push({type: 'info', icon: 'smartphone', text: 'Virtual phone number detected. May indicate multi-accounting or fraud risk.'});
      if (p.valueSegment === 'vip') insights.push({type: 'success', icon: 'crown', text: 'VIP player with K5,000+ net revenue. High priority for retention.'});
      if (p.winRate > 55 && p.totalBetCount > 20) insights.push({type: 'warning', icon: 'eye', text: 'Unusually high win rate (' + p.winRate.toFixed(1) + '%). Monitor for suspicious activity.'});
      if (p.bettingStyle === 'highroller') insights.push({type: 'info', icon: 'dollar-sign', text: 'High roller with average bet over K100. VIP treatment recommended.'});
      if (p.lifecycle === 'new' && deposits > 500) insights.push({type: 'success', icon: 'star', text: 'New high-depositing player. Nurture for long-term value.'});
      if (p.lifecycle === 'declining') insights.push({type: 'warning', icon: 'trending-down', text: 'Player in declining lifecycle stage. Engagement declining over time.'});
      
      // Status badges
      var ggrBadge = p.isProfitable ? '<span class="px-3 py-1 bg-emerald-500 text-white rounded-full text-sm font-medium">Profitable</span>' : (p.isNegativeGGR ? '<span class="px-3 py-1 bg-red-500 text-white rounded-full text-sm font-medium">Negative GGR</span>' : '<span class="px-3 py-1 bg-slate-200 text-slate-600 rounded-full text-sm font-medium">Neutral</span>');
      var churnBadge = {
        low: '<span class="px-3 py-1 bg-emerald-100 text-emerald-700 rounded-full text-sm">Low Risk</span>',
        medium: '<span class="px-3 py-1 bg-amber-100 text-amber-700 rounded-full text-sm">Medium Risk</span>',
        high: '<span class="px-3 py-1 bg-orange-100 text-orange-700 rounded-full text-sm">High Risk</span>',
        critical: '<span class="px-3 py-1 bg-red-100 text-red-700 rounded-full text-sm">Critical</span>'
      }[p.churnRisk];
      var valueBadge = {
        vip: '<span class="px-3 py-1 bg-purple-500 text-white rounded-full text-sm font-medium">👑 VIP</span>',
        high: '<span class="px-3 py-1 bg-blue-100 text-blue-700 rounded-full text-sm">High Value</span>',
        medium: '<span class="px-3 py-1 bg-teal-100 text-teal-700 rounded-full text-sm">Medium Value</span>',
        low: '<span class="px-3 py-1 bg-slate-100 text-slate-600 rounded-full text-sm">Low Value</span>'
      }[p.valueSegment];
      
      // Update modal header
      document.getElementById('modalPlayerTitle').textContent = 'Player #' + p.id;
      document.getElementById('modalPlayerSubtitle').textContent = (p.lifecycle.charAt(0).toUpperCase() + p.lifecycle.slice(1)) + ' • ' + p.preference.charAt(0).toUpperCase() + p.preference.slice(1) + ' • Registered ' + (p.registration_date || 'Unknown');
      
      // Build comprehensive modal content
      var html = '<div class="p-4 sm:p-6 space-y-6">';
      
      // Status badges row
      html += '<div class="flex flex-wrap gap-2">' + ggrBadge + ' ' + valueBadge + ' ' + churnBadge + '</div>';
      
      // AI Insights Section
      if (insights.length > 0) {
        html += '<div class="bg-gradient-to-r from-slate-900 to-slate-800 rounded-xl p-4 space-y-3">';
        html += '<h4 class="font-bold text-amber-400 flex items-center gap-2"><i data-lucide="lightbulb" class="h-5 w-5"></i> CRM Insights</h4>';
        insights.forEach(function(insight) {
          var bgColor = {danger: 'bg-red-500/20 border-red-500/30 text-red-200', warning: 'bg-amber-500/20 border-amber-500/30 text-amber-200', success: 'bg-emerald-500/20 border-emerald-500/30 text-emerald-200', info: 'bg-blue-500/20 border-blue-500/30 text-blue-200'}[insight.type];
          html += '<div class="flex items-start gap-3 p-3 rounded-lg border ' + bgColor + '"><i data-lucide="' + insight.icon + '" class="h-5 w-5 flex-shrink-0 mt-0.5"></i><span class="text-sm">' + insight.text + '</span></div>';
        });
        html += '</div>';
      }
      
      // Player Info Grid
      html += '<div class="grid grid-cols-2 sm:grid-cols-4 gap-4">';
      html += '<div class="bg-slate-50 rounded-lg p-4"><p class="text-xs text-slate-500 uppercase tracking-wide">Phone</p><p class="font-semibold text-slate-800 mt-1">' + (p.phone_number || 'Not provided') + '</p><span class="inline-block mt-1 text-xs px-2 py-0.5 rounded ' + (p.phoneType === 'virtual' ? 'bg-red-100 text-red-700' : 'bg-slate-200 text-slate-600') + '">' + p.phoneType + '</span></div>';
      html += '<div class="bg-slate-50 rounded-lg p-4"><p class="text-xs text-slate-500 uppercase tracking-wide">Status</p><p class="font-semibold text-slate-800 mt-1">' + (p.status || 'Active') + '</p></div>';
      html += '<div class="bg-slate-50 rounded-lg p-4"><p class="text-xs text-slate-500 uppercase tracking-wide">Referral</p><p class="font-semibold text-slate-800 mt-1">' + (p.referral || 'None') + '</p></div>';
      html += '<div class="bg-slate-50 rounded-lg p-4"><p class="text-xs text-slate-500 uppercase tracking-wide">Days Since Registration</p><p class="font-semibold text-slate-800 mt-1">' + p.daysSinceReg + ' days</p></div>';
      html += '</div>';
      
      // Financial Overview
      html += '<div class="bg-white border rounded-xl overflow-hidden">';
      html += '<div class="bg-slate-100 px-4 py-3 border-b"><h4 class="font-bold text-slate-800 flex items-center gap-2"><i data-lucide="wallet" class="h-5 w-5 text-slate-600"></i> Financial Overview</h4></div>';
      html += '<div class="p-4 grid grid-cols-1 sm:grid-cols-3 gap-4">';
      html += '<div class="bg-emerald-50 border border-emerald-200 rounded-lg p-4 text-center"><p class="text-xs text-emerald-600 uppercase">Total Deposits</p><p class="text-2xl font-bold text-emerald-700 mt-1">K' + deposits.toLocaleString() + '</p></div>';
      html += '<div class="bg-red-50 border border-red-200 rounded-lg p-4 text-center"><p class="text-xs text-red-600 uppercase">Total Withdrawals</p><p class="text-2xl font-bold text-red-700 mt-1">K' + withdrawals.toLocaleString() + '</p></div>';
      html += '<div class="bg-blue-50 border border-blue-200 rounded-lg p-4 text-center"><p class="text-xs text-blue-600 uppercase">Net Revenue</p><p class="text-2xl font-bold ' + (p.netRevenue >= 0 ? 'text-blue-700' : 'text-red-700') + ' mt-1">K' + p.netRevenue.toLocaleString() + '</p></div>';
      html += '</div>';
      // Deposit vs Withdrawal bar
      var depPct = (deposits + withdrawals) > 0 ? (deposits / (deposits + withdrawals) * 100) : 50;
      html += '<div class="px-4 pb-4"><p class="text-xs text-slate-500 mb-2">Deposit vs Withdrawal Ratio</p><div class="h-4 rounded-full overflow-hidden flex bg-slate-200"><div class="bg-emerald-500 transition-all" style="width: ' + depPct + '%"></div><div class="bg-red-500 flex-1"></div></div><div class="flex justify-between text-xs text-slate-500 mt-1"><span>Deposits: ' + depPct.toFixed(1) + '%</span><span>Withdrawals: ' + (100 - depPct).toFixed(1) + '%</span></div></div>';
      html += '</div>';
      
      // Company Profit
      html += '<div class="bg-gradient-to-r ' + (p.companyProfit >= 0 ? 'from-emerald-500 to-emerald-600' : 'from-red-500 to-red-600') + ' rounded-xl p-6 text-white">';
      html += '<div class="flex items-center justify-between"><div><p class="text-sm opacity-90">Company GGR from this Player</p><p class="text-4xl font-bold mt-1">K' + p.companyProfit.toLocaleString() + '</p></div><i data-lucide="' + (p.companyProfit >= 0 ? 'trending-up' : 'trending-down') + '" class="h-12 w-12 opacity-50"></i></div>';
      html += '</div>';
      
      // Bonus Section
      var playerBonus = getPlayerBonus(p);
      var isCustom = App.customBonuses[p.id] !== undefined;
      var defaultBonus = getDefaultBonus(p.churnRisk);
      html += '<div class="bg-gradient-to-r from-purple-500 to-purple-600 rounded-xl p-6 text-white">';
      html += '<div class="flex items-center justify-between"><div><p class="text-sm opacity-90">Allocated Bonus' + (isCustom ? ' <span class="text-purple-200">(Custom)</span>' : ' <span class="text-purple-200">(Based on ' + p.churnRisk + ' churn)</span>') + '</p><p class="text-4xl font-bold mt-1">K' + playerBonus.toLocaleString() + '</p></div>';
      html += '<button onclick="editPlayerBonus(\'' + p.id + '\')" class="flex items-center gap-2 px-4 py-2 bg-white/20 rounded-lg hover:bg-white/30 transition-colors"><i data-lucide="edit-2" class="h-5 w-5"></i> Edit</button></div>';
      if (isCustom) html += '<p class="text-xs text-purple-200 mt-2">Default bonus for ' + p.churnRisk + ' churn: K' + defaultBonus + '</p>';
      html += '</div>';
      
      // Betting Activity Section
      html += '<div class="bg-white border rounded-xl overflow-hidden">';
      html += '<div class="bg-slate-100 px-4 py-3 border-b"><h4 class="font-bold text-slate-800 flex items-center gap-2"><i data-lucide="bar-chart-3" class="h-5 w-5 text-slate-600"></i> Betting Activity</h4></div>';
      html += '<div class="p-4">';
      
      // Preference bar
      html += '<div class="mb-6"><p class="text-sm font-medium text-slate-700 mb-2">Betting Preference Distribution</p><div class="h-6 rounded-full overflow-hidden flex bg-slate-200">';
      html += '<div class="bg-green-500 flex items-center justify-center text-xs text-white font-medium transition-all" style="width: ' + sportPct + '%">' + (sportPct > 15 ? sportPct.toFixed(0) + '% Sports' : '') + '</div>';
      html += '<div class="bg-purple-500 flex items-center justify-center text-xs text-white font-medium flex-1">' + (casinoPct > 15 ? casinoPct.toFixed(0) + '% Casino' : '') + '</div>';
      html += '</div></div>';
      
      // Sports vs Casino breakdown
      html += '<div class="grid grid-cols-1 sm:grid-cols-2 gap-4">';
      
      // Sports Card
      html += '<div class="bg-green-50 border border-green-200 rounded-xl p-4">';
      html += '<div class="flex items-center gap-2 mb-3"><div class="w-8 h-8 bg-green-500 rounded-lg flex items-center justify-center"><i data-lucide="trophy" class="h-4 w-4 text-white"></i></div><h5 class="font-bold text-green-800">Sports Betting</h5></div>';
      html += '<div class="space-y-2 text-sm">';
      html += '<div class="flex justify-between"><span class="text-green-600">Total Bet</span><span class="font-semibold text-green-800">K' + sportBetAmt.toLocaleString() + '</span></div>';
      html += '<div class="flex justify-between"><span class="text-green-600">Total Won</span><span class="font-semibold text-green-800">K' + sportWinAmt.toLocaleString() + '</span></div>';
      html += '<div class="flex justify-between"><span class="text-green-600">Net (Company)</span><span class="font-semibold ' + ((sportBetAmt - sportWinAmt) >= 0 ? 'text-emerald-700' : 'text-red-600') + '">K' + (sportBetAmt - sportWinAmt).toLocaleString() + '</span></div>';
      html += '<hr class="border-green-200">';
      html += '<div class="flex justify-between"><span class="text-green-600">Bet Count</span><span class="font-semibold text-green-800">' + sportBetCount.toLocaleString() + '</span></div>';
      html += '<div class="flex justify-between"><span class="text-green-600">Win Count</span><span class="font-semibold text-green-800">' + sportWinCount.toLocaleString() + '</span></div>';
      html += '<div class="flex justify-between"><span class="text-green-600">Win Rate</span><span class="font-semibold text-green-800">' + sportWinRate.toFixed(1) + '%</span></div>';
      html += '<hr class="border-green-200">';
      html += '<div class="flex justify-between"><span class="text-green-600">Min Bet</span><span class="font-semibold text-green-800">K' + (parseFloat(p.sport_bet_min) || 0).toLocaleString() + '</span></div>';
      html += '<div class="flex justify-between"><span class="text-green-600">Max Bet</span><span class="font-semibold text-green-800">K' + (parseFloat(p.sport_bet_max) || 0).toLocaleString() + '</span></div>';
      html += '<div class="flex justify-between"><span class="text-green-600">Avg Bet</span><span class="font-semibold text-green-800">K' + (parseFloat(p.sport_bet_avg) || 0).toFixed(2) + '</span></div>';
      html += '</div></div>';
      
      // Casino Card
      html += '<div class="bg-purple-50 border border-purple-200 rounded-xl p-4">';
      html += '<div class="flex items-center gap-2 mb-3"><div class="w-8 h-8 bg-purple-500 rounded-lg flex items-center justify-center"><i data-lucide="diamond" class="h-4 w-4 text-white"></i></div><h5 class="font-bold text-purple-800">Casino Gaming</h5></div>';
      html += '<div class="space-y-2 text-sm">';
      html += '<div class="flex justify-between"><span class="text-purple-600">Total Bet</span><span class="font-semibold text-purple-800">K' + casinoBetAmt.toLocaleString() + '</span></div>';
      html += '<div class="flex justify-between"><span class="text-purple-600">Total Won</span><span class="font-semibold text-purple-800">K' + casinoWinAmt.toLocaleString() + '</span></div>';
      html += '<div class="flex justify-between"><span class="text-purple-600">Net (Company)</span><span class="font-semibold ' + ((casinoBetAmt - casinoWinAmt) >= 0 ? 'text-emerald-700' : 'text-red-600') + '">K' + (casinoBetAmt - casinoWinAmt).toLocaleString() + '</span></div>';
      html += '<hr class="border-purple-200">';
      html += '<div class="flex justify-between"><span class="text-purple-600">Bet Count</span><span class="font-semibold text-purple-800">' + casinoBetCount.toLocaleString() + '</span></div>';
      html += '<div class="flex justify-between"><span class="text-purple-600">Win Count</span><span class="font-semibold text-purple-800">' + casinoWinCount.toLocaleString() + '</span></div>';
      html += '<div class="flex justify-between"><span class="text-purple-600">Win Rate</span><span class="font-semibold text-purple-800">' + casinoWinRate.toFixed(1) + '%</span></div>';
      html += '<hr class="border-purple-200">';
      html += '<div class="flex justify-between"><span class="text-purple-600">Min Bet</span><span class="font-semibold text-purple-800">K' + (parseFloat(p.casino_bet_min) || 0).toLocaleString() + '</span></div>';
      html += '<div class="flex justify-between"><span class="text-purple-600">Max Bet</span><span class="font-semibold text-purple-800">K' + (parseFloat(p.casino_bet_max) || 0).toLocaleString() + '</span></div>';
      html += '<div class="flex justify-between"><span class="text-purple-600">Avg Bet</span><span class="font-semibold text-purple-800">K' + (parseFloat(p.casino_bet_avg) || 0).toFixed(2) + '</span></div>';
      html += '</div></div>';
      
      html += '</div></div></div>';
      
      // Analytics Summary
      html += '<div class="bg-white border rounded-xl overflow-hidden">';
      html += '<div class="bg-slate-100 px-4 py-3 border-b"><h4 class="font-bold text-slate-800 flex items-center gap-2"><i data-lucide="pie-chart" class="h-5 w-5 text-slate-600"></i> Analytics Summary</h4></div>';
      html += '<div class="p-4 grid grid-cols-2 sm:grid-cols-4 gap-4">';
      html += '<div class="text-center p-3 bg-slate-50 rounded-lg"><p class="text-xs text-slate-500 uppercase">Overall Win Rate</p><p class="text-2xl font-bold text-slate-800 mt-1">' + p.winRate.toFixed(1) + '%</p><div class="w-full h-2 bg-slate-200 rounded-full mt-2 overflow-hidden"><div class="h-full ' + (p.winRate > 50 ? 'bg-red-500' : 'bg-emerald-500') + '" style="width: ' + Math.min(p.winRate, 100) + '%"></div></div></div>';
      html += '<div class="text-center p-3 bg-slate-50 rounded-lg"><p class="text-xs text-slate-500 uppercase">Avg Bet Size</p><p class="text-2xl font-bold text-slate-800 mt-1">K' + p.avgBet.toFixed(0) + '</p><p class="text-xs text-slate-500 mt-1 capitalize">' + p.bettingStyle + '</p></div>';
      html += '<div class="text-center p-3 bg-slate-50 rounded-lg"><p class="text-xs text-slate-500 uppercase">Total Bets</p><p class="text-2xl font-bold text-slate-800 mt-1">' + p.totalBetCount.toLocaleString() + '</p><p class="text-xs text-slate-500 mt-1">' + p.totalWinCount.toLocaleString() + ' wins</p></div>';
      html += '<div class="text-center p-3 bg-slate-50 rounded-lg"><p class="text-xs text-slate-500 uppercase">Lifecycle</p><p class="text-2xl font-bold text-slate-800 mt-1 capitalize">' + p.lifecycle + '</p><p class="text-xs text-slate-500 mt-1">' + p.daysSinceReg + ' days old</p></div>';
      html += '</div></div>';
      
      // Raw Data Section (collapsible)
      html += '<details class="bg-slate-50 border rounded-xl overflow-hidden">';
      html += '<summary class="px-4 py-3 cursor-pointer font-medium text-slate-700 hover:bg-slate-100 flex items-center gap-2"><i data-lucide="database" class="h-4 w-4"></i> Raw CRM Data</summary>';
      html += '<div class="p-4 border-t bg-white"><div class="grid grid-cols-2 gap-3 text-sm">';
      var rawFields = [
        ['Player ID', p.id],
        ['Phone Number', p.phone_number || '-'],
        ['Phone Type', p.phone_type || p.phoneType],
        ['Status', p.status || '-'],
        ['Referral', p.referral || '-'],
        ['Registration Date', p.registration_date || '-'],
        ['Sport Bet Amount', 'K' + sportBetAmt.toLocaleString()],
        ['Sport Bet Count', sportBetCount],
        ['Sport Win Amount', 'K' + sportWinAmt.toLocaleString()],
        ['Sport Win Count', sportWinCount],
        ['Sport Bet Min', 'K' + (parseFloat(p.sport_bet_min) || 0)],
        ['Sport Bet Max', 'K' + (parseFloat(p.sport_bet_max) || 0)],
        ['Sport Bet Avg', 'K' + (parseFloat(p.sport_bet_avg) || 0).toFixed(2)],
        ['Casino Bet Amount', 'K' + casinoBetAmt.toLocaleString()],
        ['Casino Bet Count', casinoBetCount],
        ['Casino Win Amount', 'K' + casinoWinAmt.toLocaleString()],
        ['Casino Win Count', casinoWinCount],
        ['Casino Bet Min', 'K' + (parseFloat(p.casino_bet_min) || 0)],
        ['Casino Bet Max', 'K' + (parseFloat(p.casino_bet_max) || 0)],
        ['Casino Bet Avg', 'K' + (parseFloat(p.casino_bet_avg) || 0).toFixed(2)],
        ['Total Deposits', 'K' + deposits.toLocaleString()],
        ['Total Withdrawals', 'K' + withdrawals.toLocaleString()],
        ['Allocated Bonus', 'K' + playerBonus.toLocaleString() + (isCustom ? ' (Custom)' : '')],
        ['Updated At', p.updated_at || '-']
      ];
      rawFields.forEach(function(field) {
        html += '<div class="flex justify-between py-1 border-b border-slate-100"><span class="text-slate-500">' + field[0] + '</span><span class="font-medium text-slate-800">' + field[1] + '</span></div>';
      });
      html += '</div></div></details>';
      
      html += '</div>';
      
      document.getElementById('playerModalContent').innerHTML = html;
      document.getElementById('playerModal').classList.remove('hidden');
      lucide.createIcons();
    };

    function exportData(players, filename) {
      if (!players.length) { showNotification('No data', 'error'); return; }
      var headers = ['id','phone_number','phone_type','status','referral','registration_date','total_deposit','total_withdraw','net_revenue','sport_bet','sport_win','casino_bet','casino_win','total_bets','win_rate','company_ggr','is_profitable','is_negative_ggr','preference','value_segment','churn_risk','bonus'];
      var rows = [headers.join(',')];
      players.forEach(p => rows.push([p.id, '"' + (p.phone_number || '') + '"', p.phoneType, p.status, p.referral, p.registration_date, p.total_deposit_amount, p.total_withdraw_amount, p.netRevenue.toFixed(2), p.sport_bet_amount, p.sport_win_amount, p.casino_bet_amount, p.casino_win_amount, p.totalBetCount, p.winRate.toFixed(2), p.companyProfit.toFixed(2), p.isProfitable ? 'Yes' : 'No', p.isNegativeGGR ? 'Yes' : 'No', p.preference, p.valueSegment, p.churnRisk, getPlayerBonus(p)].join(',')));
      var blob = new Blob([rows.join('\n')], { type: 'text/csv' });
      var a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'bwanabet_' + filename + '_' + new Date().toISOString().split('T')[0] + '.csv'; a.click();
      showNotification('Exported ' + players.length + ' players', 'success');
    }

    function cleanNumeric(v) { if (!v) return null; var c = String(v).replace(/,/g, '').trim(); var n = parseFloat(c); return isNaN(n) ? null : n; }
    function parseDate(d) { if (!d) return null; if (/^\d{4}-\d{2}-\d{2}/.test(d)) return d.split('T')[0]; var m = { january: '01', february: '02', march: '03', april: '04', may: '05', june: '06', july: '07', august: '08', september: '09', october: '10', november: '11', december: '12' }; try { var p = d.toLowerCase().replace(/,/g, '').split(/\s+/); if (m[p[0]]) return p[2] + '-' + m[p[0]] + '-' + p[1].padStart(2, '0'); } catch (e) {} return null; }
    function parseCSV(line) { var r = [], c = '', q = false; for (var i = 0; i < line.length; i++) { var ch = line[i]; if (ch === '"') q = !q; else if (ch === ',' && !q) { r.push(c.trim()); c = ''; } else c += ch; } r.push(c.trim()); return r; }

    async function handleFileUpload(e) {
      var file = e.target.files[0]; if (!file) return;
      showLoading(true, 'Reading file...'); 
      document.getElementById('importProgress').classList.remove('hidden');
      
      try {
        var text = await file.text();
        var lines = text.split('\n').filter(l => l.trim());
        var totalLines = lines.length - 1;
        console.log('Total lines in CSV:', totalLines);
        
        var headers = parseCSV(lines[0]).map(h => h.trim().replace(/"/g, '').toLowerCase());
        var colMap = {}; 
        headers.forEach((h, i) => { 
          var m = FIELD_MAP[h]; 
          if (m) colMap[m] = i; 
          if (h === 'virtual/real phone') colMap['phone_number'] = i; 
        });
        
        console.log('Column mapping:', colMap);
        
        // Parse all records
        var toUpsert = [];
        for (var i = 1; i < lines.length; i++) {
          var vals = parseCSV(lines[i]), rec = {};
          for (var col in colMap) {
            var v = vals[colMap[col]];
            if (v !== undefined && v !== '') {
              if (col === 'phone_number') { 
                if (v.toUpperCase().includes('VIRTUAL')) { 
                  rec.phone_type = 'virtual'; 
                  rec.phone_number = v.replace(/virtual/gi, '').replace(/account/gi, '').trim() || null; 
                } else { 
                  rec.phone_type = 'real'; 
                  rec.phone_number = v; 
                } 
              }
              else if (NUMERIC_FIELDS.includes(col)) rec[col] = cleanNumeric(v);
              else if (col === 'registration_date') rec[col] = parseDate(v);
              else rec[col] = v;
            }
          }
          if (rec.id) { 
            rec.updated_at = new Date().toISOString(); 
            toUpsert.push(rec); 
          }
          
          // Update progress every 1000 rows
          if (i % 1000 === 0) { 
            var pct = Math.round((i / lines.length) * 30);
            document.getElementById('importProgressText').textContent = 'Parsing: ' + i.toLocaleString() + ' / ' + totalLines.toLocaleString();
            document.getElementById('importProgressBar').style.width = pct + '%';
            document.getElementById('loadingText').textContent = 'Parsing CSV... ' + i.toLocaleString() + ' rows';
            await new Promise(r => setTimeout(r, 0)); 
          }
        }
        
        console.log('Total records to upsert:', toUpsert.length);
        
        if (!toUpsert.length) { 
          showNotification('No valid records found', 'error'); 
          return; 
        }
        
        // Upload in small batches with delays to avoid rate limiting
        var batchSize = 100; // Smaller batches for reliability
        var totalBatches = Math.ceil(toUpsert.length / batchSize);
        var uploaded = 0;
        var failed = 0;
        
        document.getElementById('loadingText').textContent = 'Uploading to database...';
        
        for (var b = 0; b < toUpsert.length; b += batchSize) {
          var batch = toUpsert.slice(b, b + batchSize);
          var batchNum = Math.floor(b / batchSize) + 1;
          
          // Retry logic for each batch
          var maxRetries = 3;
          var success = false;
          
          for (var retry = 0; retry < maxRetries && !success; retry++) {
            try {
              var r = await App.db.from('customers').upsert(batch, { onConflict: 'id' });
              if (r.error) throw r.error;
              success = true;
              uploaded += batch.length;
            } catch (err) {
              console.error('Batch ' + batchNum + ' attempt ' + (retry + 1) + ' failed:', err.message);
              if (retry === maxRetries - 1) {
                failed += batch.length;
                console.error('Batch ' + batchNum + ' failed permanently');
              } else {
                // Wait before retry
                await new Promise(r => setTimeout(r, 1000 * (retry + 1)));
              }
            }
          }
          
          // Update progress
          var pct = 30 + Math.round((b + batch.length) / toUpsert.length * 70);
          document.getElementById('importProgressText').textContent = 'Uploading: ' + uploaded.toLocaleString() + ' / ' + toUpsert.length.toLocaleString();
          document.getElementById('importProgressBar').style.width = pct + '%';
          document.getElementById('loadingText').textContent = 'Batch ' + batchNum + ' / ' + totalBatches;
          
          // Small delay between batches to avoid rate limiting
          if (b + batchSize < toUpsert.length) {
            await new Promise(r => setTimeout(r, 50));
          }
        }
        
        console.log('Upload complete. Success:', uploaded, 'Failed:', failed);
        
        if (failed > 0) {
          showNotification('Imported ' + uploaded.toLocaleString() + ' players. ' + failed + ' failed.', 'error');
        } else {
          showNotification('Successfully imported ' + uploaded.toLocaleString() + ' players!', 'success');
        }
        
        await loadPlayers();
        
      } catch (err) { 
        console.error('Import error:', err);
        showNotification('Import failed: ' + err.message, 'error'); 
      }
      finally { 
        showLoading(false); 
        document.getElementById('importProgress').classList.add('hidden'); 
        e.target.value = ''; 
      }
    }

    function switchTab(t) {
      document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
      document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
      document.getElementById('content-' + t).classList.remove('hidden');
      ['', '-mobile'].forEach(s => { var btn = document.getElementById('tab-' + t + s); if (btn) btn.classList.add('active'); });
      lucide.createIcons();
    }

    function showLoading(show, text) { document.getElementById('loadingOverlay').classList.toggle('hidden', !show); if (text) document.getElementById('loadingText').textContent = text; }
    function showNotification(msg, type) {
      var el = document.getElementById('notification');
      el.className = 'fixed top-4 right-4 left-4 sm:left-auto z-50 px-4 py-3 rounded-lg shadow-xl flex items-center gap-3 notification text-sm text-white ' + (type === 'success' ? 'bg-emerald-500' : 'bg-red-500');
      el.innerHTML = '<i data-lucide="' + (type === 'success' ? 'check-circle' : 'x-circle') + '" class="h-5 w-5"></i><span>' + msg + '</span>';
      el.classList.remove('hidden'); lucide.createIcons();
      setTimeout(() => el.classList.add('hidden'), 4000);
    }
    function setText(id, val) { var el = document.getElementById(id); if (el) el.textContent = val; }
  </script>
</body>
</html>
