<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>BwanaBet CRM System</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap');
    body { font-family: 'Inter', sans-serif; }
    .tab-btn.active { background: #fbbf24; color: #000; }
    .settings-tab-btn.active { color: #d97706; border-bottom: 2px solid #f59e0b; background: #fffbeb; }
    .sub-tab-btn.active { background: #f1f5f9; color: #1e293b; border-bottom: 2px solid #3b82f6; }
    input[type="checkbox"] { accent-color: #f59e0b; }
    select:focus, input:focus { outline: none; box-shadow: 0 0 0 2px #fcd34d; }
    .notification { animation: slideIn 0.3s ease-out; }
    @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
    .spinner { animation: spin 1s linear infinite; }
    @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
    .mobile-menu { transition: max-height 0.3s ease-out; }
    .table-scroll::-webkit-scrollbar { height: 8px; }
    .table-scroll::-webkit-scrollbar-track { background: #f1f5f9; }
    .table-scroll::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
    .progress-bar { transition: width 0.5s ease-out; }
  </style>
</head>
<body class="bg-slate-100 min-h-screen">

  <!-- LOGIN SCREEN -->
  <div id="loginScreen" class="min-h-screen flex items-center justify-center bg-gradient-to-br from-slate-900 to-slate-800 p-4">
    <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md overflow-hidden">
      <div class="bg-black p-6 text-center border-b-4 border-amber-400">
        <h1 class="text-amber-400 font-extrabold text-3xl tracking-tight">BWANABET</h1>
        <p class="text-slate-400 text-sm mt-1">CRM System v2.0</p>
      </div>
      <div class="p-6 sm:p-8">
        <h2 class="text-xl font-bold text-slate-800 mb-6 text-center">Sign In</h2>
        <div id="loginError" class="hidden mb-4 p-3 bg-red-50 border border-red-200 rounded-lg text-red-700 text-sm"></div>
        <div class="space-y-4">
          <div>
            <label class="block text-sm font-medium text-slate-700 mb-1">Email</label>
            <input type="email" id="loginEmail" placeholder="you@example.com" class="w-full px-4 py-3 border border-slate-200 rounded-lg text-sm focus:outline-none focus:border-amber-400"/>
          </div>
          <div>
            <label class="block text-sm font-medium text-slate-700 mb-1">Password</label>
            <input type="password" id="loginPassword" placeholder="••••••••" class="w-full px-4 py-3 border border-slate-200 rounded-lg text-sm focus:outline-none focus:border-amber-400"/>
          </div>
          <button id="loginBtn" class="w-full py-3 bg-amber-500 text-black font-bold rounded-lg hover:bg-amber-400 transition-colors flex items-center justify-center gap-2">
            <i data-lucide="log-in" class="h-5 w-5"></i>
            Sign In
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- MAIN CRM APP -->
  <div id="mainApp" class="hidden">
    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="hidden fixed inset-0 bg-black/30 flex items-center justify-center z-[100]">
      <div class="bg-white rounded-xl p-6 flex items-center gap-4 shadow-2xl">
        <svg class="spinner h-8 w-8 text-amber-500" fill="none" viewBox="0 0 24 24">
          <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
          <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
        </svg>
        <span class="text-lg font-medium text-slate-700" id="loadingText">Loading...</span>
      </div>
    </div>

    <!-- Notification -->
    <div id="notification" class="hidden fixed top-4 right-4 left-4 sm:left-auto z-50 px-4 py-3 rounded-lg shadow-xl flex items-center gap-3 notification"></div>

    <!-- Header -->
    <header class="bg-black shadow-md border-b-4 border-amber-400">
      <div class="max-w-7xl mx-auto px-4 sm:px-6 py-3">
        <div class="flex items-center justify-between">
          <div class="flex items-center gap-3 sm:gap-6">
            <div class="text-amber-400 font-extrabold text-xl sm:text-2xl tracking-tight">BWANABET</div>
            <div class="hidden sm:block border-l-2 border-slate-600 pl-4 sm:pl-6">
              <h1 class="text-lg sm:text-xl font-bold text-white">CRM System</h1>
            </div>
          </div>
          
          <div class="flex items-center gap-2 sm:gap-4">
            <div id="connectionStatus" class="flex items-center gap-1.5 sm:gap-2 px-2 sm:px-3 py-1 rounded-full bg-slate-700">
              <div id="statusDot" class="w-2 h-2 rounded-full bg-gray-400"></div>
              <span id="statusText" class="text-xs text-slate-300 hidden sm:inline">Connecting...</span>
            </div>
            
            <div class="flex items-center gap-2">
              <span id="userEmail" class="text-xs text-slate-400 hidden sm:inline truncate max-w-[120px]"></span>
              <button id="logoutBtn" class="flex items-center gap-1 px-2 sm:px-3 py-1.5 bg-slate-700 text-slate-300 rounded-lg hover:bg-slate-600 text-sm">
                <i data-lucide="log-out" class="h-4 w-4"></i>
                <span class="hidden sm:inline">Logout</span>
              </button>
            </div>
            
            <button id="mobileMenuBtn" class="lg:hidden p-2 text-slate-300 hover:text-white">
              <i data-lucide="menu" class="h-6 w-6"></i>
            </button>
          </div>
        </div>
        
        <!-- Desktop Navigation -->
        <div class="hidden lg:flex items-center gap-1 bg-slate-800 rounded-lg p-1 mt-3 w-fit">
          <button id="tab-dashboard" class="tab-btn active flex items-center gap-2 px-4 py-2 rounded-md font-medium transition-colors text-slate-300 hover:text-white hover:bg-slate-700">
            <i data-lucide="layout-dashboard" class="h-4 w-4"></i>Dashboard
          </button>
          <button id="tab-behavior" class="tab-btn flex items-center gap-2 px-4 py-2 rounded-md font-medium transition-colors text-slate-300 hover:text-white hover:bg-slate-700">
            <i data-lucide="brain" class="h-4 w-4"></i>Behavior
          </button>
          <button id="tab-churn" class="tab-btn flex items-center gap-2 px-4 py-2 rounded-md font-medium transition-colors text-slate-300 hover:text-white hover:bg-slate-700">
            <i data-lucide="user-x" class="h-4 w-4"></i>Churn
          </button>
          <button id="tab-players" class="tab-btn flex items-center gap-2 px-4 py-2 rounded-md font-medium transition-colors text-slate-300 hover:text-white hover:bg-slate-700">
            <i data-lucide="users" class="h-4 w-4"></i>Players
          </button>
          <button id="tab-settings" class="tab-btn flex items-center gap-2 px-4 py-2 rounded-md font-medium transition-colors text-slate-300 hover:text-white hover:bg-slate-700">
            <i data-lucide="settings" class="h-4 w-4"></i>Settings
          </button>
        </div>
        
        <!-- Mobile Navigation -->
        <div id="mobileMenu" class="lg:hidden mobile-menu max-h-0 overflow-hidden">
          <div class="flex flex-col gap-1 bg-slate-800 rounded-lg p-2 mt-3">
            <button id="tab-dashboard-mobile" class="tab-btn active flex items-center gap-2 px-4 py-3 rounded-md font-medium text-slate-300 hover:text-white hover:bg-slate-700 text-left">
              <i data-lucide="layout-dashboard" class="h-5 w-5"></i>Dashboard
            </button>
            <button id="tab-behavior-mobile" class="tab-btn flex items-center gap-2 px-4 py-3 rounded-md font-medium text-slate-300 hover:text-white hover:bg-slate-700 text-left">
              <i data-lucide="brain" class="h-5 w-5"></i>Player Behavior
            </button>
            <button id="tab-churn-mobile" class="tab-btn flex items-center gap-2 px-4 py-3 rounded-md font-medium text-slate-300 hover:text-white hover:bg-slate-700 text-left">
              <i data-lucide="user-x" class="h-5 w-5"></i>Churn Risk
            </button>
            <button id="tab-players-mobile" class="tab-btn flex items-center gap-2 px-4 py-3 rounded-md font-medium text-slate-300 hover:text-white hover:bg-slate-700 text-left">
              <i data-lucide="users" class="h-5 w-5"></i>All Players
            </button>
            <button id="tab-settings-mobile" class="tab-btn flex items-center gap-2 px-4 py-3 rounded-md font-medium text-slate-300 hover:text-white hover:bg-slate-700 text-left">
              <i data-lucide="settings" class="h-5 w-5"></i>Settings
            </button>
          </div>
        </div>
      </div>
    </header>

    <main class="max-w-7xl mx-auto px-4 sm:px-6 py-4 sm:py-8">
      
      <!-- ==================== DASHBOARD TAB ==================== -->
      <div id="content-dashboard" class="tab-content">
        <!-- Key Metrics Row -->
        <div class="grid grid-cols-2 sm:grid-cols-4 gap-3 sm:gap-4 mb-6">
          <div class="bg-white rounded-xl shadow-sm p-4 border-l-4 border-indigo-500">
            <p class="text-xs text-slate-500 font-medium">Total Players</p>
            <p class="text-2xl font-bold text-indigo-600" id="metric-total-players">0</p>
          </div>
          <div class="bg-white rounded-xl shadow-sm p-4 border-l-4 border-emerald-500">
            <p class="text-xs text-slate-500 font-medium">Net Revenue</p>
            <p class="text-2xl font-bold text-emerald-600" id="metric-net-revenue">$0</p>
          </div>
          <div class="bg-white rounded-xl shadow-sm p-4 border-l-4 border-amber-500">
            <p class="text-xs text-slate-500 font-medium">Total Wagered</p>
            <p class="text-2xl font-bold text-amber-600" id="metric-total-wagered">$0</p>
          </div>
          <div class="bg-white rounded-xl shadow-sm p-4 border-l-4 border-red-500">
            <p class="text-xs text-slate-500 font-medium">At Risk</p>
            <p class="text-2xl font-bold text-red-600" id="metric-at-risk">0</p>
          </div>
        </div>

        <!-- Two Column Layout -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
          <!-- Player Preference Breakdown -->
          <div class="bg-white rounded-xl shadow-sm p-5">
            <h3 class="font-bold text-slate-800 mb-4 flex items-center gap-2">
              <i data-lucide="pie-chart" class="h-5 w-5 text-blue-500"></i>
              Player Preferences
            </h3>
            <div class="space-y-3">
              <div>
                <div class="flex justify-between text-sm mb-1">
                  <span class="text-slate-600">Sports Bettors</span>
                  <span class="font-medium" id="pref-sports-count">0</span>
                </div>
                <div class="h-3 bg-slate-100 rounded-full overflow-hidden">
                  <div id="pref-sports-bar" class="h-full bg-green-500 progress-bar" style="width: 0%"></div>
                </div>
              </div>
              <div>
                <div class="flex justify-between text-sm mb-1">
                  <span class="text-slate-600">Casino Players</span>
                  <span class="font-medium" id="pref-casino-count">0</span>
                </div>
                <div class="h-3 bg-slate-100 rounded-full overflow-hidden">
                  <div id="pref-casino-bar" class="h-full bg-purple-500 progress-bar" style="width: 0%"></div>
                </div>
              </div>
              <div>
                <div class="flex justify-between text-sm mb-1">
                  <span class="text-slate-600">Mixed Players</span>
                  <span class="font-medium" id="pref-mixed-count">0</span>
                </div>
                <div class="h-3 bg-slate-100 rounded-full overflow-hidden">
                  <div id="pref-mixed-bar" class="h-full bg-blue-500 progress-bar" style="width: 0%"></div>
                </div>
              </div>
            </div>
          </div>

          <!-- Value Segments -->
          <div class="bg-white rounded-xl shadow-sm p-5">
            <h3 class="font-bold text-slate-800 mb-4 flex items-center gap-2">
              <i data-lucide="gem" class="h-5 w-5 text-purple-500"></i>
              Value Segments
            </h3>
            <div class="grid grid-cols-2 gap-3">
              <div class="p-3 bg-purple-50 rounded-lg border border-purple-200 cursor-pointer hover:bg-purple-100" onclick="filterByValue('vip')">
                <p class="text-xs text-purple-600 font-medium">VIP</p>
                <p class="text-xl font-bold text-purple-700" id="seg-vip">0</p>
                <p class="text-xs text-purple-500">$5,000+ revenue</p>
              </div>
              <div class="p-3 bg-blue-50 rounded-lg border border-blue-200 cursor-pointer hover:bg-blue-100" onclick="filterByValue('high')">
                <p class="text-xs text-blue-600 font-medium">High Value</p>
                <p class="text-xl font-bold text-blue-700" id="seg-high">0</p>
                <p class="text-xs text-blue-500">$1,000-$5,000</p>
              </div>
              <div class="p-3 bg-teal-50 rounded-lg border border-teal-200 cursor-pointer hover:bg-teal-100" onclick="filterByValue('medium')">
                <p class="text-xs text-teal-600 font-medium">Medium</p>
                <p class="text-xl font-bold text-teal-700" id="seg-medium">0</p>
                <p class="text-xs text-teal-500">$100-$1,000</p>
              </div>
              <div class="p-3 bg-slate-50 rounded-lg border border-slate-200 cursor-pointer hover:bg-slate-100" onclick="filterByValue('low')">
                <p class="text-xs text-slate-600 font-medium">Low Value</p>
                <p class="text-xl font-bold text-slate-700" id="seg-low">0</p>
                <p class="text-xs text-slate-500">&lt;$100</p>
              </div>
            </div>
          </div>
        </div>

        <!-- Churn Risk Overview -->
        <div class="bg-white rounded-xl shadow-sm p-5 mb-6">
          <h3 class="font-bold text-slate-800 mb-4 flex items-center gap-2">
            <i data-lucide="alert-triangle" class="h-5 w-5 text-red-500"></i>
            Churn Risk Overview
          </h3>
          <div class="grid grid-cols-2 sm:grid-cols-4 gap-3">
            <div class="text-center p-4 bg-emerald-50 rounded-lg cursor-pointer hover:bg-emerald-100" onclick="filterByChurn('low')">
              <p class="text-3xl font-bold text-emerald-600" id="churn-low">0</p>
              <p class="text-sm text-emerald-700">Low Risk</p>
              <p class="text-xs text-emerald-500">&lt;7 days</p>
            </div>
            <div class="text-center p-4 bg-amber-50 rounded-lg cursor-pointer hover:bg-amber-100" onclick="filterByChurn('medium')">
              <p class="text-3xl font-bold text-amber-600" id="churn-medium">0</p>
              <p class="text-sm text-amber-700">Medium</p>
              <p class="text-xs text-amber-500">7-14 days</p>
            </div>
            <div class="text-center p-4 bg-orange-50 rounded-lg cursor-pointer hover:bg-orange-100" onclick="filterByChurn('high')">
              <p class="text-3xl font-bold text-orange-600" id="churn-high">0</p>
              <p class="text-sm text-orange-700">High Risk</p>
              <p class="text-xs text-orange-500">14-30 days</p>
            </div>
            <div class="text-center p-4 bg-red-50 rounded-lg cursor-pointer hover:bg-red-100" onclick="filterByChurn('critical')">
              <p class="text-3xl font-bold text-red-600" id="churn-critical">0</p>
              <p class="text-sm text-red-700">Critical</p>
              <p class="text-xs text-red-500">30+ days</p>
            </div>
          </div>
        </div>

        <!-- Risk Alerts -->
        <div class="bg-white rounded-xl shadow-sm p-5">
          <h3 class="font-bold text-slate-800 mb-4 flex items-center gap-2">
            <i data-lucide="bell" class="h-5 w-5 text-amber-500"></i>
            Risk Alerts
          </h3>
          <div class="grid grid-cols-1 sm:grid-cols-3 gap-3">
            <div class="p-3 bg-red-50 rounded-lg border border-red-200">
              <div class="flex items-center gap-2 mb-1">
                <i data-lucide="trending-down" class="h-4 w-4 text-red-500"></i>
                <p class="text-sm font-medium text-red-700">Withdrawing Profits</p>
              </div>
              <p class="text-2xl font-bold text-red-600" id="alert-withdrawing">0</p>
              <p class="text-xs text-red-500">withdraw &gt; deposit</p>
            </div>
            <div class="p-3 bg-amber-50 rounded-lg border border-amber-200">
              <div class="flex items-center gap-2 mb-1">
                <i data-lucide="frown" class="h-4 w-4 text-amber-500"></i>
                <p class="text-sm font-medium text-amber-700">Big Losers</p>
              </div>
              <p class="text-2xl font-bold text-amber-600" id="alert-losers">0</p>
              <p class="text-xs text-amber-500">win rate &lt;40%</p>
            </div>
            <div class="p-3 bg-purple-50 rounded-lg border border-purple-200">
              <div class="flex items-center gap-2 mb-1">
                <i data-lucide="smartphone" class="h-4 w-4 text-purple-500"></i>
                <p class="text-sm font-medium text-purple-700">Virtual Phone</p>
              </div>
              <p class="text-2xl font-bold text-purple-600" id="alert-virtual">0</p>
              <p class="text-xs text-purple-500">potential fraud risk</p>
            </div>
          </div>
        </div>
      </div>

      <!-- ==================== BEHAVIOR TAB ==================== -->
      <div id="content-behavior" class="tab-content hidden">
        <h2 class="text-xl font-bold text-slate-800 mb-4">Player Behavior Analysis</h2>
        
        <!-- Sub-tabs -->
        <div class="flex gap-1 mb-6 overflow-x-auto bg-white rounded-lg p-1 shadow-sm">
          <button id="subtab-preference" class="sub-tab-btn active px-4 py-2 text-sm font-medium text-slate-500 rounded whitespace-nowrap">Preferences</button>
          <button id="subtab-betting" class="sub-tab-btn px-4 py-2 text-sm font-medium text-slate-500 rounded whitespace-nowrap">Betting Style</button>
          <button id="subtab-lifecycle" class="sub-tab-btn px-4 py-2 text-sm font-medium text-slate-500 rounded whitespace-nowrap">Lifecycle</button>
          <button id="subtab-profitability" class="sub-tab-btn px-4 py-2 text-sm font-medium text-slate-500 rounded whitespace-nowrap">Profitability</button>
        </div>

        <!-- Preference Content -->
        <div id="subcontent-preference" class="sub-content">
          <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 mb-6">
            <div class="bg-gradient-to-br from-green-500 to-green-600 rounded-xl p-5 text-white cursor-pointer hover:shadow-lg" onclick="filterByPref('sports')">
              <div class="flex items-center gap-2 mb-2">
                <i data-lucide="trophy" class="h-6 w-6"></i>
                <h3 class="text-lg font-bold">Sports Bettors</h3>
              </div>
              <p class="text-white/80 text-sm mb-3">&gt;70% sports betting</p>
              <p class="text-4xl font-bold" id="beh-sports">0</p>
            </div>
            <div class="bg-gradient-to-br from-purple-500 to-purple-600 rounded-xl p-5 text-white cursor-pointer hover:shadow-lg" onclick="filterByPref('casino')">
              <div class="flex items-center gap-2 mb-2">
                <i data-lucide="dice-5" class="h-6 w-6"></i>
                <h3 class="text-lg font-bold">Casino Players</h3>
              </div>
              <p class="text-white/80 text-sm mb-3">&gt;70% casino betting</p>
              <p class="text-4xl font-bold" id="beh-casino">0</p>
            </div>
            <div class="bg-gradient-to-br from-blue-500 to-blue-600 rounded-xl p-5 text-white cursor-pointer hover:shadow-lg" onclick="filterByPref('mixed')">
              <div class="flex items-center gap-2 mb-2">
                <i data-lucide="shuffle" class="h-6 w-6"></i>
                <h3 class="text-lg font-bold">Mixed Players</h3>
              </div>
              <p class="text-white/80 text-sm mb-3">Balanced betting</p>
              <p class="text-4xl font-bold" id="beh-mixed">0</p>
            </div>
          </div>
          
          <div class="bg-white rounded-xl shadow-sm p-5">
            <h3 class="font-bold text-slate-800 mb-4">Revenue by Preference</h3>
            <div class="space-y-4">
              <div class="flex items-center gap-4">
                <span class="w-24 text-sm text-slate-600">Sports</span>
                <div class="flex-1 h-6 bg-slate-100 rounded-full overflow-hidden">
                  <div id="rev-sports-bar" class="h-full bg-green-500 progress-bar" style="width: 0%"></div>
                </div>
                <span class="w-24 text-right font-medium" id="rev-sports">$0</span>
              </div>
              <div class="flex items-center gap-4">
                <span class="w-24 text-sm text-slate-600">Casino</span>
                <div class="flex-1 h-6 bg-slate-100 rounded-full overflow-hidden">
                  <div id="rev-casino-bar" class="h-full bg-purple-500 progress-bar" style="width: 0%"></div>
                </div>
                <span class="w-24 text-right font-medium" id="rev-casino">$0</span>
              </div>
            </div>
          </div>
        </div>

        <!-- Betting Style Content -->
        <div id="subcontent-betting" class="sub-content hidden">
          <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 mb-6">
            <div class="bg-gradient-to-br from-amber-500 to-amber-600 rounded-xl p-5 text-white">
              <div class="flex items-center gap-2 mb-2">
                <i data-lucide="gem" class="h-6 w-6"></i>
                <h3 class="text-lg font-bold">High Rollers</h3>
              </div>
              <p class="text-white/80 text-sm mb-3">Avg bet &gt;$100</p>
              <p class="text-4xl font-bold" id="style-highroller">0</p>
            </div>
            <div class="bg-gradient-to-br from-blue-500 to-blue-600 rounded-xl p-5 text-white">
              <div class="flex items-center gap-2 mb-2">
                <i data-lucide="user" class="h-6 w-6"></i>
                <h3 class="text-lg font-bold">Regular Bettors</h3>
              </div>
              <p class="text-white/80 text-sm mb-3">Avg bet $10-$100</p>
              <p class="text-4xl font-bold" id="style-regular">0</p>
            </div>
            <div class="bg-gradient-to-br from-slate-500 to-slate-600 rounded-xl p-5 text-white">
              <div class="flex items-center gap-2 mb-2">
                <i data-lucide="coffee" class="h-6 w-6"></i>
                <h3 class="text-lg font-bold">Casual Players</h3>
              </div>
              <p class="text-white/80 text-sm mb-3">Avg bet &lt;$10</p>
              <p class="text-4xl font-bold" id="style-casual">0</p>
            </div>
          </div>
          
          <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
            <div class="bg-white rounded-xl shadow-sm p-5">
              <h3 class="font-bold text-slate-800 mb-4">Risk Appetite</h3>
              <div class="space-y-3">
                <div class="flex justify-between items-center p-3 bg-red-50 rounded-lg">
                  <span class="text-sm font-medium text-red-700">Aggressive</span>
                  <span class="text-xl font-bold text-red-600" id="risk-aggressive">0</span>
                </div>
                <div class="flex justify-between items-center p-3 bg-amber-50 rounded-lg">
                  <span class="text-sm font-medium text-amber-700">Moderate</span>
                  <span class="text-xl font-bold text-amber-600" id="risk-moderate">0</span>
                </div>
                <div class="flex justify-between items-center p-3 bg-emerald-50 rounded-lg">
                  <span class="text-sm font-medium text-emerald-700">Conservative</span>
                  <span class="text-xl font-bold text-emerald-600" id="risk-conservative">0</span>
                </div>
              </div>
            </div>
            <div class="bg-white rounded-xl shadow-sm p-5">
              <h3 class="font-bold text-slate-800 mb-4">Win Rate Distribution</h3>
              <div class="space-y-3">
                <div class="flex justify-between items-center p-3 bg-emerald-50 rounded-lg">
                  <span class="text-sm font-medium text-emerald-700">Winners (&gt;50%)</span>
                  <span class="text-xl font-bold text-emerald-600" id="winrate-high">0</span>
                </div>
                <div class="flex justify-between items-center p-3 bg-amber-50 rounded-lg">
                  <span class="text-sm font-medium text-amber-700">Average (40-50%)</span>
                  <span class="text-xl font-bold text-amber-600" id="winrate-avg">0</span>
                </div>
                <div class="flex justify-between items-center p-3 bg-red-50 rounded-lg">
                  <span class="text-sm font-medium text-red-700">Losers (&lt;40%)</span>
                  <span class="text-xl font-bold text-red-600" id="winrate-low">0</span>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Lifecycle Content -->
        <div id="subcontent-lifecycle" class="sub-content hidden">
          <div class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-6 gap-3">
            <div class="bg-gradient-to-br from-cyan-500 to-cyan-600 rounded-xl p-4 text-white text-center">
              <i data-lucide="sparkles" class="h-6 w-6 mx-auto mb-2"></i>
              <p class="text-2xl font-bold" id="life-new">0</p>
              <p class="text-sm font-medium">New</p>
              <p class="text-xs text-white/70">&lt;30 days</p>
            </div>
            <div class="bg-gradient-to-br from-emerald-500 to-emerald-600 rounded-xl p-4 text-white text-center">
              <i data-lucide="trending-up" class="h-6 w-6 mx-auto mb-2"></i>
              <p class="text-2xl font-bold" id="life-growing">0</p>
              <p class="text-sm font-medium">Growing</p>
              <p class="text-xs text-white/70">Active &lt;90d</p>
            </div>
            <div class="bg-gradient-to-br from-purple-500 to-purple-600 rounded-xl p-4 text-white text-center">
              <i data-lucide="crown" class="h-6 w-6 mx-auto mb-2"></i>
              <p class="text-2xl font-bold" id="life-mature">0</p>
              <p class="text-sm font-medium">Mature</p>
              <p class="text-xs text-white/70">Active 90d+</p>
            </div>
            <div class="bg-gradient-to-br from-amber-500 to-amber-600 rounded-xl p-4 text-white text-center">
              <i data-lucide="trending-down" class="h-6 w-6 mx-auto mb-2"></i>
              <p class="text-2xl font-bold" id="life-declining">0</p>
              <p class="text-sm font-medium">Declining</p>
              <p class="text-xs text-white/70">14-30d inactive</p>
            </div>
            <div class="bg-gradient-to-br from-orange-500 to-orange-600 rounded-xl p-4 text-white text-center">
              <i data-lucide="moon" class="h-6 w-6 mx-auto mb-2"></i>
              <p class="text-2xl font-bold" id="life-dormant">0</p>
              <p class="text-sm font-medium">Dormant</p>
              <p class="text-xs text-white/70">30-90d inactive</p>
            </div>
            <div class="bg-gradient-to-br from-red-500 to-red-600 rounded-xl p-4 text-white text-center">
              <i data-lucide="user-x" class="h-6 w-6 mx-auto mb-2"></i>
              <p class="text-2xl font-bold" id="life-churned">0</p>
              <p class="text-sm font-medium">Churned</p>
              <p class="text-xs text-white/70">90d+ inactive</p>
            </div>
          </div>
        </div>

        <!-- Profitability Content -->
        <div id="subcontent-profitability" class="sub-content hidden">
          <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
            <div class="bg-white rounded-xl shadow-sm p-5 border-l-4 border-emerald-500">
              <p class="text-sm text-slate-500">Total Deposits</p>
              <p class="text-2xl font-bold text-emerald-600" id="profit-deposits">$0</p>
            </div>
            <div class="bg-white rounded-xl shadow-sm p-5 border-l-4 border-red-500">
              <p class="text-sm text-slate-500">Total Withdrawals</p>
              <p class="text-2xl font-bold text-red-600" id="profit-withdrawals">$0</p>
            </div>
            <div class="bg-white rounded-xl shadow-sm p-5 border-l-4 border-blue-500">
              <p class="text-sm text-slate-500">Net Revenue (GGR)</p>
              <p class="text-2xl font-bold text-blue-600" id="profit-net">$0</p>
            </div>
            <div class="bg-white rounded-xl shadow-sm p-5 border-l-4 border-purple-500">
              <p class="text-sm text-slate-500">Avg Player Value</p>
              <p class="text-2xl font-bold text-purple-600" id="profit-avg">$0</p>
            </div>
          </div>
          
          <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
            <div class="bg-white rounded-xl shadow-sm p-5">
              <h3 class="font-bold text-slate-800 mb-4">Sports Performance</h3>
              <div class="space-y-2 text-sm">
                <div class="flex justify-between"><span class="text-slate-500">Total Bet</span><span class="font-medium" id="sport-total-bet">$0</span></div>
                <div class="flex justify-between"><span class="text-slate-500">Total Won</span><span class="font-medium" id="sport-total-won">$0</span></div>
                <div class="flex justify-between"><span class="text-slate-500">House Edge</span><span class="font-medium text-emerald-600" id="sport-edge">0%</span></div>
              </div>
            </div>
            <div class="bg-white rounded-xl shadow-sm p-5">
              <h3 class="font-bold text-slate-800 mb-4">Casino Performance</h3>
              <div class="space-y-2 text-sm">
                <div class="flex justify-between"><span class="text-slate-500">Total Bet</span><span class="font-medium" id="casino-total-bet">$0</span></div>
                <div class="flex justify-between"><span class="text-slate-500">Total Won</span><span class="font-medium" id="casino-total-won">$0</span></div>
                <div class="flex justify-between"><span class="text-slate-500">House Edge</span><span class="font-medium text-emerald-600" id="casino-edge">0%</span></div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- ==================== CHURN TAB ==================== -->
      <div id="content-churn" class="tab-content hidden">
        <h2 class="text-xl font-bold text-slate-800 mb-4">Churn Risk Analysis</h2>
        
        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-6">
          <div class="bg-gradient-to-br from-emerald-500 to-emerald-600 rounded-xl p-5 text-white cursor-pointer hover:shadow-lg" onclick="filterByChurn('low')">
            <div class="flex items-center gap-3 mb-2">
              <div class="bg-white/20 rounded-full p-2"><i data-lucide="shield-check" class="h-6 w-6"></i></div>
              <h3 class="text-xl font-bold">Low Risk</h3>
            </div>
            <p class="text-white/80 text-sm">&lt; 7 days since last activity</p>
            <p class="text-4xl font-bold mt-3" id="churn-detail-low">0</p>
          </div>
          <div class="bg-gradient-to-br from-amber-500 to-amber-600 rounded-xl p-5 text-white cursor-pointer hover:shadow-lg" onclick="filterByChurn('medium')">
            <div class="flex items-center gap-3 mb-2">
              <div class="bg-white/20 rounded-full p-2"><i data-lucide="shield" class="h-6 w-6"></i></div>
              <h3 class="text-xl font-bold">Medium Risk</h3>
            </div>
            <p class="text-white/80 text-sm">7-14 days since last activity</p>
            <p class="text-4xl font-bold mt-3" id="churn-detail-medium">0</p>
          </div>
          <div class="bg-gradient-to-br from-orange-500 to-orange-600 rounded-xl p-5 text-white cursor-pointer hover:shadow-lg" onclick="filterByChurn('high')">
            <div class="flex items-center gap-3 mb-2">
              <div class="bg-white/20 rounded-full p-2"><i data-lucide="shield-alert" class="h-6 w-6"></i></div>
              <h3 class="text-xl font-bold">High Risk</h3>
            </div>
            <p class="text-white/80 text-sm">14-30 days since last activity</p>
            <p class="text-4xl font-bold mt-3" id="churn-detail-high">0</p>
          </div>
          <div class="bg-gradient-to-br from-red-500 to-red-600 rounded-xl p-5 text-white cursor-pointer hover:shadow-lg" onclick="filterByChurn('critical')">
            <div class="flex items-center gap-3 mb-2">
              <div class="bg-white/20 rounded-full p-2"><i data-lucide="user-x" class="h-6 w-6"></i></div>
              <h3 class="text-xl font-bold">Critical</h3>
            </div>
            <p class="text-white/80 text-sm">30+ days since last activity</p>
            <p class="text-4xl font-bold mt-3" id="churn-detail-critical">0</p>
          </div>
        </div>

        <div class="bg-white rounded-xl shadow-sm p-5">
          <h3 class="font-bold text-slate-800 mb-4">Additional Churn Indicators</h3>
          <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
            <div class="p-4 bg-red-50 rounded-lg border border-red-200">
              <p class="text-sm font-medium text-red-700">Withdrawing Profits</p>
              <p class="text-3xl font-bold text-red-600" id="churn-withdrawing">0</p>
              <p class="text-xs text-red-500 mt-1">May leave after cashout</p>
            </div>
            <div class="p-4 bg-amber-50 rounded-lg border border-amber-200">
              <p class="text-sm font-medium text-amber-700">Losing Streak</p>
              <p class="text-3xl font-bold text-amber-600" id="churn-losing">0</p>
              <p class="text-xs text-amber-500 mt-1">Win rate &lt;35%, frustrated</p>
            </div>
            <div class="p-4 bg-slate-50 rounded-lg border border-slate-200">
              <p class="text-sm font-medium text-slate-700">Inactive Status</p>
              <p class="text-3xl font-bold text-slate-600" id="churn-inactive-status">0</p>
              <p class="text-xs text-slate-500 mt-1">Platform marked inactive</p>
            </div>
          </div>
        </div>
      </div>

      <!-- ==================== PLAYERS TAB ==================== -->
      <div id="content-players" class="tab-content hidden">
        <div class="bg-white rounded-xl shadow-sm overflow-hidden">
          <div class="px-4 sm:px-6 py-3 sm:py-4 border-b bg-slate-50">
            <div class="flex flex-col gap-3">
              <div class="relative">
                <i data-lucide="search" class="h-5 w-5 text-slate-400 absolute left-3 top-1/2 -translate-y-1/2"></i>
                <input type="text" id="searchInput" placeholder="Search by ID or phone..." class="w-full pl-10 pr-4 py-2 border border-slate-200 rounded-lg text-sm"/>
              </div>
              
              <div class="flex flex-wrap gap-2">
                <select id="churnFilter" class="flex-1 min-w-[100px] px-3 py-2 border border-slate-200 rounded-lg text-sm">
                  <option value="all">All Risk</option>
                  <option value="low">Low</option>
                  <option value="medium">Medium</option>
                  <option value="high">High</option>
                  <option value="critical">Critical</option>
                </select>
                <select id="prefFilter" class="flex-1 min-w-[100px] px-3 py-2 border border-slate-200 rounded-lg text-sm">
                  <option value="all">All Types</option>
                  <option value="sports">Sports</option>
                  <option value="casino">Casino</option>
                  <option value="mixed">Mixed</option>
                </select>
                <select id="valueFilter" class="flex-1 min-w-[100px] px-3 py-2 border border-slate-200 rounded-lg text-sm">
                  <option value="all">All Value</option>
                  <option value="vip">VIP</option>
                  <option value="high">High</option>
                  <option value="medium">Medium</option>
                  <option value="low">Low</option>
                </select>
                <button id="clearFiltersBtn" class="px-3 py-2 text-sm text-amber-600 hover:text-amber-700 font-medium">Clear</button>
              </div>
              
              <div class="flex flex-wrap gap-2">
                <button id="refreshBtn" class="flex items-center gap-2 px-3 py-2 bg-slate-100 text-slate-700 rounded-lg hover:bg-slate-200 text-sm">
                  <i data-lucide="refresh-cw" class="h-4 w-4"></i><span class="hidden sm:inline">Refresh</span>
                </button>
                <button id="exportBtn" class="flex items-center gap-2 px-3 py-2 bg-amber-500 text-black font-medium rounded-lg hover:bg-amber-400 text-sm">
                  <i data-lucide="download" class="h-4 w-4"></i><span>Export</span>
                </button>
              </div>
            </div>
          </div>

          <div class="overflow-x-auto table-scroll">
            <table class="w-full min-w-[800px]">
              <thead class="bg-slate-50 border-b">
                <tr>
                  <th class="px-3 py-3 text-left text-xs font-semibold text-slate-600">ID / Phone</th>
                  <th class="px-3 py-3 text-left text-xs font-semibold text-slate-600">Type</th>
                  <th class="px-3 py-3 text-left text-xs font-semibold text-slate-600">Preference</th>
                  <th class="px-3 py-3 text-left text-xs font-semibold text-slate-600">Net Revenue</th>
                  <th class="px-3 py-3 text-left text-xs font-semibold text-slate-600">Win Rate</th>
                  <th class="px-3 py-3 text-left text-xs font-semibold text-slate-600">Value</th>
                  <th class="px-3 py-3 text-left text-xs font-semibold text-slate-600">Churn Risk</th>
                  <th class="px-3 py-3 text-left text-xs font-semibold text-slate-600">Actions</th>
                </tr>
              </thead>
              <tbody class="divide-y divide-slate-100" id="tableBody">
                <tr>
                  <td colspan="8" class="px-4 py-12 text-center text-slate-500">
                    <i data-lucide="database" class="h-10 w-10 mx-auto mb-4 text-slate-300"></i>
                    <p class="text-sm">Loading players...</p>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
          <div class="px-4 py-3 bg-slate-50 border-t text-sm text-slate-500" id="tableFooter">Loading...</div>
        </div>
      </div>

      <!-- ==================== SETTINGS TAB ==================== -->
      <div id="content-settings" class="tab-content hidden">
        <div class="max-w-4xl mx-auto">
          <h2 class="text-xl font-bold text-slate-800 mb-6">Settings</h2>
          
          <!-- User Info -->
          <div class="bg-white rounded-xl shadow-sm overflow-hidden mb-6">
            <div class="px-6 py-4 border-b bg-slate-50">
              <h3 class="font-bold text-slate-800 flex items-center gap-2">
                <i data-lucide="user" class="h-5 w-5 text-indigo-500"></i>
                Current User
              </h3>
            </div>
            <div class="p-6">
              <p class="font-medium text-slate-800" id="settingsUserEmail">Loading...</p>
            </div>
          </div>

          <!-- Import Section -->
          <div class="bg-white rounded-xl shadow-sm overflow-hidden mb-6">
            <div class="px-6 py-4 border-b bg-slate-50">
              <h3 class="font-bold text-slate-800 flex items-center gap-2">
                <i data-lucide="upload" class="h-5 w-5 text-amber-500"></i>
                Import Player Data
              </h3>
            </div>
            <div class="p-6">
              <div class="bg-amber-50 border-l-4 border-amber-500 p-4 rounded mb-4">
                <p class="font-bold text-amber-800">CSV Import</p>
                <p class="text-amber-700 text-sm mt-1">Upload CSV from betting platform. Numbers with commas and formatted dates are handled automatically.</p>
              </div>
              
              <label class="block border-2 border-dashed border-slate-300 rounded-xl p-8 text-center cursor-pointer hover:border-amber-400 hover:bg-amber-50">
                <i data-lucide="upload" class="h-12 w-12 text-slate-400 mx-auto mb-3"></i>
                <p class="font-semibold text-slate-700">Click to upload CSV file</p>
                <p class="text-sm text-slate-500 mt-2">or drag and drop</p>
                <input type="file" accept=".csv" id="csvFileInput" class="hidden"/>
              </label>
              
              <div id="importProgress" class="hidden mt-4">
                <div class="flex justify-between text-sm mb-1">
                  <span class="text-slate-600">Importing...</span>
                  <span id="importProgressText" class="font-medium">0%</span>
                </div>
                <div class="h-2 bg-slate-200 rounded-full overflow-hidden">
                  <div id="importProgressBar" class="h-full bg-amber-500 progress-bar" style="width: 0%"></div>
                </div>
              </div>
            </div>
          </div>

          <!-- Export Section -->
          <div class="bg-white rounded-xl shadow-sm overflow-hidden">
            <div class="px-6 py-4 border-b bg-slate-50">
              <h3 class="font-bold text-slate-800 flex items-center gap-2">
                <i data-lucide="download" class="h-5 w-5 text-emerald-500"></i>
                Export Data
              </h3>
            </div>
            <div class="p-6">
              <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                <button id="exportAllBtn" class="p-6 border-2 border-slate-200 rounded-lg text-left hover:border-indigo-400 hover:bg-indigo-50">
                  <i data-lucide="download" class="h-8 w-8 text-indigo-500 mb-2"></i>
                  <p class="font-bold text-slate-800">All Players</p>
                  <p class="text-sm text-slate-500" id="export-all-count">0 players</p>
                </button>
                <button id="exportCriticalBtn" class="p-6 border-2 border-slate-200 rounded-lg text-left hover:border-red-400 hover:bg-red-50">
                  <i data-lucide="download" class="h-8 w-8 text-red-500 mb-2"></i>
                  <p class="font-bold text-slate-800">Critical Risk Only</p>
                  <p class="text-sm text-slate-500" id="export-critical-count">0 players</p>
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </main>

    <!-- Player Detail Modal -->
    <div id="playerModal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-50">
      <div class="bg-white rounded-xl shadow-2xl w-full max-w-2xl max-h-[90vh] overflow-y-auto">
        <div class="px-6 py-4 border-b flex items-center justify-between sticky top-0 bg-white">
          <h3 class="text-lg font-bold">Player Details</h3>
          <button id="closePlayerModal" class="p-2 text-slate-400 hover:text-slate-600 rounded-lg hover:bg-slate-100">
            <i data-lucide="x" class="h-5 w-5"></i>
          </button>
        </div>
        <div class="p-6" id="playerModalContent"></div>
      </div>
    </div>
  </div>

  <script>
    // ============================================
    // SUPABASE CREDENTIALS
    // ============================================
    var SUPABASE_URL = 'https://blrrcnrhixckfudiojwe.supabase.co';
    var SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJscnJjbnJoaXhja2Z1ZGlvandlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc3Nzg0MzMsImV4cCI6MjA4MzM1NDQzM30.2DGACAZz-f_r0ieYz3hvtsOG1y-3fqTD_ENH2ZR2g1k';

    // ============================================
    // APP STATE
    // ============================================
    var App = { db: null, user: null, players: [], mobileMenuOpen: false };

    // ============================================
    // FIELD MAPPING
    // ============================================
    var FIELD_MAP = {
      'id': 'id',
      'virtual/real phone': 'phone_number',
      'referral': 'referral',
      'status': 'status',
      'registration_date': 'registration_date',
      'sport_bet_amount': 'sport_bet_amount',
      'sport_bet_count': 'sport_bet_count',
      'sport_win_amount': 'sport_win_amount',
      'sport_win_count': 'sport_win_count',
      'casino_bet_amount': 'casino_bet_amount',
      'casino_bet_count': 'casino_bet_count',
      'casino_win_amount': 'casino_win_amount',
      'casino_win_count': 'casino_win_count',
      'total_deposit_amount': 'total_deposit_amount',
      'total_withdraw_amount': 'total_withdraw_amount',
      'sport_bet_min': 'sport_bet_min',
      'sport_bet_max': 'sport_bet_max',
      'sport_bet_avg': 'sport_bet_avg',
      'casino_bet_min': 'casino_bet_min',
      'casino_bet_max': 'casino_bet_max',
      'casino_bet_avg': 'casino_bet_avg'
    };

    var NUMERIC_FIELDS = ['sport_bet_amount', 'sport_bet_count', 'sport_win_amount', 'sport_win_count', 'casino_bet_amount', 'casino_bet_count', 'casino_win_amount', 'casino_win_count', 'total_deposit_amount', 'total_withdraw_amount', 'sport_bet_min', 'sport_bet_max', 'sport_bet_avg', 'casino_bet_min', 'casino_bet_max', 'casino_bet_avg'];

    // ============================================
    // INITIALIZATION
    // ============================================
    document.addEventListener('DOMContentLoaded', function() {
      lucide.createIcons();
      App.db = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
      setupLoginListeners();
      checkSession();
    });

    // ============================================
    // AUTHENTICATION
    // ============================================
    function setupLoginListeners() {
      document.getElementById('loginBtn').addEventListener('click', handleLogin);
      document.getElementById('loginPassword').addEventListener('keypress', function(e) { if (e.key === 'Enter') handleLogin(); });
      document.getElementById('loginEmail').addEventListener('keypress', function(e) { if (e.key === 'Enter') document.getElementById('loginPassword').focus(); });
    }

    async function checkSession() {
      var result = await App.db.auth.getSession();
      if (result.data.session) { App.user = result.data.session.user; showMainApp(); }
      App.db.auth.onAuthStateChange(function(event, session) {
        if (event === 'SIGNED_IN' && session) { App.user = session.user; showMainApp(); }
        else if (event === 'SIGNED_OUT') { App.user = null; showLoginScreen(); }
      });
    }

    async function handleLogin() {
      var email = document.getElementById('loginEmail').value.trim();
      var password = document.getElementById('loginPassword').value;
      if (!email || !password) { showLoginError('Please enter email and password'); return; }
      var btn = document.getElementById('loginBtn');
      btn.disabled = true;
      btn.innerHTML = '<svg class="spinner h-5 w-5" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"></path></svg> Signing in...';
      try {
        var result = await App.db.auth.signInWithPassword({ email: email, password: password });
        if (result.error) throw result.error;
      } catch (error) {
        showLoginError(error.message || 'Login failed');
        btn.disabled = false;
        btn.innerHTML = '<i data-lucide="log-in" class="h-5 w-5"></i> Sign In';
        lucide.createIcons();
      }
    }

    async function handleLogout() { await App.db.auth.signOut(); }
    function showLoginError(msg) { var el = document.getElementById('loginError'); el.textContent = msg; el.classList.remove('hidden'); }
    function showLoginScreen() { document.getElementById('loginScreen').classList.remove('hidden'); document.getElementById('mainApp').classList.add('hidden'); }
    function showMainApp() {
      document.getElementById('loginScreen').classList.add('hidden');
      document.getElementById('mainApp').classList.remove('hidden');
      if (App.user) { document.getElementById('userEmail').textContent = App.user.email; document.getElementById('settingsUserEmail').textContent = App.user.email; }
      setupEventListeners();
      updateConnectionStatus('connecting', 'Connecting...');
      loadPlayers();
    }

    // ============================================
    // EVENT LISTENERS
    // ============================================
    function setupEventListeners() {
      document.getElementById('logoutBtn').addEventListener('click', handleLogout);
      document.getElementById('mobileMenuBtn').addEventListener('click', toggleMobileMenu);
      ['dashboard', 'behavior', 'churn', 'players', 'settings'].forEach(function(tab) {
        var el = document.getElementById('tab-' + tab);
        if (el) el.addEventListener('click', function() { switchTab(tab); });
        var mob = document.getElementById('tab-' + tab + '-mobile');
        if (mob) mob.addEventListener('click', function() { switchTab(tab); toggleMobileMenu(); });
      });
      ['preference', 'betting', 'lifecycle', 'profitability'].forEach(function(sub) {
        var el = document.getElementById('subtab-' + sub);
        if (el) el.addEventListener('click', function() { switchSubTab(sub); });
      });
      document.getElementById('searchInput').addEventListener('input', filterTable);
      document.getElementById('churnFilter').addEventListener('change', filterTable);
      document.getElementById('prefFilter').addEventListener('change', filterTable);
      document.getElementById('valueFilter').addEventListener('change', filterTable);
      document.getElementById('clearFiltersBtn').addEventListener('click', clearFilters);
      document.getElementById('refreshBtn').addEventListener('click', loadPlayers);
      document.getElementById('exportBtn').addEventListener('click', function() { exportData('all'); });
      document.getElementById('csvFileInput').addEventListener('change', handleFileUpload);
      document.getElementById('exportAllBtn').addEventListener('click', function() { exportData('all'); });
      document.getElementById('exportCriticalBtn').addEventListener('click', function() { exportData('critical'); });
      document.getElementById('closePlayerModal').addEventListener('click', closePlayerModal);
      document.getElementById('playerModal').addEventListener('click', function(e) { if (e.target.id === 'playerModal') closePlayerModal(); });
      lucide.createIcons();
    }

    // ============================================
    // DATA LOADING
    // ============================================
    async function loadPlayers() {
      if (!App.db) return;
      showLoading(true, 'Loading players...');
      try {
        var result = await App.db.from('customers').select('*').order('id', { ascending: true });
        if (result.error) throw result.error;
        App.players = result.data.map(processPlayer);
        updateConnectionStatus('connected', 'Connected');
        updateAllStats();
        renderTable(App.players);
        showNotification('Loaded ' + App.players.length + ' players', 'success');
      } catch (error) {
        updateConnectionStatus('error', 'Error');
        showNotification('Load failed: ' + error.message, 'error');
      } finally {
        showLoading(false);
      }
    }

    function processPlayer(p) {
      var totalBetAmount = (parseFloat(p.sport_bet_amount) || 0) + (parseFloat(p.casino_bet_amount) || 0);
      var totalBetCount = (parseInt(p.sport_bet_count) || 0) + (parseInt(p.casino_bet_count) || 0);
      var totalWinCount = (parseInt(p.sport_win_count) || 0) + (parseInt(p.casino_win_count) || 0);
      var totalWinAmount = (parseFloat(p.sport_win_amount) || 0) + (parseFloat(p.casino_win_amount) || 0);
      var deposits = parseFloat(p.total_deposit_amount) || 0;
      var withdrawals = parseFloat(p.total_withdraw_amount) || 0;
      var netRevenue = deposits - withdrawals;
      var winRate = totalBetCount > 0 ? (totalWinCount / totalBetCount * 100) : 0;
      var avgBet = totalBetCount > 0 ? (totalBetAmount / totalBetCount) : 0;
      
      var phoneType = 'real';
      if (p.phone_type) phoneType = p.phone_type.toLowerCase();
      else if (p.phone_number && p.phone_number.toLowerCase().includes('virtual')) phoneType = 'virtual';
      
      var sportPct = totalBetAmount > 0 ? ((parseFloat(p.sport_bet_amount) || 0) / totalBetAmount * 100) : 0;
      var preference = sportPct > 70 ? 'sports' : (sportPct < 30 ? 'casino' : 'mixed');
      
      var valueSegment = netRevenue >= 5000 ? 'vip' : (netRevenue >= 1000 ? 'high' : (netRevenue >= 100 ? 'medium' : 'low'));
      var bettingStyle = avgBet >= 100 ? 'highroller' : (avgBet >= 10 ? 'regular' : 'casual');
      
      var maxBet = Math.max(parseFloat(p.sport_bet_max) || 0, parseFloat(p.casino_bet_max) || 0);
      var riskAppetite = (avgBet > 0 && maxBet / avgBet > 5) ? 'aggressive' : ((avgBet > 0 && maxBet / avgBet > 2) ? 'moderate' : 'conservative');
      
      var regDate = p.registration_date ? new Date(p.registration_date) : null;
      var daysSinceReg = regDate && !isNaN(regDate) ? Math.floor((new Date() - regDate) / 86400000) : 999;
      
      var lastActivity = p.last_activity_date || p.registration_date;
      var daysSinceActivity = lastActivity ? Math.floor((new Date() - new Date(lastActivity)) / 86400000) : 999;
      if (isNaN(daysSinceActivity)) daysSinceActivity = 999;
      
      var churnRisk = daysSinceActivity < 7 ? 'low' : (daysSinceActivity < 14 ? 'medium' : (daysSinceActivity < 30 ? 'high' : 'critical'));
      
      var lifecycle = 'churned';
      if (daysSinceReg < 30 && daysSinceActivity < 14) lifecycle = 'new';
      else if (daysSinceActivity < 7 && daysSinceReg < 90) lifecycle = 'growing';
      else if (daysSinceActivity < 7) lifecycle = 'mature';
      else if (daysSinceActivity < 30) lifecycle = 'declining';
      else if (daysSinceActivity < 90) lifecycle = 'dormant';
      
      return { ...p, totalBetAmount, totalBetCount, totalWinCount, totalWinAmount, netRevenue, winRate, avgBet, phoneType, preference, valueSegment, bettingStyle, riskAppetite, daysSinceReg, daysSinceActivity, churnRisk, lifecycle, isWithdrawing: withdrawals > deposits, isLoser: winRate < 40 && totalBetCount > 10 };
    }

    // ============================================
    // CSV IMPORT - FIXED FOR COMMA NUMBERS
    // ============================================
    function cleanNumeric(val) {
      if (val === null || val === undefined || val === '') return null;
      // Remove all commas from numbers like "76,476.85" -> "76476.85"
      var cleaned = String(val).replace(/,/g, '').trim();
      var num = parseFloat(cleaned);
      return isNaN(num) ? null : num;
    }

    function parseFormattedDate(dateStr) {
      if (!dateStr) return null;
      if (/^\d{4}-\d{2}-\d{2}/.test(dateStr)) return dateStr.split('T')[0];
      var months = { 'january': '01', 'february': '02', 'march': '03', 'april': '04', 'may': '05', 'june': '06', 'july': '07', 'august': '08', 'september': '09', 'october': '10', 'november': '11', 'december': '12' };
      try {
        var parts = dateStr.toLowerCase().replace(/,/g, '').split(/\s+/);
        var month = months[parts[0]];
        var day = parts[1].padStart(2, '0');
        var year = parts[2];
        if (month && day && year) return year + '-' + month + '-' + day;
      } catch (e) {}
      return null;
    }

    function parseCSVLine(line) {
      var vals = [], current = '', inQuotes = false;
      for (var i = 0; i < line.length; i++) {
        var char = line[i];
        if (char === '"') inQuotes = !inQuotes;
        else if (char === ',' && !inQuotes) { vals.push(current.trim()); current = ''; }
        else current += char;
      }
      vals.push(current.trim());
      return vals;
    }

    async function handleFileUpload(event) {
      var file = event.target.files[0];
      if (!file || !App.db) return;
      
      showLoading(true, 'Reading file...');
      document.getElementById('importProgress').classList.remove('hidden');
      
      try {
        var text = await file.text();
        var lines = text.split('\n').filter(function(l) { return l.trim(); });
        var headers = parseCSVLine(lines[0]).map(function(h) { return h.trim().replace(/"/g, '').toLowerCase(); });
        
        console.log('Headers found:', headers);
        
        var colMap = {};
        headers.forEach(function(h, idx) {
          var mapped = FIELD_MAP[h];
          if (mapped) colMap[mapped] = idx;
          if (h === 'virtual/real phone') colMap['phone_number'] = idx;
        });
        
        console.log('Column mapping:', colMap);
        
        var toUpsert = [];
        for (var i = 1; i < lines.length; i++) {
          var vals = parseCSVLine(lines[i]);
          var record = {};
          
          for (var dbCol in colMap) {
            var val = vals[colMap[dbCol]];
            if (val !== undefined && val !== '') {
              if (dbCol === 'phone_number') {
                if (val.toUpperCase().includes('VIRTUAL')) {
                  record.phone_type = 'virtual';
                  record.phone_number = val.replace(/virtual/gi, '').replace(/account/gi, '').trim() || null;
                } else {
                  record.phone_type = 'real';
                  record.phone_number = val;
                }
              } else if (NUMERIC_FIELDS.includes(dbCol)) {
                record[dbCol] = cleanNumeric(val);
              } else if (dbCol === 'registration_date') {
                record[dbCol] = parseFormattedDate(val);
              } else {
                record[dbCol] = val;
              }
            }
          }
          
          if (record.id) {
            record.updated_at = new Date().toISOString();
            toUpsert.push(record);
          }
          
          if (i % 500 === 0) {
            var pct = Math.round((i / lines.length) * 50);
            document.getElementById('importProgressText').textContent = 'Parsing... ' + pct + '%';
            document.getElementById('importProgressBar').style.width = pct + '%';
            await new Promise(function(r) { setTimeout(r, 0); });
          }
        }
        
        console.log('Records to upsert:', toUpsert.length);
        console.log('Sample record:', toUpsert[0]);
        
        if (toUpsert.length === 0) {
          showNotification('No valid records found', 'error');
          return;
        }
        
        var batchSize = 500;
        for (var b = 0; b < toUpsert.length; b += batchSize) {
          var batch = toUpsert.slice(b, b + batchSize);
          var result = await App.db.from('customers').upsert(batch, { onConflict: 'id' });
          if (result.error) throw result.error;
          var pct = 50 + Math.round(((b + batch.length) / toUpsert.length) * 50);
          document.getElementById('importProgressText').textContent = 'Saving... ' + pct + '%';
          document.getElementById('importProgressBar').style.width = pct + '%';
        }
        
        showNotification('Imported ' + toUpsert.length + ' players!', 'success');
        await loadPlayers();
      } catch (error) {
        console.error('Import error:', error);
        showNotification('Import failed: ' + error.message, 'error');
      } finally {
        showLoading(false);
        document.getElementById('importProgress').classList.add('hidden');
        event.target.value = '';
      }
    }

    // ============================================
    // STATISTICS
    // ============================================
    function updateAllStats() {
      var s = { total: App.players.length, netRevenue: 0, totalWagered: 0, deposits: 0, withdrawals: 0, sportBet: 0, sportWin: 0, casinoBet: 0, casinoWin: 0, prefSports: 0, prefCasino: 0, prefMixed: 0, segVip: 0, segHigh: 0, segMedium: 0, segLow: 0, churnLow: 0, churnMedium: 0, churnHigh: 0, churnCritical: 0, styleHighroller: 0, styleRegular: 0, styleCasual: 0, riskAggressive: 0, riskModerate: 0, riskConservative: 0, winHigh: 0, winAvg: 0, winLow: 0, lifeNew: 0, lifeGrowing: 0, lifeMature: 0, lifeDeclining: 0, lifeDormant: 0, lifeChurned: 0, withdrawing: 0, losers: 0, virtual: 0, inactiveStatus: 0 };
      
      App.players.forEach(function(p) {
        s.netRevenue += p.netRevenue; s.totalWagered += p.totalBetAmount;
        s.deposits += parseFloat(p.total_deposit_amount) || 0; s.withdrawals += parseFloat(p.total_withdraw_amount) || 0;
        s.sportBet += parseFloat(p.sport_bet_amount) || 0; s.sportWin += parseFloat(p.sport_win_amount) || 0;
        s.casinoBet += parseFloat(p.casino_bet_amount) || 0; s.casinoWin += parseFloat(p.casino_win_amount) || 0;
        if (p.preference === 'sports') s.prefSports++; else if (p.preference === 'casino') s.prefCasino++; else s.prefMixed++;
        if (p.valueSegment === 'vip') s.segVip++; else if (p.valueSegment === 'high') s.segHigh++; else if (p.valueSegment === 'medium') s.segMedium++; else s.segLow++;
        if (p.churnRisk === 'low') s.churnLow++; else if (p.churnRisk === 'medium') s.churnMedium++; else if (p.churnRisk === 'high') s.churnHigh++; else s.churnCritical++;
        if (p.bettingStyle === 'highroller') s.styleHighroller++; else if (p.bettingStyle === 'regular') s.styleRegular++; else s.styleCasual++;
        if (p.riskAppetite === 'aggressive') s.riskAggressive++; else if (p.riskAppetite === 'moderate') s.riskModerate++; else s.riskConservative++;
        if (p.winRate > 50) s.winHigh++; else if (p.winRate >= 40) s.winAvg++; else s.winLow++;
        if (p.lifecycle === 'new') s.lifeNew++; else if (p.lifecycle === 'growing') s.lifeGrowing++; else if (p.lifecycle === 'mature') s.lifeMature++; else if (p.lifecycle === 'declining') s.lifeDeclining++; else if (p.lifecycle === 'dormant') s.lifeDormant++; else s.lifeChurned++;
        if (p.isWithdrawing) s.withdrawing++; if (p.isLoser) s.losers++; if (p.phoneType === 'virtual') s.virtual++;
        if (p.status && p.status.toLowerCase() !== 'active') s.inactiveStatus++;
      });
      
      setText('metric-total-players', s.total); setText('metric-net-revenue', formatCurrency(s.netRevenue)); setText('metric-total-wagered', formatCurrency(s.totalWagered)); setText('metric-at-risk', s.churnHigh + s.churnCritical);
      setText('pref-sports-count', s.prefSports); setText('pref-casino-count', s.prefCasino); setText('pref-mixed-count', s.prefMixed);
      setWidth('pref-sports-bar', s.total > 0 ? (s.prefSports / s.total * 100) : 0); setWidth('pref-casino-bar', s.total > 0 ? (s.prefCasino / s.total * 100) : 0); setWidth('pref-mixed-bar', s.total > 0 ? (s.prefMixed / s.total * 100) : 0);
      setText('seg-vip', s.segVip); setText('seg-high', s.segHigh); setText('seg-medium', s.segMedium); setText('seg-low', s.segLow);
      setText('churn-low', s.churnLow); setText('churn-medium', s.churnMedium); setText('churn-high', s.churnHigh); setText('churn-critical', s.churnCritical);
      setText('churn-detail-low', s.churnLow); setText('churn-detail-medium', s.churnMedium); setText('churn-detail-high', s.churnHigh); setText('churn-detail-critical', s.churnCritical);
      setText('churn-withdrawing', s.withdrawing); setText('churn-losing', s.losers); setText('churn-inactive-status', s.inactiveStatus);
      setText('alert-withdrawing', s.withdrawing); setText('alert-losers', s.losers); setText('alert-virtual', s.virtual);
      setText('beh-sports', s.prefSports); setText('beh-casino', s.prefCasino); setText('beh-mixed', s.prefMixed);
      var maxRev = Math.max(s.sportBet - s.sportWin, s.casinoBet - s.casinoWin, 1);
      setText('rev-sports', formatCurrency(s.sportBet - s.sportWin)); setText('rev-casino', formatCurrency(s.casinoBet - s.casinoWin));
      setWidth('rev-sports-bar', ((s.sportBet - s.sportWin) / maxRev * 100)); setWidth('rev-casino-bar', ((s.casinoBet - s.casinoWin) / maxRev * 100));
      setText('style-highroller', s.styleHighroller); setText('style-regular', s.styleRegular); setText('style-casual', s.styleCasual);
      setText('risk-aggressive', s.riskAggressive); setText('risk-moderate', s.riskModerate); setText('risk-conservative', s.riskConservative);
      setText('winrate-high', s.winHigh); setText('winrate-avg', s.winAvg); setText('winrate-low', s.winLow);
      setText('life-new', s.lifeNew); setText('life-growing', s.lifeGrowing); setText('life-mature', s.lifeMature); setText('life-declining', s.lifeDeclining); setText('life-dormant', s.lifeDormant); setText('life-churned', s.lifeChurned);
      setText('profit-deposits', formatCurrency(s.deposits)); setText('profit-withdrawals', formatCurrency(s.withdrawals)); setText('profit-net', formatCurrency(s.netRevenue)); setText('profit-avg', s.total > 0 ? formatCurrency(s.netRevenue / s.total) : '$0');
      setText('sport-total-bet', formatCurrency(s.sportBet)); setText('sport-total-won', formatCurrency(s.sportWin)); setText('sport-edge', s.sportBet > 0 ? ((s.sportBet - s.sportWin) / s.sportBet * 100).toFixed(1) + '%' : '0%');
      setText('casino-total-bet', formatCurrency(s.casinoBet)); setText('casino-total-won', formatCurrency(s.casinoWin)); setText('casino-edge', s.casinoBet > 0 ? ((s.casinoBet - s.casinoWin) / s.casinoBet * 100).toFixed(1) + '%' : '0%');
      setText('export-all-count', s.total + ' players'); setText('export-critical-count', s.churnCritical + ' players');
      lucide.createIcons();
    }

    // ============================================
    // TABLE
    // ============================================
    function renderTable(data) {
      var tbody = document.getElementById('tableBody');
      if (data.length === 0) {
        tbody.innerHTML = '<tr><td colspan="8" class="px-4 py-12 text-center text-slate-500"><i data-lucide="users" class="h-10 w-10 mx-auto mb-3 text-slate-300"></i><p>No players found</p></td></tr>';
        document.getElementById('tableFooter').textContent = 'No players';
        lucide.createIcons(); return;
      }
      var html = '';
      var displayed = data.slice(0, 100); // Show first 100 for performance
      displayed.forEach(function(p) {
        var churnColors = { low: 'emerald', medium: 'amber', high: 'orange', critical: 'red' };
        var prefColors = { sports: 'green', casino: 'purple', mixed: 'blue' };
        var valueColors = { vip: 'purple', high: 'blue', medium: 'teal', low: 'slate' };
        html += '<tr class="hover:bg-slate-50"><td class="px-3 py-3"><p class="font-medium text-slate-900 text-sm">' + (p.id || '-') + '</p><p class="text-xs text-slate-500">' + (p.phone_number || '-') + '</p></td><td class="px-3 py-3"><span class="text-xs px-2 py-1 rounded-full ' + (p.phoneType === 'virtual' ? 'bg-red-100 text-red-700' : 'bg-slate-100 text-slate-600') + '">' + p.phoneType + '</span></td><td class="px-3 py-3"><span class="text-xs px-2 py-1 rounded-full bg-' + prefColors[p.preference] + '-100 text-' + prefColors[p.preference] + '-700">' + p.preference + '</span></td><td class="px-3 py-3"><span class="font-medium ' + (p.netRevenue >= 0 ? 'text-emerald-600' : 'text-red-600') + '">' + formatCurrency(p.netRevenue) + '</span></td><td class="px-3 py-3"><span class="text-sm">' + p.winRate.toFixed(1) + '%</span></td><td class="px-3 py-3"><span class="text-xs px-2 py-1 rounded-full bg-' + valueColors[p.valueSegment] + '-100 text-' + valueColors[p.valueSegment] + '-700">' + p.valueSegment.toUpperCase() + '</span></td><td class="px-3 py-3"><span class="text-xs px-2 py-1 rounded-full bg-' + churnColors[p.churnRisk] + '-100 text-' + churnColors[p.churnRisk] + '-700">' + p.churnRisk + '</span></td><td class="px-3 py-3"><button onclick="viewPlayer(\'' + p.id + '\')" class="p-1.5 text-slate-400 hover:text-slate-600 hover:bg-slate-100 rounded"><i data-lucide="eye" class="h-4 w-4"></i></button></td></tr>';
      });
      tbody.innerHTML = html;
      document.getElementById('tableFooter').textContent = 'Showing ' + displayed.length + ' of ' + data.length + ' players';
      lucide.createIcons();
    }

    function filterTable() {
      var search = document.getElementById('searchInput').value.toLowerCase();
      var churn = document.getElementById('churnFilter').value;
      var pref = document.getElementById('prefFilter').value;
      var value = document.getElementById('valueFilter').value;
      var filtered = App.players.filter(function(p) {
        var matchSearch = !search || (p.id && String(p.id).toLowerCase().includes(search)) || (p.phone_number && p.phone_number.toLowerCase().includes(search));
        var matchChurn = churn === 'all' || p.churnRisk === churn;
        var matchPref = pref === 'all' || p.preference === pref;
        var matchValue = value === 'all' || p.valueSegment === value;
        return matchSearch && matchChurn && matchPref && matchValue;
      });
      renderTable(filtered);
    }

    function clearFilters() {
      document.getElementById('searchInput').value = '';
      document.getElementById('churnFilter').value = 'all';
      document.getElementById('prefFilter').value = 'all';
      document.getElementById('valueFilter').value = 'all';
      renderTable(App.players);
    }

    // Global filter functions
    window.filterByChurn = function(val) { switchTab('players'); document.getElementById('churnFilter').value = val; filterTable(); };
    window.filterByPref = function(val) { switchTab('players'); document.getElementById('prefFilter').value = val; filterTable(); };
    window.filterByValue = function(val) { switchTab('players'); document.getElementById('valueFilter').value = val; filterTable(); };

    // ============================================
    // PLAYER MODAL
    // ============================================
    window.viewPlayer = function(id) {
      var p = App.players.find(function(x) { return String(x.id) === String(id); });
      if (!p) return;
      var html = '<div class="space-y-4"><div class="grid grid-cols-2 gap-4"><div><p class="text-xs text-slate-500">Player ID</p><p class="font-medium">' + p.id + '</p></div><div><p class="text-xs text-slate-500">Phone</p><p class="font-medium">' + (p.phone_number || '-') + ' <span class="text-xs px-1.5 py-0.5 rounded ' + (p.phoneType === 'virtual' ? 'bg-red-100 text-red-600' : 'bg-slate-100') + '">' + p.phoneType + '</span></p></div><div><p class="text-xs text-slate-500">Status</p><p class="font-medium">' + (p.status || '-') + '</p></div><div><p class="text-xs text-slate-500">Referral</p><p class="font-medium">' + (p.referral || '-') + '</p></div><div><p class="text-xs text-slate-500">Registered</p><p class="font-medium">' + (p.registration_date || '-') + '</p></div><div><p class="text-xs text-slate-500">Days Since Reg</p><p class="font-medium">' + p.daysSinceReg + '</p></div></div><hr><h4 class="font-bold text-slate-800">Financial</h4><div class="grid grid-cols-3 gap-4"><div><p class="text-xs text-slate-500">Deposits</p><p class="font-medium text-emerald-600">' + formatCurrency(p.total_deposit_amount) + '</p></div><div><p class="text-xs text-slate-500">Withdrawals</p><p class="font-medium text-red-600">' + formatCurrency(p.total_withdraw_amount) + '</p></div><div><p class="text-xs text-slate-500">Net Revenue</p><p class="font-bold ' + (p.netRevenue >= 0 ? 'text-emerald-600' : 'text-red-600') + '">' + formatCurrency(p.netRevenue) + '</p></div></div><hr><h4 class="font-bold text-slate-800">Sports Betting</h4><div class="grid grid-cols-4 gap-3 text-sm"><div><p class="text-xs text-slate-500">Bet Amount</p><p>' + formatCurrency(p.sport_bet_amount) + '</p></div><div><p class="text-xs text-slate-500">Bet Count</p><p>' + (p.sport_bet_count || 0) + '</p></div><div><p class="text-xs text-slate-500">Win Amount</p><p>' + formatCurrency(p.sport_win_amount) + '</p></div><div><p class="text-xs text-slate-500">Win Count</p><p>' + (p.sport_win_count || 0) + '</p></div></div><hr><h4 class="font-bold text-slate-800">Casino</h4><div class="grid grid-cols-4 gap-3 text-sm"><div><p class="text-xs text-slate-500">Bet Amount</p><p>' + formatCurrency(p.casino_bet_amount) + '</p></div><div><p class="text-xs text-slate-500">Bet Count</p><p>' + (p.casino_bet_count || 0) + '</p></div><div><p class="text-xs text-slate-500">Win Amount</p><p>' + formatCurrency(p.casino_win_amount) + '</p></div><div><p class="text-xs text-slate-500">Win Count</p><p>' + (p.casino_win_count || 0) + '</p></div></div><hr><h4 class="font-bold text-slate-800">Analysis</h4><div class="grid grid-cols-3 gap-3"><div class="p-3 bg-slate-50 rounded-lg"><p class="text-xs text-slate-500">Preference</p><p class="font-medium capitalize">' + p.preference + '</p></div><div class="p-3 bg-slate-50 rounded-lg"><p class="text-xs text-slate-500">Value</p><p class="font-medium uppercase">' + p.valueSegment + '</p></div><div class="p-3 bg-slate-50 rounded-lg"><p class="text-xs text-slate-500">Churn Risk</p><p class="font-medium capitalize">' + p.churnRisk + '</p></div><div class="p-3 bg-slate-50 rounded-lg"><p class="text-xs text-slate-500">Win Rate</p><p class="font-medium">' + p.winRate.toFixed(1) + '%</p></div><div class="p-3 bg-slate-50 rounded-lg"><p class="text-xs text-slate-500">Avg Bet</p><p class="font-medium">' + formatCurrency(p.avgBet) + '</p></div><div class="p-3 bg-slate-50 rounded-lg"><p class="text-xs text-slate-500">Lifecycle</p><p class="font-medium capitalize">' + p.lifecycle + '</p></div></div></div>';
      document.getElementById('playerModalContent').innerHTML = html;
      document.getElementById('playerModal').classList.remove('hidden');
      document.body.style.overflow = 'hidden';
    };
    function closePlayerModal() { document.getElementById('playerModal').classList.add('hidden'); document.body.style.overflow = ''; }

    // ============================================
    // EXPORT
    // ============================================
    function exportData(type) {
      var data = type === 'critical' ? App.players.filter(function(p) { return p.churnRisk === 'critical'; }) : App.players;
      if (data.length === 0) { showNotification('No data to export', 'info'); return; }
      var headers = ['id', 'phone_number', 'phone_type', 'status', 'referral', 'registration_date', 'total_deposit_amount', 'total_withdraw_amount', 'net_revenue', 'sport_bet_amount', 'casino_bet_amount', 'win_rate', 'preference', 'value_segment', 'churn_risk'];
      var rows = [headers.join(',')];
      data.forEach(function(p) { rows.push([p.id, p.phone_number, p.phoneType, p.status, p.referral, p.registration_date, p.total_deposit_amount, p.total_withdraw_amount, p.netRevenue.toFixed(2), p.sport_bet_amount, p.casino_bet_amount, p.winRate.toFixed(2), p.preference, p.valueSegment, p.churnRisk].join(',')); });
      var blob = new Blob([rows.join('\n')], { type: 'text/csv' });
      var a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'bwanabet_' + type + '_' + new Date().toISOString().split('T')[0] + '.csv'; a.click();
      showNotification('Exported ' + data.length + ' players', 'success');
    }

    // ============================================
    // UI HELPERS
    // ============================================
    function toggleMobileMenu() { App.mobileMenuOpen = !App.mobileMenuOpen; document.getElementById('mobileMenu').style.maxHeight = App.mobileMenuOpen ? '400px' : '0'; }
    function switchTab(tab) { document.querySelectorAll('.tab-content').forEach(function(el) { el.classList.add('hidden'); }); document.querySelectorAll('.tab-btn').forEach(function(el) { el.classList.remove('active'); }); document.getElementById('content-' + tab).classList.remove('hidden'); var dt = document.getElementById('tab-' + tab); var mt = document.getElementById('tab-' + tab + '-mobile'); if (dt) dt.classList.add('active'); if (mt) mt.classList.add('active'); lucide.createIcons(); }
    function switchSubTab(sub) { document.querySelectorAll('.sub-content').forEach(function(el) { el.classList.add('hidden'); }); document.querySelectorAll('.sub-tab-btn').forEach(function(el) { el.classList.remove('active'); }); document.getElementById('subcontent-' + sub).classList.remove('hidden'); document.getElementById('subtab-' + sub).classList.add('active'); lucide.createIcons(); }
    function updateConnectionStatus(status, text) { var dot = document.getElementById('statusDot'); dot.className = 'w-2 h-2 rounded-full'; if (status === 'connected') dot.classList.add('bg-emerald-400'); else if (status === 'connecting') dot.classList.add('bg-amber-400'); else dot.classList.add('bg-red-400'); document.getElementById('statusText').textContent = text; }
    function showLoading(show, text) { document.getElementById('loadingOverlay').classList.toggle('hidden', !show); if (text) document.getElementById('loadingText').textContent = text; }
    function showNotification(msg, type) { var el = document.getElementById('notification'); var bg = type === 'success' ? 'bg-emerald-500' : type === 'error' ? 'bg-red-500' : 'bg-slate-700'; var icon = type === 'success' ? 'check-circle' : type === 'error' ? 'x-circle' : 'info'; el.className = 'fixed top-4 right-4 left-4 sm:left-auto z-50 px-4 py-3 rounded-lg shadow-xl flex items-center gap-3 notification text-sm text-white ' + bg; el.innerHTML = '<i data-lucide="' + icon + '" class="h-5 w-5"></i><span>' + msg + '</span>'; el.classList.remove('hidden'); lucide.createIcons(); setTimeout(function() { el.classList.add('hidden'); }, 4000); }
    function setText(id, val) { var el = document.getElementById(id); if (el) el.textContent = val; }
    function setWidth(id, pct) { var el = document.getElementById(id); if (el) el.style.width = Math.min(100, Math.max(0, pct)) + '%'; }
    function formatCurrency(val) { var num = parseFloat(val) || 0; return '$' + num.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 }); }
  </script>
</body>
</html>
